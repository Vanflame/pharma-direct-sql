<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Payment ‚Äî PHARMA DIRECT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../css/styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
</head>

<body class="min-h-screen bg-gray-50">
    <header class="bg-white border-b">
        <div class="mx-auto container-max px-4 py-3 flex items-center justify-between">
            <a href="../" class="font-semibold text-emerald-600">PHARMA DIRECT</a>
            <div class="text-sm text-gray-600">Secure Payment</div>
        </div>
    </header>

    <main class="mx-auto container-max px-4 py-8 pb-24">
        <!-- Back Button -->
        <div class="mb-6">
            <a href="../track/"
                class="inline-flex items-center gap-2 text-emerald-600 hover:text-emerald-700 font-medium">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                Back to Track Orders
            </a>
        </div>

        <div class="max-w-4xl mx-auto">
            <!-- Payment Header -->
            <div class="bg-gradient-to-r from-emerald-600 to-emerald-700 rounded-2xl p-6 mb-6 text-white">
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z">
                            </path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">Complete Your Payment</h1>
                        <p class="text-emerald-100">Order ID: <span id="order-id"
                                class="font-mono text-emerald-200">Loading...</span></p>
                    </div>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="bg-white rounded-2xl border border-gray-200 shadow-lg overflow-hidden mb-6">
                <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2">
                            </path>
                        </svg>
                        Order Summary
                    </h2>
                </div>
                <div class="p-6">
                    <div id="order-items" class="space-y-3 mb-4"></div>
                    <div class="border-t pt-4 space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Subtotal</span>
                            <span id="subtotal" class="font-medium">‚Ç±0.00</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Delivery Fee</span>
                            <span id="delivery-fee" class="font-medium">‚Ç±0.00</span>
                        </div>
                        <div class="flex justify-between text-lg font-semibold border-t pt-2">
                            <span>Total</span>
                            <span id="grand-total" class="text-emerald-600">‚Ç±0.00</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Method -->
            <div class="bg-white rounded-2xl border border-gray-200 shadow-lg overflow-hidden mb-6">
                <div class="bg-gradient-to-r from-blue-50 to-blue-100 px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-bold text-blue-800 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z">
                            </path>
                        </svg>
                        Payment Method
                    </h2>
                </div>
                <div class="p-6">
                    <div id="payment-method"
                        class="flex items-center gap-4 p-4 bg-blue-50 rounded-xl border border-blue-200"></div>
                </div>
            </div>

            <!-- QR Code Section -->
            <div class="bg-white rounded-2xl border border-gray-200 shadow-lg overflow-hidden mb-6">
                <div class="bg-gradient-to-r from-green-50 to-green-100 px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-bold text-green-800 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z">
                            </path>
                        </svg>
                        Payment QR Code
                    </h2>
                </div>
                <div class="p-6 text-center">
                    <div id="qr-code" class="inline-block p-4 bg-white border-2 border-gray-200 rounded-xl mb-4">
                        <div
                            class="w-48 h-48 bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center">
                            <div class="text-center">
                                <p class="text-gray-600 text-sm">Loading QR Code...</p>
                            </div>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mb-4">Scan this QR code with your mobile payment app</p>
                    <div class="text-xs text-gray-500 bg-gray-50 p-3 rounded-lg mb-4">
                        <p class="font-mono break-all" id="payment-url">Loading payment URL...</p>
                    </div>

                    <!-- Manual Refresh Button -->
                    <button id="refresh-payment-status"
                        class="bg-blue-600 text-white py-2 px-4 rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors flex items-center gap-2 mx-auto">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                            </path>
                        </svg>
                        Check Payment Status
                    </button>
                </div>
            </div>

            <!-- Payment Actions -->
            <div class="bg-white rounded-2xl border border-gray-200 shadow-lg overflow-hidden">
                <div class="bg-gradient-to-r from-emerald-600 to-emerald-700 px-6 py-4">
                    <h2 class="text-lg font-bold text-white flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Payment Actions
                    </h2>
                </div>
                <div class="p-6">
                    <div class="space-y-4">
                        <button id="pay-now-btn"
                            class="w-full bg-gradient-to-r from-emerald-600 to-emerald-700 text-white py-4 px-6 rounded-xl font-bold text-lg hover:from-emerald-700 hover:to-emerald-800 transition-all duration-300 disabled:from-gray-400 disabled:to-gray-500 disabled:cursor-not-allowed shadow-lg hover:shadow-xl flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span id="pay-btn-text">Pay Now</span>
                        </button>
                        <button id="cancel-payment"
                            class="w-full bg-gray-200 text-gray-700 py-3 px-6 rounded-xl font-semibold hover:bg-gray-300 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            Cancel Payment
                        </button>
                    </div>
                    <div id="payment-feedback" class="mt-4 text-sm hidden"></div>

                    <!-- Payment Status Indicator -->
                    <div id="payment-status-indicator" class="mt-4 hidden">
                        <!-- Status indicator will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="../js/imageCache.js"></script>
    <script src="../js/loading.js"></script>
    <script type="module">
        import { formatCurrency, showError, showSuccess, getProfessionalErrorMessage, setButtonLoading, showLoadingModal, hideLoadingModal } from '../js/supabase-config.js';
        import { supabase } from '../js/supabase-auth.js';
        import { TABLES } from '../js/supabase-config.js';
        import { updateOrderStage, updatePharmacyWallet } from '../js/supabase-database.js';

        // Custom Modal System
        function createModal(type, title, message, icon = null, actions = []) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.id = 'custom-modal';

            // Icon mapping for different modal types
            const iconMap = {
                success: `<svg class="w-12 h-12 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>`,
                error: `<svg class="w-12 h-12 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>`,
                warning: `<svg class="w-12 h-12 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>`,
                info: `<svg class="w-12 h-12 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>`
            };

            const selectedIcon = icon || iconMap[type] || iconMap.info;

            // Color mapping for different modal types
            const colorMap = {
                success: 'from-green-600 to-green-700',
                error: 'from-red-600 to-red-700',
                warning: 'from-yellow-600 to-yellow-700',
                info: 'from-blue-600 to-blue-700'
            };

            const bgColor = colorMap[type] || colorMap.info;

            modal.innerHTML = `
                <div class="bg-white rounded-2xl max-w-md w-full shadow-2xl">
                    <!-- Modal Header -->
                    <div class="bg-gradient-to-r ${bgColor} px-6 py-4 rounded-t-2xl">
                        <div class="flex items-center justify-between">
                            <h3 class="text-xl font-bold text-white flex items-center gap-2">
                                ${selectedIcon}
                                ${title}
                            </h3>
                            <button onclick="closeCustomModal()" class="text-white hover:text-opacity-80 transition-colors">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Modal Content -->
                    <div class="p-6">
                        <div class="text-center">
                            <p class="text-gray-700 mb-6">${message}</p>
                            <div class="flex gap-3 justify-center">
                                ${actions.map(action => `
                                    <button onclick="${action.onclick}" class="${action.class}">
                                        ${action.text}
                                    </button>
                                `).join('')}
                                ${actions.length === 0 ? `
                                    <button onclick="closeCustomModal()" class="bg-emerald-600 text-white py-2 px-6 rounded-lg font-medium hover:bg-emerald-700 transition-colors">
                                        OK
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target.id === 'custom-modal') {
                    closeCustomModal();
                }
            });

            return modal;
        }

        // Global function to close custom modal
        window.closeCustomModal = () => {
            const modal = document.getElementById('custom-modal');
            if (modal) {
                modal.remove();
            }
        };

        // Override showError and showSuccess to use custom modals
        const originalShowError = showError;
        const originalShowSuccess = showSuccess;

        window.showError = (message, title = 'Error') => {
            createModal('error', title, message);
        };

        window.showSuccess = (message, title = 'Success') => {
            createModal('success', title, message);
        };

        let currentOrder = null;
        let currentOrderId = null;
        let orderSubscription = null;
        let paymentCheckInterval = null;
        let isCheckingPayment = false;

        function getOrderIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('orderId');
        }

        // Check payment status manually
        async function checkPaymentStatus() {
            if (isCheckingPayment || !currentOrderId) return;

            isCheckingPayment = true;
            console.log('Checking payment status for order:', currentOrderId);

            try {
                const { data: order, error } = await supabase
                    .from(TABLES.orders)
                    .select('payment_status, stage')
                    .eq('id', currentOrderId)
                    .single();

                if (error) {
                    console.error('Error checking payment status:', error);
                    return;
                }

                // Check if payment status changed to confirmed
                if (order.payment_status === 'Confirmed' && currentOrder?.payment_status !== 'Confirmed') {
                    console.log('Payment confirmed via polling! Redirecting...');

                    // Stop all monitoring
                    stopPaymentMonitoring();

                    // Check if user is authenticated to determine redirect
                    const { data: { user } } = await supabase.auth.getUser();

                    if (user) {
                        // Authenticated user - redirect to track orders
                        createModal('success', 'Payment Confirmed!',
                            'Your payment has been processed successfully. You will be redirected to track your order.',
                            null,
                            [{
                                text: 'Track Order',
                                class: 'bg-emerald-600 text-white py-2 px-6 rounded-lg font-medium hover:bg-emerald-700 transition-colors',
                                onclick: 'window.location.href = "../track/"'
                            }]
                        );
                        setTimeout(() => { window.location.href = '../track/'; }, 3000);
                    } else {
                        // Anonymous user (QR code scanner) - show completion message
                        createModal('success', 'Payment Confirmed!',
                            'Your payment has been processed successfully! You can now close this page or scan the QR code again to check your order status.',
                            null,
                            [
                                {
                                    text: 'Check Order Status',
                                    class: 'bg-blue-600 text-white py-2 px-6 rounded-lg font-medium hover:bg-blue-700 transition-colors',
                                    onclick: 'window.location.reload()'
                                },
                                {
                                    text: 'Close Page',
                                    class: 'bg-gray-600 text-white py-2 px-6 rounded-lg font-medium hover:bg-gray-700 transition-colors',
                                    onclick: 'window.close()'
                                }
                            ]
                        );
                    }
                }

                // Update current order data
                if (currentOrder) {
                    currentOrder.payment_status = order.payment_status;
                    currentOrder.stage = order.stage;
                }

            } catch (error) {
                console.error('Error in payment status check:', error);
            } finally {
                isCheckingPayment = false;
            }
        }

        // Start payment monitoring (both real-time and polling)
        function startPaymentMonitoring(orderId) {
            console.log('Starting payment monitoring for order:', orderId);

            // Setup real-time subscription
            setupOrderSubscription(orderId);

            // Start polling every 3 seconds
            paymentCheckInterval = setInterval(checkPaymentStatus, 3000);

            // Add visual indicator
            updatePaymentStatusIndicator('Monitoring payment...');
        }

        // Stop payment monitoring
        function stopPaymentMonitoring() {
            console.log('Stopping payment monitoring');

            if (orderSubscription) {
                orderSubscription.unsubscribe();
                orderSubscription = null;
            }

            if (paymentCheckInterval) {
                clearInterval(paymentCheckInterval);
                paymentCheckInterval = null;
            }

            updatePaymentStatusIndicator('');
        }

        // Update payment status indicator
        function updatePaymentStatusIndicator(message) {
            const indicator = document.getElementById('payment-status-indicator');
            if (indicator) {
                if (message) {
                    indicator.innerHTML = `
                        <div class="flex items-center gap-2 text-sm text-blue-600 bg-blue-50 px-3 py-2 rounded-lg">
                            <div class="animate-spin w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full"></div>
                            ${message}
                        </div>
                    `;
                    indicator.classList.remove('hidden');
                } else {
                    indicator.classList.add('hidden');
                }
            }
        }

        // Real-time order monitoring
        function setupOrderSubscription(orderId) {
            // Clean up existing subscription
            if (orderSubscription) {
                orderSubscription.unsubscribe();
            }

            console.log('Setting up real-time subscription for order:', orderId);

            orderSubscription = supabase
                .channel('order_changes')
                .on('postgres_changes',
                    {
                        event: '*',
                        schema: 'public',
                        table: 'orders',
                        filter: `id=eq.${orderId}`
                    },
                    (payload) => {
                        console.log('Order change detected via real-time:', payload);

                        if (payload.eventType === 'UPDATE') {
                            const updatedOrder = payload.new;

                            // Check if payment status changed to confirmed
                            if (updatedOrder.payment_status === 'Confirmed' && currentOrder?.payment_status !== 'Confirmed') {
                                console.log('Payment confirmed via real-time! Redirecting...');

                                // Stop all monitoring
                                stopPaymentMonitoring();

                                // Check if user is authenticated to determine redirect
                                supabase.auth.getUser().then(({ data: { user } }) => {
                                    if (user) {
                                        // Authenticated user - redirect to track orders
                                        createModal('success', 'Payment Confirmed!',
                                            'Your payment has been processed successfully. You will be redirected to track your order.',
                                            null,
                                            [{
                                                text: 'Track Order',
                                                class: 'bg-emerald-600 text-white py-2 px-6 rounded-lg font-medium hover:bg-emerald-700 transition-colors',
                                                onclick: 'window.location.href = "../track/"'
                                            }]
                                        );
                                        setTimeout(() => { window.location.href = '../track/'; }, 3000);
                                    } else {
                                        // Anonymous user (QR code scanner) - show completion message
                                        createModal('success', 'Payment Confirmed!',
                                            'Your payment has been processed successfully! You can now close this page or scan the QR code again to check your order status.',
                                            null,
                                            [
                                                {
                                                    text: 'Check Order Status',
                                                    class: 'bg-blue-600 text-white py-2 px-6 rounded-lg font-medium hover:bg-blue-700 transition-colors',
                                                    onclick: 'window.location.reload()'
                                                },
                                                {
                                                    text: 'Close Page',
                                                    class: 'bg-gray-600 text-white py-2 px-6 rounded-lg font-medium hover:bg-gray-700 transition-colors',
                                                    onclick: 'window.close()'
                                                }
                                            ]
                                        );
                                    }
                                });
                            }

                            // Update current order data
                            currentOrder = updatedOrder;
                        }
                    }
                )
                .subscribe();
        }

        async function loadOrderData(orderId) {
            try {
                const { data: order, error } = await supabase
                    .from(TABLES.orders)
                    .select('*')
                    .eq('id', orderId)
                    .single();

                if (error || !order) {
                    showError('Order not found');
                    return;
                }

                currentOrder = order;
                currentOrderId = orderId;

                // Fetch order items from the order_items table
                console.log('Fetching order items for orderId:', orderId);
                const { data: orderItems, error: itemsError } = await supabase
                    .from(TABLES.order_items)
                    .select('*')
                    .eq('order_id', orderId);

                console.log('Order items query result:', { orderItems, itemsError });

                if (itemsError) {
                    console.error('Error fetching order items:', itemsError);
                    showError('Failed to load order items');
                    return;
                }

                // Fetch product details (including images) for each order item
                if (orderItems && orderItems.length > 0) {
                    const enrichedItems = await Promise.all(orderItems.map(async (item) => {
                        try {
                            const { data: product, error: productError } = await supabase
                                .from(TABLES.products)
                                .select('image_url, name')
                                .eq('id', item.product_id)
                                .single();

                            if (!productError && product) {
                                return {
                                    ...item,
                                    image_url: product.image_url,
                                    display_name: product.name || item.product_name
                                };
                            } else {
                                console.warn('Could not fetch product details for:', item.product_id);
                                return {
                                    ...item,
                                    image_url: null,
                                    display_name: item.product_name
                                };
                            }
                        } catch (error) {
                            console.warn('Error fetching product for item:', item.product_id, error);
                            return {
                                ...item,
                                image_url: null,
                                display_name: item.product_name
                            };
                        }
                    }));

                    currentOrder.items = enrichedItems;
                } else {
                    currentOrder.items = [];
                }

                console.log('Added items to currentOrder:', currentOrder.items);

                if (currentOrder.payment_status === 'Confirmed') {
                    // Check if user is authenticated to determine redirect
                    const { data: { user } } = await supabase.auth.getUser();

                    if (user) {
                        // Authenticated user - redirect to track orders
                        createModal('info', 'Payment Already Completed',
                            'This payment has already been processed successfully.',
                            null,
                            [{
                                text: 'Track Order',
                                class: 'bg-emerald-600 text-white py-2 px-6 rounded-lg font-medium hover:bg-emerald-700 transition-colors',
                                onclick: 'window.location.href = "../track/"'
                            }]
                        );

                        // Auto-redirect after 3 seconds
                        setTimeout(() => {
                            window.location.href = '../track/';
                        }, 3000);
                    } else {
                        // Anonymous user (QR code scanner) - show completion message
                        createModal('info', 'Payment Already Completed',
                            'This payment has already been processed successfully! You can scan the QR code again anytime to check your order status.',
                            null,
                            [
                                {
                                    text: 'Check Order Status',
                                    class: 'bg-blue-600 text-white py-2 px-6 rounded-lg font-medium hover:bg-blue-700 transition-colors',
                                    onclick: 'window.location.reload()'
                                },
                                {
                                    text: 'Close Page',
                                    class: 'bg-gray-600 text-white py-2 px-6 rounded-lg font-medium hover:bg-gray-700 transition-colors',
                                    onclick: 'window.close()'
                                }
                            ]
                        );
                    }
                    return;
                }

                displayOrderData();
                generateQRCode();
                if (typeof QRCode === 'undefined') {
                    setTimeout(() => { generateQRCode(); }, 1000);
                }

                // Start comprehensive payment monitoring
                startPaymentMonitoring(orderId);

            } catch (error) {
                console.error('Error loading order:', error);
                showError('Failed to load order data');
            }
        }

        function displayOrderData() {
            document.getElementById('order-id').textContent = currentOrderId.slice(-8);

            console.log('Displaying order data:', currentOrder);
            console.log('Order items:', currentOrder.items);
            console.log('Items length:', currentOrder.items?.length);

            const itemsContainer = document.getElementById('order-items');

            if (!currentOrder.items || currentOrder.items.length === 0) {
                console.log('No items found, showing empty message');
                itemsContainer.innerHTML = '<div class="text-center text-gray-500 py-4">No items found in this order</div>';
                return;
            }

            itemsContainer.innerHTML = currentOrder.items.map(item => `
                <div class="flex items-center justify-between py-3 border-b border-gray-200 last:border-0">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center flex-shrink-0 overflow-hidden">
                            ${item.image_url ?
                    `<img src="${item.image_url}" alt="${item.display_name || item.product_name}" class="w-full h-full object-cover rounded-lg">` :
                    `<div class="w-full h-full bg-purple-100 rounded-lg flex items-center justify-center">
                                    <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                    </svg>
                                </div>`
                }
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-900 text-sm mb-1">${item.display_name || item.product_name}</h4>
                            <p class="text-xs text-gray-600">Qty: ${item.quantity}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-gray-900">‚Ç±${(item.price * item.quantity).toFixed(2)}</p>
                        <p class="text-xs text-gray-600">‚Ç±${item.price} each</p>
                    </div>
                </div>
            `).join('');

            document.getElementById('subtotal').textContent = formatCurrency(currentOrder.total);
            document.getElementById('delivery-fee').textContent = formatCurrency(currentOrder.delivery_fee || 0);
            document.getElementById('grand-total').textContent = formatCurrency(currentOrder.grand_total || currentOrder.total);

            const paymentMethodContainer = document.getElementById('payment-method');
            const methodIcons = {
                'Card': '<svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>',
                'GCash': '<svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>',
                'PayMaya': '<svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>',
                'COD': '<svg class="w-8 h-8 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>'
            };

            paymentMethodContainer.innerHTML = `
                <div class="w-12 h-12 bg-white rounded-lg flex items-center justify-center border border-blue-300">
                    ${methodIcons[currentOrder.payment_method] || methodIcons['Card']}
                </div>
                <div>
                    <p class="font-bold text-gray-900 text-lg">${currentOrder.payment_method}</p>
                    <p class="text-sm text-gray-600">Payment method selected</p>
                </div>
            `;
        }

        function generateQRCode() {
            const paymentUrl = `${window.location.origin}/pharma-direct-sql/pay/?orderId=${currentOrderId}`;
            document.getElementById('payment-url').textContent = paymentUrl;

            const qrContainer = document.getElementById('qr-code');
            qrContainer.innerHTML = '';

            if (typeof QRCode === 'undefined') {
                qrContainer.innerHTML = `
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(paymentUrl)}&color=10b981&bgcolor=ffffff" 
                         alt="Payment QR Code" 
                         class="w-48 h-48 border rounded-lg" />
                `;
                return;
            }

            QRCode.toCanvas(qrContainer, paymentUrl, {
                width: 200,
                height: 200,
                color: { dark: '#10b981', light: '#ffffff' }
            }, function (error) {
                if (error) {
                    console.error('QR Code generation error:', error);
                }
            });
        }

        async function processPayment() {
            // --- PayMongo integration: create a payment link on the server and redirect to checkout ---
            try {
                // compute amount from page total elements if available
                const grandTotalEl = document.getElementById('grand-total');
                let amountPhp = null;
                if (grandTotalEl) {
                    // remove non-digit characters and parse number (assumes format like "‚Ç±123.45")
                    amountPhp = Number(grandTotalEl.textContent.replace(/[^0-9.\-]/g, '')) || null;
                }
                // Fallback: try subtotal element
                if (!amountPhp) {
                    const subtotalEl = document.getElementById('subtotal');
                    amountPhp = subtotalEl ? Number(subtotalEl.textContent.replace(/[^0-9.\-]/g, '')) : null;
                }
                // Use currentOrderId if set on the page
                if (!currentOrderId) {
                    showError('Missing order ID ‚Äî please refresh or reopen your checkout link.');
                    return;
                }

                if (!amountPhp) {
                    console.warn('Could not determine amount from page. Please provide amount_php when calling create-payment.');
                }

                const resp = await fetch('/api/create-payment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        amount_php: amountPhp || 0,
                        description: 'Order ' + currentOrderId,
                        orderId: currentOrderId // ‚úÖ send the correct orderId directly
                    })
                });


                const data = await resp.json();
                if (data.checkout_url) {
                    window.location.href = data.checkout_url;
                    return;
                } else {
                    console.error('PayMongo create link response:', data);
                    // fallthrough to original payment flow if it exists
                }
            } catch (err) {
                console.error('Error creating PayMongo link:', err);
                // continue with original flow if any
            }
            // --- end PayMongo integration snippet ---

            const payBtn = document.getElementById('pay-now-btn');
            const payBtnText = document.getElementById('pay-btn-text');

            payBtn.disabled = true;
            payBtnText.textContent = 'Processing...';

            try {
                console.log('üöÄ Starting payment processing...');
                console.log('üìã Order ID:', currentOrderId);
                console.log('üí≥ Payment Method:', currentOrder.payment_method);

                // Use the secure public function to process payment
                // This works for both authenticated users AND anonymous QR code scanners
                console.log('Calling process_payment_public function...');

                const { data, error } = await supabase.rpc('process_payment_public', {
                    order_id_param: currentOrderId,
                    payment_method_param: currentOrder.payment_method || 'Card'
                });

                console.log('Payment function response:', { data, error });

                if (error) {
                    console.error('‚ùå Payment function error:', error);
                    throw error;
                }

                // Check if function returned success
                if (!data || !data.success) {
                    console.error('‚ùå Payment processing failed:', data);
                    throw new Error(data?.error || 'Payment processing failed');
                }

                console.log('‚úÖ Payment processed successfully!', data);

                // Check if user is authenticated to determine redirect
                const { data: { user } } = await supabase.auth.getUser();

                if (user) {
                    // Authenticated user - redirect to track orders
                    createModal('success', 'Payment Completed!',
                        'Your payment has been processed successfully. You will be redirected to track your order.',
                        null,
                        [{
                            text: 'Track Order',
                            class: 'bg-emerald-600 text-white py-2 px-6 rounded-lg font-medium hover:bg-emerald-700 transition-colors',
                            onclick: 'window.location.href = "../track/"'
                        }]
                    );
                    setTimeout(() => { window.location.href = '../track/'; }, 3000);
                } else {
                    // Anonymous user (QR code scanner) - show completion message
                    createModal('success', 'Payment Completed!',
                        'Your payment has been processed successfully! You can now close this page or scan the QR code again to check your order status.',
                        null,
                        [
                            {
                                text: 'Check Order Status',
                                class: 'bg-blue-600 text-white py-2 px-6 rounded-lg font-medium hover:bg-blue-700 transition-colors',
                                onclick: 'window.location.reload()'
                            },
                            {
                                text: 'Close Page',
                                class: 'bg-gray-600 text-white py-2 px-6 rounded-lg font-medium hover:bg-gray-700 transition-colors',
                                onclick: 'window.close()'
                            }
                        ]
                    );
                }

            } catch (error) {
                console.error('‚ùå Payment processing error:', error);

                let errorMessage = 'Payment failed. Please try again.';
                if (error.message) {
                    errorMessage = error.message;
                } else if (error.code === '42883') {
                    errorMessage = 'Payment function not found. Please contact support.';
                } else if (error.code === 'permission-denied' || error.code === '42501') {
                    errorMessage = 'Permission denied. Please contact support.';
                }

                showError(errorMessage);
                payBtn.disabled = false;
                payBtnText.textContent = 'Pay Now';
            }
        }

        async function creditToPharmacyWallet(order) {
            try {
                console.log('üîÑ Starting pharmacy wallet crediting process...');
                console.log('üì¶ Order items to process:', order.items);

                if (!order.items || !Array.isArray(order.items) || order.items.length === 0) {
                    throw new Error('No order items provided to creditToPharmacyWallet');
                }

                const pharmacyItems = {};

                // Group items by pharmacy
                for (const item of order.items) {
                    console.log('Processing item:', item);
                    const productId = item.product_id || item.productId || item.id;
                    if (!productId) {
                        console.error('‚ùå Item missing product_id:', item);
                        throw new Error(`Order item missing product_id: ${JSON.stringify(item)}`);
                    }

                    try {
                        // Get product details from Supabase
                        console.log(`üîç Fetching product: ${productId}`);
                        const { data: product, error: productError } = await supabase
                            .from(TABLES.products)
                            .select('*')
                            .eq('id', productId)
                            .single();

                        if (productError || !product) {
                            console.error(`‚ùå Product not found: ${productId}`, productError);
                            throw new Error(`Product not found: ${productId}`);
                        }

                        const pharmacyId = product.pharmacy_id;
                        console.log(`‚úÖ Product found, belongs to pharmacy: ${pharmacyId}`);

                        if (!pharmacyId) {
                            throw new Error(`Product ${productId} has no pharmacy_id`);
                        }

                        if (!pharmacyItems[pharmacyId]) {
                            pharmacyItems[pharmacyId] = { items: [], totalAmount: 0 };
                        }

                        pharmacyItems[pharmacyId].items.push({
                            productId: productId,
                            quantity: item.quantity,
                            price: item.price
                        });
                        pharmacyItems[pharmacyId].totalAmount += item.price * item.quantity;
                        console.log(`üìä Added ‚Ç±${item.price * item.quantity} to pharmacy ${pharmacyId}`);
                    } catch (productError) {
                        console.error('‚ùå Error processing product:', productId, productError);
                        throw productError; // Don't continue, fail the payment
                    }
                }

                console.log('üìã Pharmacy items grouped:', pharmacyItems);
                console.log('üìä Number of pharmacies to process:', Object.keys(pharmacyItems).length);

                if (Object.keys(pharmacyItems).length === 0) {
                    throw new Error('No pharmacy items to process after grouping');
                }

                // Process each pharmacy
                for (const [pharmacyId, pharmacyData] of Object.entries(pharmacyItems)) {
                    try {
                        console.log(`üè• Processing pharmacy: ${pharmacyId}`);
                        const commission = parseFloat((pharmacyData.totalAmount * 0.05).toFixed(2));
                        const pharmacyAmount = parseFloat((pharmacyData.totalAmount - commission).toFixed(2));

                        console.log(`üí∞ Payment breakdown:`, {
                            totalAmount: pharmacyData.totalAmount,
                            commission: commission,
                            pharmacyAmount: pharmacyAmount,
                            paymentMethod: currentOrder.payment_method
                        });

                        // Get pharmacy details from Supabase
                        const { data: pharmacy, error: pharmacyError } = await supabase
                            .from(TABLES.pharmacies)
                            .select('*')
                            .eq('id', pharmacyId)
                            .single();

                        if (pharmacyError || !pharmacy) {
                            console.error(`‚ùå Pharmacy not found: ${pharmacyId}`, pharmacyError);
                            continue;
                        }

                        console.log(`üìä Current pharmacy wallet state:`, {
                            pharmacyId: pharmacyId,
                            pharmacyName: pharmacy.name,
                            currentWalletBalance: pharmacy.wallet_balance || 0,
                            currentPendingBalance: pharmacy.pending_balance || 0
                        });

                        const currentBalance = parseFloat(pharmacy.wallet_balance || 0);
                        const currentPending = parseFloat(pharmacy.pending_balance || 0);
                        const isQRPayment = currentOrder.payment_method !== 'COD';

                        // Calculate new balances
                        const newWalletBalance = isQRPayment ? currentBalance + pharmacyAmount : currentBalance;
                        const newPendingBalance = isQRPayment ? currentPending : currentPending + pharmacyAmount;

                        console.log(`üîÑ Wallet update calculation:`, {
                            isQRPayment: isQRPayment,
                            paymentMethod: currentOrder.payment_method,
                            currentWalletBalance: currentBalance,
                            newWalletBalance: newWalletBalance,
                            difference: newWalletBalance - currentBalance,
                            currentPendingBalance: currentPending,
                            newPendingBalance: newPendingBalance
                        });

                        // Update pharmacy wallet in Supabase
                        const { data: updateData, error: updateError } = await supabase
                            .from(TABLES.pharmacies)
                            .update({
                                wallet_balance: newWalletBalance,
                                pending_balance: newPendingBalance,
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', pharmacyId)
                            .select();

                        if (updateError) {
                            console.error(`‚ùå Error updating pharmacy wallet for ${pharmacyId}:`, updateError);
                            console.error(`‚ùå Update details:`, {
                                pharmacyId: pharmacyId,
                                attempted_wallet_balance: newWalletBalance,
                                attempted_pending_balance: newPendingBalance
                            });
                            continue;
                        }

                        console.log(`‚úÖ Pharmacy wallet updated successfully!`, updateData);
                        console.log(`‚úÖ New balances:`, {
                            wallet_balance: newWalletBalance,
                            pending_balance: newPendingBalance
                        });

                        // Record transaction (if transactions table exists)
                        console.log('üí∞ Recording transaction for regular payment...');
                        try {
                            const { error: transactionError } = await supabase
                                .from('transactions')
                                .insert({
                                    order_id: currentOrder.id || 'unknown',
                                    pharmacy_id: pharmacyId,
                                    amount: pharmacyAmount,
                                    commission: commission,
                                    type: isQRPayment ? 'card_payment_credit' : 'cod_payment_credit',
                                    status: 'completed',
                                    description: `Payment for order #${currentOrder.id?.slice(-6) || 'unknown'}`,
                                    payment_method: currentOrder.payment_method || 'Card',
                                    created_at: new Date().toISOString()
                                });

                            if (transactionError) {
                                console.warn('‚ö†Ô∏è Could not record transaction:', transactionError);
                            } else {
                                console.log('‚úÖ Transaction recorded successfully');
                            }
                        } catch (transactionError) {
                            console.warn('‚ö†Ô∏è Transaction recording not available:', transactionError);
                        }

                        // Update product stock for each item
                        console.log(`üì¶ Deducting stock for ${pharmacyData.items.length} items...`);
                        for (const item of pharmacyData.items) {
                            try {
                                console.log(`üîç Checking stock for product: ${item.productId}`);
                                // Get current product stock
                                const { data: currentProduct, error: currentError } = await supabase
                                    .from(TABLES.products)
                                    .select('stock, name')
                                    .eq('id', item.productId)
                                    .single();

                                if (currentError || !currentProduct) {
                                    console.error(`‚ùå Product not found for stock update: ${item.productId}`, currentError);
                                    throw new Error(`Cannot update stock for missing product: ${item.productId}`);
                                }

                                const currentStock = currentProduct.stock || 0;
                                const newStock = Math.max(0, currentStock - item.quantity);

                                console.log(`üìâ Stock update: ${currentProduct.name} ‚Üí ${currentStock} - ${item.quantity} = ${newStock}`);

                                // Update product stock
                                const { error: stockUpdateError } = await supabase
                                    .from(TABLES.products)
                                    .update({
                                        stock: newStock,
                                        updated_at: new Date().toISOString()
                                    })
                                    .eq('id', item.productId);

                                if (stockUpdateError) {
                                    console.error(`‚ùå Error updating stock for product ${item.productId}:`, stockUpdateError);
                                    throw stockUpdateError;
                                } else {
                                    console.log(`‚úÖ Stock updated successfully: ${currentProduct.name} (${currentStock} ‚Üí ${newStock})`);
                                }
                            } catch (stockError) {
                                console.error(`‚ùå Critical error updating stock for product ${item.productId}:`, stockError);
                                throw stockError; // Fail the payment if stock can't be updated
                            }
                        }
                        console.log(`‚úÖ All stock deductions completed for pharmacy ${pharmacyId}`);
                    } catch (pharmacyError) {
                        console.error(`‚ùå CRITICAL: Error processing pharmacy ${pharmacyId}:`, pharmacyError);
                        // Don't continue - if any pharmacy fails, the whole payment should fail
                        throw pharmacyError;
                    }
                }

                console.log('üéâ All pharmacies processed successfully!');

                console.log('Payment credited and stock reduced successfully');
            } catch (error) {
                console.error('Error crediting payment:', error);
                throw error;
            }
        }

        // showSuccess is imported from supabase-config.js

        // showError is imported from supabase-config.js

        // Wait for DOM to be ready before adding event listeners
        document.addEventListener('DOMContentLoaded', () => {
            const payNowBtn = document.getElementById('pay-now-btn');
            const cancelPaymentBtn = document.getElementById('cancel-payment');
            const refreshPaymentBtn = document.getElementById('refresh-payment-status');

            if (payNowBtn) {
                payNowBtn.addEventListener('click', processPayment);
            } else {
                console.error('Pay now button not found');
            }

            if (cancelPaymentBtn) {
                cancelPaymentBtn.addEventListener('click', () => {
                    createModal('warning', 'Cancel Payment?',
                        'Are you sure you want to cancel this payment? This action cannot be undone.',
                        null,
                        [
                            {
                                text: 'Keep Payment',
                                class: 'bg-gray-600 text-white py-2 px-6 rounded-lg font-medium hover:bg-gray-700 transition-colors',
                                onclick: 'closeCustomModal()'
                            },
                            {
                                text: 'Cancel Payment',
                                class: 'bg-red-600 text-white py-2 px-6 rounded-lg font-medium hover:bg-red-700 transition-colors',
                                onclick: 'window.location.href = "../cart/"'
                            }
                        ]
                    );
                });
            } else {
                console.error('Cancel payment button not found');
            }

            if (refreshPaymentBtn) {
                refreshPaymentBtn.addEventListener('click', () => {
                    // Temporarily show loading state
                    const originalText = refreshPaymentBtn.innerHTML;
                    refreshPaymentBtn.innerHTML = `
                        <div class="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"></div>
                        Checking...
                    `;
                    refreshPaymentBtn.disabled = true;

                    // Check payment status
                    checkPaymentStatus().finally(() => {
                        // Restore button state
                        refreshPaymentBtn.innerHTML = originalText;
                        refreshPaymentBtn.disabled = false;
                    });
                });
            }
        });

        // Cleanup subscription when page is unloaded
        window.addEventListener('beforeunload', () => {
            stopPaymentMonitoring();
        });

        // Init without auth
        (async () => {
            const orderId = getOrderIdFromUrl();
            console.log("üí° currentOrderId:", orderId); // add this
            if (!orderId) {
                showError('Invalid payment link');
                return;
            }
            await loadOrderData(orderId);
        })();
    </script>
</body>

</html>
<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Payment â€” PHARMA DIRECT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../css/styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
</head>

<body class="min-h-screen bg-gray-50">
    <header class="bg-white border-b">
        <div class="mx-auto container-max px-4 py-3 flex items-center justify-between">
            <a href="../" class="font-semibold text-emerald-600">PHARMA DIRECT</a>
            <div class="text-sm text-gray-600">Secure Payment</div>
        </div>
    </header>

    <main class="mx-auto container-max px-4 py-8 pb-24">
        <!-- Back Button -->
        <div class="mb-6">
            <a href="../track/"
                class="inline-flex items-center gap-2 text-emerald-600 hover:text-emerald-700 font-medium">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                Back to Track Orders
            </a>
        </div>

        <div class="max-w-4xl mx-auto">
            <!-- Payment Header -->
            <div class="bg-gradient-to-r from-emerald-600 to-emerald-700 rounded-2xl p-6 mb-6 text-white">
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z">
                            </path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">Complete Your Payment</h1>
                        <p class="text-emerald-100">Order ID: <span id="order-id"
                                class="font-mono text-emerald-200">Loading...</span></p>
                    </div>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="bg-white rounded-2xl border border-gray-200 shadow-lg overflow-hidden mb-6">
                <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        Order Summary
                    </h2>
                </div>
                <div class="p-6">
                    <div id="order-items" class="space-y-3 mb-4"></div>
                    <div class="border-t pt-4 space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Subtotal</span>
                            <span id="subtotal" class="font-medium">â‚±0.00</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Delivery Fee</span>
                            <span id="delivery-fee" class="font-medium">â‚±0.00</span>
                        </div>
                        <div class="flex justify-between text-lg font-semibold border-t pt-2">
                            <span>Total</span>
                            <span id="grand-total" class="text-emerald-600">â‚±0.00</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Method -->
            <div class="bg-white rounded-2xl border border-gray-200 shadow-lg overflow-hidden mb-6">
                <div class="bg-gradient-to-r from-blue-50 to-blue-100 px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-bold text-blue-800 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                        </svg>
                        Payment Method
                    </h2>
                </div>
                <div class="p-6">
                    <div id="payment-method" class="flex items-center gap-4 p-4 bg-blue-50 rounded-xl border border-blue-200"></div>
                </div>
            </div>

            <!-- QR Code Section -->
            <div class="bg-white rounded-2xl border border-gray-200 shadow-lg overflow-hidden mb-6">
                <div class="bg-gradient-to-r from-green-50 to-green-100 px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-bold text-green-800 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
                        </svg>
                        Payment QR Code
                    </h2>
                </div>
                <div class="p-6 text-center">
                    <div id="qr-code" class="inline-block p-4 bg-white border-2 border-gray-200 rounded-xl mb-4">
                        <div
                            class="w-48 h-48 bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center">
                            <div class="text-center">
                                <p class="text-gray-600 text-sm">Loading QR Code...</p>
                            </div>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mb-4">Scan this QR code with your mobile payment app</p>
                    <div class="text-xs text-gray-500 bg-gray-50 p-3 rounded-lg">
                        <p class="font-mono break-all" id="payment-url">Loading payment URL...</p>
                    </div>
                </div>
            </div>

            <!-- Payment Actions -->
            <div class="bg-white rounded-2xl border border-gray-200 shadow-lg overflow-hidden">
                <div class="bg-gradient-to-r from-emerald-600 to-emerald-700 px-6 py-4">
                    <h2 class="text-lg font-bold text-white flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Payment Actions
                    </h2>
                </div>
                <div class="p-6">
                    <div class="space-y-4">
                        <button id="pay-now-btn"
                            class="w-full bg-gradient-to-r from-emerald-600 to-emerald-700 text-white py-4 px-6 rounded-xl font-bold text-lg hover:from-emerald-700 hover:to-emerald-800 transition-all duration-300 disabled:from-gray-400 disabled:to-gray-500 disabled:cursor-not-allowed shadow-lg hover:shadow-xl flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span id="pay-btn-text">Pay Now</span>
                        </button>
                        <button id="cancel-payment"
                            class="w-full bg-gray-200 text-gray-700 py-3 px-6 rounded-xl font-semibold hover:bg-gray-300 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            Cancel Payment
                        </button>
                    </div>
                    <div id="payment-feedback" class="mt-4 text-sm hidden"></div>
                </div>
            </div>
        </div>
    </main>

    <script src="../js/imageCache.js"></script>
    <script src="../js/loading.js"></script>
    <script type="module">
        import { formatCurrency, showError, showSuccess, getProfessionalErrorMessage, setButtonLoading, showLoadingModal, hideLoadingModal } from '../js/supabase-config.js';
        import { supabase } from '../js/supabase-auth.js';
        import { TABLES } from '../js/supabase-config.js';
        import { updateOrderStage, updatePharmacyWallet } from '../js/supabase-database.js';

        let currentOrder = null;
        let currentOrderId = null;

        function getOrderIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('orderId');
        }

        async function loadOrderData(orderId) {
            try {
                const { data: order, error } = await supabase
                    .from(TABLES.orders)
                    .select('*')
                    .eq('id', orderId)
                    .single();

                if (error || !order) {
                    showError('Order not found');
                    return;
                }

                currentOrder = order;
                currentOrderId = orderId;

                // Fetch order items from the order_items table
                console.log('Fetching order items for orderId:', orderId);
                const { data: orderItems, error: itemsError } = await supabase
                    .from(TABLES.order_items)
                    .select('*')
                    .eq('order_id', orderId);

                console.log('Order items query result:', { orderItems, itemsError });

                if (itemsError) {
                    console.error('Error fetching order items:', itemsError);
                    showError('Failed to load order items');
                    return;
                }

                // Fetch product details (including images) for each order item
                if (orderItems && orderItems.length > 0) {
                    const enrichedItems = await Promise.all(orderItems.map(async (item) => {
                        try {
                            const { data: product, error: productError } = await supabase
                                .from(TABLES.products)
                                .select('image_url, name')
                                .eq('id', item.product_id)
                                .single();
                            
                            if (!productError && product) {
                                return {
                                    ...item,
                                    image_url: product.image_url,
                                    display_name: product.name || item.product_name
                                };
                            } else {
                                console.warn('Could not fetch product details for:', item.product_id);
                                return {
                                    ...item,
                                    image_url: null,
                                    display_name: item.product_name
                                };
                            }
                        } catch (error) {
                            console.warn('Error fetching product for item:', item.product_id, error);
                            return {
                                ...item,
                                image_url: null,
                                display_name: item.product_name
                            };
                        }
                    }));
                    
                    currentOrder.items = enrichedItems;
                } else {
                    currentOrder.items = [];
                }
                
                console.log('Added items to currentOrder:', currentOrder.items);

                if (currentOrder.payment_status === 'Confirmed') {
                    showSuccess('Payment already completed');
                    return;
                }

                displayOrderData();
                generateQRCode();
                if (typeof QRCode === 'undefined') {
                    setTimeout(() => { generateQRCode(); }, 1000);
                }

            } catch (error) {
                console.error('Error loading order:', error);
                showError('Failed to load order data');
            }
        }

        function displayOrderData() {
            document.getElementById('order-id').textContent = currentOrderId.slice(-8);

            console.log('Displaying order data:', currentOrder);
            console.log('Order items:', currentOrder.items);
            console.log('Items length:', currentOrder.items?.length);

            const itemsContainer = document.getElementById('order-items');
            
            if (!currentOrder.items || currentOrder.items.length === 0) {
                console.log('No items found, showing empty message');
                itemsContainer.innerHTML = '<div class="text-center text-gray-500 py-4">No items found in this order</div>';
                return;
            }

            itemsContainer.innerHTML = currentOrder.items.map(item => `
                <div class="flex items-center justify-between py-3 border-b border-gray-200 last:border-0">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center flex-shrink-0 overflow-hidden">
                            ${item.image_url ? 
                                `<img src="${item.image_url}" alt="${item.display_name || item.product_name}" class="w-full h-full object-cover rounded-lg">` :
                                `<div class="w-full h-full bg-purple-100 rounded-lg flex items-center justify-center">
                                    <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                    </svg>
                                </div>`
                            }
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-900 text-sm mb-1">${item.display_name || item.product_name}</h4>
                            <p class="text-xs text-gray-600">Qty: ${item.quantity}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-gray-900">â‚±${(item.price * item.quantity).toFixed(2)}</p>
                        <p class="text-xs text-gray-600">â‚±${item.price} each</p>
                    </div>
                </div>
            `).join('');

            document.getElementById('subtotal').textContent = formatCurrency(currentOrder.total);
            document.getElementById('delivery-fee').textContent = formatCurrency(currentOrder.delivery_fee || 0);
            document.getElementById('grand-total').textContent = formatCurrency(currentOrder.grand_total || currentOrder.total);

            const paymentMethodContainer = document.getElementById('payment-method');
            const methodIcons = { 
                'Card': '<svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>', 
                'GCash': '<svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>', 
                'PayMaya': '<svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>',
                'COD': '<svg class="w-8 h-8 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>'
            };

            paymentMethodContainer.innerHTML = `
                <div class="w-12 h-12 bg-white rounded-lg flex items-center justify-center border border-blue-300">
                    ${methodIcons[currentOrder.payment_method] || methodIcons['Card']}
                </div>
                <div>
                    <p class="font-bold text-gray-900 text-lg">${currentOrder.payment_method}</p>
                    <p class="text-sm text-gray-600">Payment method selected</p>
                </div>
            `;
        }

        function generateQRCode() {
            const paymentUrl = `${window.location.origin}/pharma-direct-sql/pay/?orderId=${currentOrderId}`;
            document.getElementById('payment-url').textContent = paymentUrl;

            const qrContainer = document.getElementById('qr-code');
            qrContainer.innerHTML = '';

            if (typeof QRCode === 'undefined') {
                qrContainer.innerHTML = `
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(paymentUrl)}&color=10b981&bgcolor=ffffff" 
                         alt="Payment QR Code" 
                         class="w-48 h-48 border rounded-lg" />
                `;
                return;
            }

            QRCode.toCanvas(qrContainer, paymentUrl, {
                width: 200,
                height: 200,
                color: { dark: '#10b981', light: '#ffffff' }
            }, function (error) {
                if (error) {
                    console.error('QR Code generation error:', error);
                }
            });
        }

        async function processPayment() {
            const payBtn = document.getElementById('pay-now-btn');
            const payBtnText = document.getElementById('pay-btn-text');

            payBtn.disabled = true;
            payBtnText.textContent = 'Processing...';

            try {
                // Step 1: Update order status
                console.log('Updating order status...');
                const { error: updateError } = await supabase
                    .from(TABLES.orders)
                    .update({
                        payment_status: 'Confirmed',
                        stage: 'Confirmed',
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', currentOrderId);
                
                if (updateError) {
                    throw updateError;
                }
                console.log('Order status updated successfully');

                // Step 2: Credit pharmacy wallets (with error handling)
                try {
                    console.log('Crediting pharmacy wallets...');
                    await creditToPharmacyWallet(currentOrder);
                    console.log('Pharmacy wallets credited successfully');
                } catch (walletError) {
                    console.warn('Warning: Could not credit pharmacy wallets:', walletError);
                    // Continue with payment even if wallet crediting fails
                }

                showSuccess('Payment completed successfully!');

                setTimeout(() => { window.location.href = '../track/'; }, 2000);

            } catch (error) {
                console.error('Payment processing error:', error);

                let errorMessage = 'Payment failed. Please try again.';
                if (error.code === 'permission-denied') {
                    errorMessage = 'Permission denied. Please check Firestore rules.';
                } else if (error.message) {
                    errorMessage = error.message;
                }

                showError(errorMessage);
                payBtn.disabled = false;
                payBtnText.textContent = 'Pay Now';
            }
        }

        async function creditToPharmacyWallet(order) {
            try {
                console.log('Starting pharmacy wallet crediting process...');
                const pharmacyItems = {};

                // Group items by pharmacy
                for (const item of order.items) {
                    const productId = item.product_id || item.productId || item.id;
                    if (!productId) {
                        console.warn('Item missing product_id:', item);
                        continue;
                    }

                    try {
                        // Get product details from Supabase
                        const { data: product, error: productError } = await supabase
                            .from(TABLES.products)
                            .select('*')
                            .eq('id', productId)
                            .single();

                        if (productError || !product) {
                            console.warn('Product not found:', productId);
                            continue;
                        }

                        const pharmacyId = product.pharmacy_id;

                        if (!pharmacyItems[pharmacyId]) {
                            pharmacyItems[pharmacyId] = { items: [], totalAmount: 0 };
                        }

                        pharmacyItems[pharmacyId].items.push({
                            productId: productId,
                            quantity: item.quantity,
                            price: item.price
                        });
                        pharmacyItems[pharmacyId].totalAmount += item.price * item.quantity;
                    } catch (productError) {
                        console.warn('Error processing product:', productId, productError);
                        continue;
                    }
                }

                console.log('Pharmacy items grouped:', pharmacyItems);

                // Process each pharmacy
                for (const [pharmacyId, pharmacyData] of Object.entries(pharmacyItems)) {
                    try {
                        console.log(`Processing pharmacy: ${pharmacyId}`);
                        const commission = pharmacyData.totalAmount * 0.05;
                        const pharmacyAmount = pharmacyData.totalAmount - commission;

                        // Get pharmacy details from Supabase
                        const { data: pharmacy, error: pharmacyError } = await supabase
                            .from(TABLES.pharmacies)
                            .select('*')
                            .eq('id', pharmacyId)
                            .single();

                        if (pharmacyError || !pharmacy) {
                            console.warn(`Pharmacy not found: ${pharmacyId}`);
                            continue;
                        }

                        console.log(`Updating pharmacy wallet for ${pharmacyId}`);
                        const currentBalance = pharmacy.wallet_balance || 0;
                        const currentPending = pharmacy.pending_balance || 0;
                        const isQRPayment = currentOrder.payment_method !== 'COD';

                        // Update pharmacy wallet in Supabase
                        const { error: updateError } = await supabase
                            .from(TABLES.pharmacies)
                            .update({
                                wallet_balance: isQRPayment ? currentBalance + pharmacyAmount : currentBalance,
                                pending_balance: isQRPayment ? currentPending : currentPending + pharmacyAmount,
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', pharmacyId);

                        if (updateError) {
                            console.error(`Error updating pharmacy wallet for ${pharmacyId}:`, updateError);
                            continue;
                        }

                        console.log(`Pharmacy wallet updated for ${pharmacyId}`);

                        // Record transaction (if transactions table exists)
                        console.log('ðŸ’° Recording transaction for regular payment...');
                        try {
                            const { error: transactionError } = await supabase
                                .from('transactions')
                                .insert({
                                    order_id: currentOrder.id || 'unknown',
                                    pharmacy_id: pharmacyId,
                                    amount: pharmacyAmount,
                                    commission: commission,
                                    type: isQRPayment ? 'card_payment_credit' : 'cod_payment_credit',
                                    status: 'completed',
                                    description: `Payment for order #${currentOrder.id?.slice(-6) || 'unknown'}`,
                                    payment_method: currentOrder.payment_method || 'Card',
                                    created_at: new Date().toISOString()
                                });
                            
                            if (transactionError) {
                                console.warn('âš ï¸ Could not record transaction:', transactionError);
                            } else {
                                console.log('âœ… Transaction recorded successfully');
                            }
                        } catch (transactionError) {
                            console.warn('âš ï¸ Transaction recording not available:', transactionError);
                        }

                        // Update product stock for each item
                        for (const item of pharmacyData.items) {
                            try {
                                // Get current product stock
                                const { data: currentProduct, error: currentError } = await supabase
                                    .from(TABLES.products)
                                    .select('stock')
                                    .eq('id', item.productId)
                                    .single();

                                if (currentError || !currentProduct) {
                                    console.warn(`Product not found for stock update: ${item.productId}`);
                                    continue;
                                }

                                const currentStock = currentProduct.stock || 0;
                                const newStock = Math.max(0, currentStock - item.quantity);

                                // Update product stock
                                const { error: stockUpdateError } = await supabase
                                    .from(TABLES.products)
                                    .update({
                                        stock: newStock,
                                        updated_at: new Date().toISOString()
                                    })
                                    .eq('id', item.productId);

                                if (stockUpdateError) {
                                    console.warn(`Error updating stock for product ${item.productId}:`, stockUpdateError);
                                } else {
                                    console.log(`Stock updated for product ${item.productId}: ${currentStock} -> ${newStock}`);
                                }
                            } catch (stockError) {
                                console.warn(`Error updating stock for product ${item.productId}:`, stockError);
                            }
                        }
                    } catch (pharmacyError) {
                        console.error(`Error processing pharmacy ${pharmacyId}:`, pharmacyError);
                        // Continue with other pharmacies even if one fails
                    }
                }

                console.log('Payment credited and stock reduced successfully');
            } catch (error) {
                console.error('Error crediting payment:', error);
                throw error;
            }
        }

        // showSuccess is imported from supabase-config.js

        // showError is imported from supabase-config.js

        // Wait for DOM to be ready before adding event listeners
        document.addEventListener('DOMContentLoaded', () => {
            const payNowBtn = document.getElementById('pay-now-btn');
            const cancelPaymentBtn = document.getElementById('cancel-payment');
            
            if (payNowBtn) {
                payNowBtn.addEventListener('click', processPayment);
            } else {
                console.error('Pay now button not found');
            }
            
            if (cancelPaymentBtn) {
                cancelPaymentBtn.addEventListener('click', () => {
                    if (confirm('Are you sure you want to cancel this payment?')) {
                        window.location.href = '../cart/';
                    }
                });
            } else {
                console.error('Cancel payment button not found');
            }
        });

        // Init without auth
        (async () => {
            const orderId = getOrderIdFromUrl();
            if (!orderId) {
                showError('Invalid payment link');
                return;
            }
            await loadOrderData(orderId);
        })();
    </script>
</body>
</html>

<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cart & Checkout — PHARMA DIRECT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../css/styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <link rel="icon" type="image/x-icon" href="../favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="../img/icon.png">
    <link rel="apple-touch-icon" href="../img/icon.png">
    <link rel="manifest" href="../manifest.json?v=2">
    <meta name="theme-color" content="#10b981">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="PHARMA DIRECT">
    <style>
        /* Mobile menu height constraints - prevent overflow */
        #mobile-menu {
            height: 100vh;
            max-height: 100vh;
            overflow: hidden;
            position: fixed;
            top: 0;
            right: 0;
            width: 320px;
            max-width: 90vw;
        }
        
        /* Use actual viewport height for mobile browsers */
        @media (max-width: 768px) {
            #mobile-menu {
                height: 100vh;
                max-height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom));
            }
        }
        
        /* Ensure logout button is always visible */
        .mobile-menu-content {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }
        
        .mobile-nav-scroll {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
            max-height: calc(100vh - 180px); /* Reserve space for header and bottom actions */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }
        
        /* Ensure the menu never exceeds viewport */
        @supports (height: 100dvh) {
            #mobile-menu {
                height: 100dvh;
                max-height: 100dvh;
            }
            
            .mobile-nav-scroll {
                max-height: calc(100dvh - 200px);
            }
        }
        
        /* Fallback for older browsers - use smaller viewport */
        @media (max-width: 768px) {
            .mobile-nav-scroll {
                max-height: calc(100vh - 200px);
            }
        }
        
        /* Bottom actions always visible and fixed */
        .mobile-bottom-actions {
            flex-shrink: 0;
            margin-top: auto;
        }
        
        /* User info section */
        .mobile-user-info {
            flex-shrink: 0;
        }
        
        /* Navigation items */
        .mobile-nav-item {
            flex-shrink: 0;
        }
        
        /* Prevent body scroll when menu is open */
        body.menu-open {
            overflow: hidden;
            height: 100vh;
        }
    </style>
</head>

<body class="min-h-screen bg-gray-50">
    <header class="bg-white border-b sticky top-0 z-40">
        <div class="mx-auto container-max px-4 py-3 flex items-center justify-between">
            <a href="../" class="flex items-center gap-2 flex-shrink-0">
                <img src="../img/icon.png" alt="logo" class="w-6 h-6" />
                <span class="font-semibold text-lg hidden sm:block">PHARMA DIRECT</span>
                <span class="font-semibold text-lg sm:hidden">PHARMA</span>
            </a>
            
            <!-- Mobile Menu Button -->
            <button id="mobile-menu-btn" class="lg:hidden p-2 rounded-lg hover:bg-gray-100 transition-colors">
                <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
        </div>
    </header>

    <!-- Mobile Menu Overlay -->
    <div id="mobile-menu-overlay" class="lg:hidden hidden fixed inset-0 z-50 bg-black bg-opacity-50 transition-opacity duration-300"></div>
    
            <!-- Mobile Menu -->
            <div id="mobile-menu" class="lg:hidden hidden fixed top-0 right-0 h-screen w-80 max-w-sm bg-white shadow-2xl transform transition-transform duration-300 ease-in-out z-50 flex flex-col">
            <!-- Mobile Menu Header -->
            <div class="flex items-center justify-between p-6 bg-gradient-to-r from-emerald-600 to-emerald-700 text-white">
                <div class="flex items-center gap-3">
                    <img src="../img/icon.png" alt="logo" class="w-8 h-8" />
                    <div>
                        <h2 class="font-bold text-lg">PHARMA DIRECT</h2>
                        <p class="text-emerald-100 text-sm">Your Health Partner</p>
                    </div>
                </div>
                <button id="mobile-menu-close" class="p-2 rounded-full hover:bg-white hover:bg-opacity-20 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
                <!-- Mobile Menu Content -->
                <div class="flex flex-col flex-1 min-h-0">
                    <!-- User Info Section -->
                    <div id="mobile-account-section" class="p-6 bg-gray-50 border-b border-gray-200 flex-shrink-0">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center">
                                <svg class="w-8 h-8 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="font-bold text-lg text-gray-900" id="mobile-account-name">Loading...</p>
                                <p class="text-sm text-gray-500" id="mobile-account-email">Loading...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Navigation Links -->
                    <div class="flex-1 overflow-y-auto min-h-0">
                        <nav class="p-6 space-y-2">
                        <!-- Primary Navigation -->
                        <div class="space-y-2">
                            <!-- Home -->
                            <a href="../" class="flex items-center gap-4 px-4 py-3 rounded-xl hover:bg-emerald-50 hover:text-emerald-700 transition-all duration-200 group">
                                <div class="w-10 h-10 bg-emerald-100 group-hover:bg-emerald-200 rounded-xl flex items-center justify-center transition-colors">
                                    <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                                    </svg>
                                </div>
                                <span class="font-medium text-gray-700 group-hover:text-emerald-700">Home</span>
                            </a>
                        
                            <!-- Categories -->
                            <a href="../categories/" class="flex items-center gap-4 px-4 py-3 rounded-xl hover:bg-blue-50 hover:text-blue-700 transition-all duration-200 group">
                                <div class="w-10 h-10 bg-blue-100 group-hover:bg-blue-200 rounded-xl flex items-center justify-center transition-colors">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                    </svg>
                                </div>
                                <span class="font-medium text-gray-700 group-hover:text-blue-700">Categories</span>
                            </a>
                        
                            <!-- Track Order -->
                            <a href="../track/" class="flex items-center gap-4 px-4 py-3 rounded-xl hover:bg-purple-50 hover:text-purple-700 transition-all duration-200 group">
                                <div class="w-10 h-10 bg-purple-100 group-hover:bg-purple-200 rounded-xl flex items-center justify-center transition-colors">
                                    <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                    </svg>
                                </div>
                                <span class="font-medium text-gray-700 group-hover:text-purple-700">Track Order</span>
                            </a>
                        
                            <!-- Cart -->
                            <a href="../cart/" class="flex items-center gap-4 px-4 py-3 rounded-xl hover:bg-green-50 hover:text-green-700 transition-all duration-200 group bg-green-50 text-green-700">
                                <div class="w-10 h-10 bg-green-100 group-hover:bg-green-200 rounded-xl flex items-center justify-center transition-colors">
                                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-2.5 5M7 13l2.5 5"></path>
                                    </svg>
                                </div>
                                <div class="flex-1 flex items-center justify-between">
                                    <span class="font-medium text-green-700">Cart</span>
                                    <span id="mobile-cart-count" class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-emerald-600 text-white text-xs font-bold">0</span>
                                </div>
                            </a>
                        </div>
                        
                        <!-- Divider -->
                        <div class="my-4 border-t border-gray-200"></div>
                        
                        <!-- Account Section -->
                        <div class="space-y-2">
                            <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider px-4">Account</p>
                        
                            <!-- Dashboard (for logged-in users) -->
                            <a id="mobile-dashboard-link" href="../user-dashboard/" class="hidden flex items-center gap-4 px-4 py-3 rounded-xl hover:bg-indigo-50 hover:text-indigo-700 transition-all duration-200 group">
                                <div class="w-10 h-10 bg-indigo-100 group-hover:bg-indigo-200 rounded-xl flex items-center justify-center transition-colors">
                                    <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                                    </svg>
                                </div>
                                <span class="font-medium text-gray-700 group-hover:text-indigo-700">Dashboard</span>
                            </a>
                        
                            <!-- Manage Address (for logged-in users) -->
                            <a id="mobile-address-link" href="../addresses/" class="hidden flex items-center gap-4 px-4 py-3 rounded-xl hover:bg-purple-50 hover:text-purple-700 transition-all duration-200 group">
                                <div class="w-10 h-10 bg-purple-100 group-hover:bg-purple-200 rounded-xl flex items-center justify-center transition-colors">
                                    <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                </div>
                                <span class="font-medium text-gray-700 group-hover:text-purple-700">Manage Address</span>
                            </a>
                        </div>
                    </nav>
                </div>
                
                    <!-- Bottom Actions -->
                    <div class="p-6 border-t border-gray-200 bg-gray-50 flex-shrink-0">
                    <!-- Login Button (for non-logged-in users) -->
                    <a id="mobile-login-section" href="../login/" class="hidden flex items-center justify-center gap-3 w-full px-4 py-3 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 transition-colors font-medium">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>
                        </svg>
                        <span>Login / Register</span>
                    </a>
                    
                    <!-- Logout Button (for logged-in users) -->
                    <button id="mobile-logout-btn" class="flex items-center justify-center gap-3 w-full px-4 py-3 bg-red-600 text-white rounded-xl hover:bg-red-700 transition-colors font-medium">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                        <span>Logout</span>
                    </button>
                </div>
            </div>
        </div>

    <main class="mx-auto container-max px-4 py-8 pb-24">
        <!-- Back Button -->
        <div class="mb-6">
            <a href="../categories/"
                class="inline-flex items-center gap-2 text-emerald-600 hover:text-emerald-700 font-medium">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                Back to Categories
            </a>
        </div>

        <!-- Cart Header -->
        <div class="mb-6 sm:mb-8">
            <div class="bg-gradient-to-r from-emerald-600 to-emerald-700 rounded-2xl p-6 sm:p-8 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl sm:text-3xl font-bold mb-2">Your Cart</h1>
                        <p class="text-emerald-100 text-sm sm:text-base">Review your items and proceed to checkout</p>
                    </div>
                    <div class="hidden sm:block">
                        <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-2.5 5M7 13l2.5 5"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid md:grid-cols-3 gap-6">
            <!-- Cart Items Section -->
            <section class="md:col-span-2 bg-white rounded-2xl border border-gray-200 shadow-lg overflow-hidden">
                <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                        <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-2.5 5M7 13l2.5 5"></path>
                        </svg>
                        Cart Items
                    </h2>
                </div>
                <div class="p-6">
                    <div id="cart-items" class="space-y-4"></div>
                </div>
            </section>
            
            <!-- Checkout Section -->
            <aside class="bg-white rounded-2xl border border-gray-200 shadow-lg overflow-hidden h-fit">
                <div class="bg-gradient-to-r from-emerald-600 to-emerald-700 px-6 py-4">
                    <h2 class="text-lg font-bold text-white flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Checkout
                    </h2>
                </div>
                <div class="p-6">

                <!-- Customer Information -->
                <div class="mb-6">
                    <div class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl p-4 mb-4">
                        <h3 class="text-md font-bold text-blue-800 flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            Customer Information
                        </h3>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                            <input type="text" id="customer-name"
                                class="w-full rounded-xl border border-gray-300 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all duration-300"
                                placeholder="Enter your full name" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                            <input type="tel" id="customer-phone"
                                class="w-full rounded-xl border border-gray-300 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all duration-300"
                                placeholder="09XX XXX XXXX" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                            <input type="email" id="customer-email"
                                class="w-full rounded-xl border border-gray-300 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all duration-300"
                                placeholder="your@email.com" required>
                        </div>
                    </div>
                </div>

                <!-- Delivery Address -->
                <div class="mb-6">
                    <div class="bg-gradient-to-r from-purple-50 to-purple-100 rounded-xl p-4 mb-4">
                        <div class="flex items-center justify-between">
                            <h3 class="text-md font-bold text-purple-800 flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                Delivery Address
                            </h3>
                            <div class="flex gap-2">
                                <a href="../addresses/" class="text-sm text-purple-600 hover:text-purple-700 font-medium">Manage Addresses</a>
                            </div>
                        </div>
                    </div>
                    <div id="address-selection" class="space-y-3">
                        <div class="text-sm text-gray-500">Loading addresses...</div>
                    </div>
                    <button id="add-new-address-btn"
                        class="mt-3 w-full rounded-xl border-2 border-dashed border-gray-300 px-4 py-3 text-sm text-gray-600 hover:border-emerald-500 hover:text-emerald-600 transition-all duration-300 font-medium">
                        <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Add New Address
                    </button>
                </div>

                <!-- Payment Method -->
                <div class="mb-6">
                    <div class="bg-gradient-to-r from-green-50 to-green-100 rounded-xl p-4 mb-4">
                        <h3 class="text-md font-bold text-green-800 flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                            </svg>
                            Payment Method
                        </h3>
                    </div>
                    <select id="payment-method"
                        class="w-full rounded-xl border border-gray-300 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all duration-300">
                        <option id="cod-option" style="display: none;">COD</option>
                        <option>Card</option>
                        <option>GCash</option>
                        <option>PayMaya</option>
                    </select>
                    <div id="cod-disabled-notice" class="mt-3 p-3 bg-amber-50 border border-amber-200 rounded-xl text-sm text-amber-700 hidden">
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                            COD (Cash on Delivery) is not available for your account. Please use Card, GCash, or PayMaya.
                        </div>
                    </div>
                </div>

                <div id="payment-ui" class="mb-6 text-sm"></div>

                <div class="border-t border-gray-200 pt-6">
                    <div class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl p-4 mb-4">
                        <h3 class="text-md font-bold text-gray-800 flex items-center gap-2 mb-3">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                            </svg>
                            Order Summary
                        </h3>
                        <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <div class="text-gray-600">Subtotal</div>
                                <div id="total" class="font-medium text-gray-900">₱0.00</div>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="text-gray-600">Delivery Fee</div>
                                <div id="delivery-fee" class="font-medium text-gray-900">₱0.00</div>
                        </div>
                            <div class="flex items-center justify-between border-t border-gray-200 pt-3">
                                <div class="text-gray-900 font-bold text-lg">Total</div>
                                <div id="grand-total" class="font-bold text-emerald-600 text-lg">₱0.00</div>
                            </div>
                        </div>
                    </div>
                    <button id="place-order"
                        class="w-full rounded-xl bg-gradient-to-r from-emerald-600 to-emerald-700 text-white px-6 py-4 hover:from-emerald-700 hover:to-emerald-800 transition-all duration-300 disabled:from-gray-400 disabled:to-gray-500 disabled:cursor-not-allowed font-bold text-lg shadow-lg hover:shadow-xl">
                        <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Place Order
                    </button>
                    <div id="feedback" class="mt-4 p-3 bg-emerald-50 border border-emerald-200 rounded-xl text-sm text-emerald-700 hidden">
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span id="feedback-text"></span>
                        </div>
                    </div>
                    <div id="error-message" class="mt-4 p-3 bg-red-50 border border-red-200 rounded-xl text-sm text-red-700 hidden">
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                            <span id="error-text"></span>
                        </div>
                    </div>
                </div>
            </aside>
    </main>

    <!-- Payment Modal -->
    <div id="payment-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl max-w-2xl w-full my-8">
                <!-- Modal Header -->
                <div class="bg-gradient-to-r from-emerald-600 to-emerald-700 px-6 py-4 rounded-t-2xl">
                    <div class="flex items-center justify-between">
                        <h3 class="text-xl font-bold text-white flex items-center gap-2">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                            </svg>
                            Complete Payment
                        </h3>
                        <button id="close-payment-modal" class="text-white hover:text-emerald-200 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Modal Content -->
                <div class="p-6">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <h4 class="text-xl font-bold text-gray-900 mb-2">Order Created Successfully!</h4>
                        <p class="text-gray-600">Complete your payment to confirm your order</p>
                    </div>

                    <!-- Payment Options -->
                    <div class="space-y-4 mb-6">
                        <div class="bg-gray-50 rounded-xl p-4">
                            <h5 class="font-semibold text-gray-900 mb-3">Choose Payment Method:</h5>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                <button id="qr-payment-btn" class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg hover:border-emerald-300 hover:bg-emerald-50 transition-all">
                                    <div class="w-10 h-10 bg-emerald-100 rounded-lg flex items-center justify-center">
                                        <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-4v4m0-4H9m3 0h3m-3 0V9m0 0H9m3 0h3"></path>
                                        </svg>
                                    </div>
                                    <div class="text-left">
                                        <p class="font-medium text-gray-900">QR Code</p>
                                        <p class="text-sm text-gray-500">Scan to pay</p>
                                    </div>
                                </button>
                                <button id="online-payment-btn" class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg hover:border-blue-300 hover:bg-blue-50 transition-all">
                                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                                        </svg>
                                    </div>
                                    <div class="text-left">
                                        <p class="font-medium text-gray-900">Online Payment</p>
                                        <p class="text-sm text-gray-500">Pay online</p>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- QR Code Section -->
                    <div id="qr-section" class="hidden">
                        <div class="bg-gradient-to-r from-emerald-50 to-emerald-100 rounded-xl p-6 text-center">
                            <h5 class="font-semibold text-gray-900 mb-4">Scan QR Code to Pay</h5>
                            <div id="qr-code-container" class="flex justify-center mb-4">
                                <!-- QR Code will be generated here -->
                            </div>
                            <p class="text-sm text-gray-600 mb-4">Order ID: <span id="payment-order-id" class="font-mono font-bold"></span></p>
                            <div class="bg-white rounded-lg p-4 mb-4">
                                <p class="text-sm text-gray-600">Total Amount:</p>
                                <p id="payment-total" class="text-2xl font-bold text-emerald-600"></p>
                            </div>
                            <div class="bg-white rounded-lg p-4 mb-4">
                                <p class="text-sm text-gray-600 mb-2">After completing payment, your order status will be updated automatically.</p>
                                <p class="text-xs text-gray-500 mb-3">Please keep this page open until payment is confirmed.</p>
                                <button onclick="location.reload()" class="bg-blue-600 text-white py-2 px-4 rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors">
                                    Refresh to Check Payment Status
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-3 mt-6">
                        <button id="track-order-btn" class="flex-1 bg-gray-100 text-gray-700 py-3 px-6 rounded-lg font-semibold hover:bg-gray-200 transition-colors">
                            Track Order
                        </button>
                        <button id="close-payment-modal-btn" class="flex-1 bg-emerald-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-emerald-700 transition-colors">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Success Modal -->
    <div id="order-success-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl max-w-md w-full my-8">
                <!-- Modal Header -->
                <div class="bg-gradient-to-r from-emerald-600 to-emerald-700 px-6 py-4 rounded-t-2xl">
                    <div class="flex items-center justify-between">
                        <h3 class="text-xl font-bold text-white flex items-center gap-2">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Order Successful!
                        </h3>
                        <button id="close-success-modal" class="text-white hover:text-emerald-200 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Modal Content -->
                <div class="p-6 text-center">
                    <div class="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                    <h4 class="text-xl font-bold text-gray-900 mb-2">Order Placed Successfully!</h4>
                    <p id="success-message" class="text-gray-600 mb-6">Your order has been placed and is being processed.</p>
                    <div class="flex gap-3">
                        <button id="track-order-success-btn" class="flex-1 bg-emerald-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-emerald-700 transition-colors">
                            Track Order
                        </button>
                        <button id="close-success-modal-btn" class="flex-1 bg-gray-100 text-gray-700 py-3 px-6 rounded-lg font-semibold hover:bg-gray-200 transition-colors">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile bottom nav -->
    <nav class="fixed bottom-0 inset-x-0 md:hidden bg-white border-t shadow-lg">
        <div class="mx-auto container-max px-4 py-3 grid grid-cols-4 text-xs">
            <a href="../" class="flex flex-col items-center text-gray-600 gap-1">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                </svg>
                <span class="font-medium">Home</span>
            </a>
            <a href="../categories/" class="flex flex-col items-center text-gray-600 gap-1">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                </svg>
                <span class="font-medium">Categories</span>
            </a>
            <a href="../track/" class="flex flex-col items-center text-gray-600 gap-1">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                </svg>
                <span class="font-medium">Track</span>
            </a>
            <a href="../cart/" class="flex flex-col items-center text-emerald-700 gap-1 relative">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-2.5 5M7 13l2.5 5"></path>
                </svg>
                <span class="font-medium">Cart</span>
                <span id="bottom-cart-count" class="absolute -top-1 -right-1 inline-flex items-center justify-center w-5 h-5 rounded-full bg-emerald-600 text-white text-xs font-bold">0</span>
            </a>
        </div>
    </nav>

    <script src="../js/imageCache.js"></script>
    <script src="../js/loading.js"></script>
    <script type="module">
        import { PAYMENT_METHODS, formatCurrency, showError, showSuccess, getProfessionalErrorMessage, setButtonLoading, showLoadingModal, hideLoadingModal } from '../js/supabase-config.js';
        import { logout, onAuthStateChanged, fetchUserRole, fetchUserDoc, getUserIdFromUid } from '../js/supabase-auth.js';
        import { supabase } from '../js/supabase-auth.js';
        import { TABLES } from '../js/supabase-config.js';
        import { createOrder, addOrderItems, getAddressesByUser, addAddress } from '../js/supabase-database.js';

        const itemsEl = document.getElementById('cart-items');
        const totalEl = document.getElementById('total');
        const paymentMethodEl = document.getElementById('payment-method');
        const paymentUIEl = document.getElementById('payment-ui');
        const feedbackEl = document.getElementById('feedback');
        const errorMessageEl = document.getElementById('error-message');
        const customerNameEl = document.getElementById('customer-name');
        const customerPhoneEl = document.getElementById('customer-phone');
        const customerEmailEl = document.getElementById('customer-email');
        const addressSelectionEl = document.getElementById('address-selection');
        const addNewAddressBtn = document.getElementById('add-new-address-btn');
        const placeOrderBtn = document.getElementById('place-order');
        const codOption = document.getElementById('cod-option');
        const codDisabledNotice = document.getElementById('cod-disabled-notice');

        let selectedAddressId = null;
        let currentUserId = null;
        let userCodEnabled = false;

        // Validate stock availability for cart items
        async function validateCartStock(cart) {
            try {
                const outOfStockItems = [];
                const insufficientStockItems = [];

                for (const item of cart) {
                    // Skip items without product ID (fallback items)
                    if (!item.id) continue;

                    try {
                        const { data: product, error } = await supabase.from(TABLES.products).select('*').eq('id', item.id).single();

                        if (error || !product) {
                            outOfStockItems.push(item.name);
                            continue;
                        }

                        const availableStock = product.stock || 0;

                        if (availableStock === 0) {
                            outOfStockItems.push(item.name);
                        } else if (availableStock < item.quantity) {
                            insufficientStockItems.push(`${item.name} (available: ${availableStock}, requested: ${item.quantity})`);
                        }
                    } catch (error) {
                        console.error(`Error checking stock for ${item.name}:`, error);
                        // Assume item is unavailable if we can't check
                        outOfStockItems.push(item.name);
                    }
                }

                if (outOfStockItems.length > 0 || insufficientStockItems.length > 0) {
                    let message = 'Some items in your cart are no longer available:\n\n';

                    if (outOfStockItems.length > 0) {
                        message += `Out of stock: ${outOfStockItems.join(', ')}\n`;
                    }

                    if (insufficientStockItems.length > 0) {
                        message += `Insufficient stock: ${insufficientStockItems.join(', ')}\n`;
                    }

                    message += '\nPlease update your cart and try again.';

                    return {
                        valid: false,
                        message: message,
                        outOfStock: outOfStockItems,
                        insufficientStock: insufficientStockItems
                    };
                }

                return { valid: true };

            } catch (error) {
                console.error('Error validating cart stock:', error);
                return {
                    valid: false,
                    message: 'Unable to verify stock availability. Please try again later.'
                };
            }
        }

        // Load user data and check COD eligibility
        async function loadUserData(uid) {
            try {
                const { data: userDoc } = await supabase.from(TABLES.users).select('*').eq('uid', uid).single();
                if (userDoc) {
                    const userData = userDoc;
                    console.log('👤 User data loaded:', userData);
                    userCodEnabled = userData.codUnlocked || false;

                    // Update COD option visibility
                    if (userCodEnabled) {
                        codOption.style.display = 'block';
                        codDisabledNotice.classList.add('hidden');
                        // If COD is enabled and currently selected, make sure UI shows correct state
                        if (paymentMethodEl.value === 'COD') {
                            renderPaymentUI();
                        }
                    } else {
                        codOption.style.display = 'none';
                        codDisabledNotice.classList.remove('hidden');
                        // If COD was selected but now disabled, switch to Card
                        if (paymentMethodEl.value === 'COD') {
                            paymentMethodEl.value = 'Card';
                        }
                    }

                    // Always render payment UI after loading user data
                    renderPaymentUI();

                    // Auto-populate customer info from user profile
                    const { data: { user } } = await supabase.auth.getUser();
                    if (user && !customerNameEl.value) {
                        // Use name from users table, fallback to auth user metadata
                        customerNameEl.value = userData.name || user.user_metadata?.full_name || user.email?.split('@')[0] || '';
                    }
                    if (user && !customerEmailEl.value) {
                        customerEmailEl.value = user.email || '';
                    }
                    if (user && !customerPhoneEl.value) {
                        // Use phone from users table if available
                        customerPhoneEl.value = userData.phone || '';
                        console.log('📱 Phone prefilled:', userData.phone);
                    }

                    console.log('User COD enabled:', userCodEnabled);
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        async function loadAddresses() {
            if (!currentUserId) return;

            // Get database user ID
            const databaseUserId = await getUserIdFromUid(currentUserId);
            if (!databaseUserId) {
                console.error('Unable to get database user ID');
                return;
            }

            const { data: addresses, error } = await supabase
                .from(TABLES.addresses)
                .select('*')
                .eq('user_id', databaseUserId)
                .order('is_default', { ascending: false });

            if (error) {
                console.error('Error loading addresses:', error);
                return;
            }

            if (!addresses || addresses.length === 0) {
                addressSelectionEl.innerHTML = `
                    <div class="text-center py-4">
                        <p class="text-sm text-gray-500">No addresses found</p>
                        <p class="text-xs text-gray-400">Add an address to continue</p>
                    </div>
                `;
                return;
            }

            let html = '';
            let defaultAddressId = null;
            let defaultAddressesCount = 0;

            addresses.forEach(address => {
                const addressId = address.id;
                const isDefault = address.is_default;
                const isSelected = selectedAddressId === addressId;

                // Count default addresses and handle selection
                if (isDefault) {
                    defaultAddressesCount++;
                    // Only set as selected if it's the first default address encountered
                    if (!selectedAddressId) {
                        selectedAddressId = addressId;
                        defaultAddressId = addressId;
                    }
                }

                html += `
                    <div class="border rounded-lg p-3 cursor-pointer transition-colors ${isSelected ? 'border-emerald-500 bg-emerald-50' : 'border-gray-200 hover:border-emerald-300'}" onclick="selectAddress('${addressId}')">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <input type="radio" name="address" value="${addressId}" ${isSelected ? 'checked' : ''} class="text-emerald-600 focus:ring-emerald-500">
                                    <span class="font-medium text-sm">${address.name}</span>
                                    ${isDefault && defaultAddressesCount <= 1 ? '<span class="bg-emerald-100 text-emerald-800 text-xs px-2 py-0.5 rounded-full">Default</span>' : ''}
                                    ${isDefault && defaultAddressesCount > 1 ? '<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-0.5 rounded-full">Multiple Default</span>' : ''}
                                </div>
                                <p class="text-xs text-gray-600 ml-5">${address.address}</p>
                            </div>
                        </div>
                    </div>
                `;
            });

            addressSelectionEl.innerHTML = html;

            // Warn about multiple default addresses
            if (defaultAddressesCount > 1) {
                console.warn(`⚠️ User has ${defaultAddressesCount} default addresses. This should be fixed by the address saving logic.`);
                // You could also show a user warning here if needed
            }

            // Auto-select default address if none selected
            if (!selectedAddressId && defaultAddressId) {
                selectedAddressId = defaultAddressId;
                updateAddressSelection();
            }
        }

        function selectAddress(addressId) {
            selectedAddressId = addressId;
            updateAddressSelection();
            updateDeliveryFee(); // Update delivery fee when address changes
        }

        function updateAddressSelection() {
            const radios = document.querySelectorAll('input[name="address"]');
            radios.forEach(radio => {
                const container = radio.closest('.border');
                if (radio.value === selectedAddressId) {
                    radio.checked = true;
                    container.classList.add('border-emerald-500', 'bg-emerald-50');
                    container.classList.remove('border-gray-200');
                } else {
                    radio.checked = false;
                    container.classList.remove('border-emerald-500', 'bg-emerald-50');
                    container.classList.add('border-gray-200');
                }
            });
        }

        // Update cart count from localStorage
        function updateCartCount() {
            const cart = JSON.parse(localStorage.getItem("cart") || "[]");
            const count = cart.reduce((sum, i) => sum + i.quantity, 0);
            const el = document.getElementById("cart-count");
            const bottomEl = document.getElementById("bottom-cart-count");
            const mobileEl = document.getElementById("mobile-cart-count");
            if (el) el.textContent = String(count);
            if (bottomEl) bottomEl.textContent = String(count);
            if (mobileEl) mobileEl.textContent = String(count);
        }

        async function loadCart() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            let html = '';
            let total = 0;
            let hasStockIssues = false;

            // Check stock for each item
            for (const [idx, item] of cart.entries()) {
                let stockInfo = '';
                let itemClass = '';

                if (item.id) {
                    try {
                        const { data: product, error } = await supabase.from(TABLES.products).select('*').eq('id', item.id).single();

                        if (error || !product) {
                            stockInfo = '<span class="text-red-500 text-xs">Product not found</span>';
                            itemClass = 'opacity-60 bg-red-50 border-l-4 border-red-400';
                            hasStockIssues = true;
                        } else {
                            const availableStock = product.stock || 0;
                            const isDisabled = product.disabled === true;

                            if (isDisabled) {
                                stockInfo = '<span class="text-red-500 text-xs">Currently unavailable</span>';
                                itemClass = 'opacity-60 bg-red-50 border-l-4 border-red-400';
                                hasStockIssues = true;
                            } else if (availableStock === 0) {
                                stockInfo = '<span class="text-red-500 text-xs">Out of stock</span>';
                                itemClass = 'opacity-60 bg-red-50 border-l-4 border-red-400';
                                hasStockIssues = true;
                            } else if (availableStock < item.quantity) {
                                stockInfo = `<span class="text-yellow-600 text-xs">Only ${availableStock} available</span>`;
                                itemClass = 'border-l-4 border-yellow-400 bg-yellow-50';
                                hasStockIssues = true;
                            } else {
                                stockInfo = `<span class="text-green-600 text-xs">${availableStock} in stock</span>`;
                            }
                        }
                    } catch (error) {
                        console.error(`Error checking stock for ${item.name}:`, error);
                        stockInfo = '<span class="text-gray-500 text-xs">Stock info unavailable</span>';
                    }
                } else {
                    stockInfo = '<span class="text-gray-500 text-xs">Stock info unavailable</span>';
                }

                total += item.price * item.quantity;
                html += `
          <div class='py-3 flex gap-3 items-center ${itemClass}'>
            <img src='${item.imageURL}' class='w-16 h-16 rounded object-cover border' />
            <div class='flex-1'>
              <div class='font-medium'>${item.name}</div>
              <div class='text-sm text-gray-500'>Qty: ${item.quantity}</div>
              <div class='mt-1'>${stockInfo}</div>
            </div>
            <div class='font-medium'>
                ${item.discount > 0 ? `
                    <div class="text-right">
                        <div class="text-sm text-gray-500 line-through">${formatCurrency((item.originalPrice || item.price) * item.quantity)}</div>
                        <div>${formatCurrency(item.price * item.quantity)}</div>
                        <div class="text-xs text-red-600">${item.discount}% OFF</div>
                    </div>
                ` : `
                    ${formatCurrency(item.price * item.quantity)}
                `}
            </div>
            <button data-idx='${idx}' class='text-sm text-red-600 hover:text-red-700'>Remove</button>
          </div>`;
            }

            itemsEl.innerHTML = html || "<div class='py-6 text-gray-500'>Your cart is empty.</div>";
            totalEl.textContent = formatCurrency(total);
            updateDeliveryFee(); // Update delivery fee when cart changes

            // Show warning if there are stock issues
            if (hasStockIssues) {
                const warningDiv = document.createElement('div');
                warningDiv.className = 'mt-4 p-3 bg-red-50 border border-red-200 rounded-lg';
                warningDiv.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="text-red-600">🚫</span>
                        <span class="text-sm text-red-800">Some items in your cart are currently out of stock or unavailable. You cannot place this order until these items are restocked or removed from your cart.</span>
                    </div>
                `;
                itemsEl.appendChild(warningDiv);
            }
        }

        itemsEl.addEventListener('click', async (e) => {
            const btn = e.target.closest('button[data-idx]');
            if (!btn) return;
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            cart.splice(Number(btn.dataset.idx), 1);
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartCount();
            await loadCart();
        });

        function renderPaymentUI() {
            const method = paymentMethodEl.value;
            if (method === 'COD') {
                if (userCodEnabled) {
                    paymentUIEl.innerHTML = `<div class='p-3 rounded-lg bg-emerald-50 text-emerald-800'>Cash on Delivery selected. Pay to rider upon delivery.</div>`;
                } else {
                    paymentUIEl.innerHTML = `<div class='p-3 rounded-lg bg-red-50 text-red-800'>COD is not available for your account. Please select a different payment method.</div>`;
                }
            } else if (method === 'Card') {
                paymentUIEl.innerHTML = `
          <div class='p-3 rounded-lg border'>
            <div class='text-sm text-gray-600'>Card payment will be processed securely after order placement.</div>
            <div class='mt-2 text-xs text-blue-600'>You will be redirected to a secure payment page.</div>
          </div>`;
            } else if (method === 'GCash' || method === 'PayMaya') {
                paymentUIEl.innerHTML = `
          <div class='p-3 rounded-lg border'>
            <div class='text-sm text-gray-600'>${method} payment will be processed after order placement.</div>
            <div class='mt-2 text-xs text-blue-600'>You will be redirected to a secure payment page with QR code.</div>
          </div>`;
            }
        }

        paymentMethodEl.addEventListener('change', renderPaymentUI);



        function hideMessages() {
            feedbackEl.classList.add('hidden');
            errorMessageEl.classList.add('hidden');
        }

        // Delivery validation for Rizal province and Antipolo city only
        function validateDeliveryArea(address) {
            const supportedAreas = [
                'Rizal',
                'Antipolo'
            ];

            const addressText = address.address || '';

            // Check if address contains supported areas
            const isSupported = supportedAreas.some(area =>
                addressText.toLowerCase().includes(area.toLowerCase())
            );

            return {
                valid: isSupported,
                message: isSupported ? '' : 'Sorry, delivery is not available in your area. We currently deliver to Rizal province and Antipolo city only.'
            };
        }

        // Calculate delivery fee based on location
        function calculateDeliveryFee(address, orderTotal) {
            if (!address) return 0;

            const addressText = address.address || '';

            // Free delivery for orders >= ₱500
            if (orderTotal >= 500) {
                return 0;
            }

            // Base delivery fee
            let deliveryFee = 50;

            // Adjust fee based on location
            if (addressText.toLowerCase().includes('antipolo')) {
                deliveryFee = 50;
            } else if (addressText.toLowerCase().includes('rizal')) {
                deliveryFee = 60;
            } else {
                deliveryFee = 70; // Default for other Rizal areas
            }

            return deliveryFee;
        }

        // Calculate cart total
        function calculateTotal() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            return cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        }

        // Update delivery fee display
        function updateDeliveryFee() {
            if (!selectedAddressId) {
                document.getElementById('delivery-fee').textContent = '₱0.00';
                document.getElementById('grand-total').textContent = formatCurrency(calculateTotal());
                return;
            }

            // Get address details
            supabase.from(TABLES.addresses).select('*').eq('id', selectedAddressId).single().then(({ data: address, error }) => {
                if (!error && address) {
                    const orderTotal = calculateTotal();
                    const deliveryFee = calculateDeliveryFee(address, orderTotal);
                    const grandTotal = orderTotal + deliveryFee;

                    document.getElementById('delivery-fee').textContent = formatCurrency(deliveryFee);
                    document.getElementById('grand-total').textContent = formatCurrency(grandTotal);
                }
            });
        }

        async function placeOrder() {
            console.log('🚀 placeOrder function called!');
            hideMessages();
            
            // Hide any previous error messages
            const errorElement = document.getElementById('error-message');
            if (errorElement) {
                errorElement.classList.add('hidden');
            }

            // Get cart data early for validation
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');

            // Validate customer information
            const customerName = customerNameEl.value.trim();
            const customerPhone = customerPhoneEl.value.trim();
            const customerEmail = customerEmailEl.value.trim();

            if (!customerName) {
                console.log('Customer name validation failed');
                const errorElement = document.getElementById('error-message');
                if (errorElement) {
                    errorElement.textContent = 'Please enter your full name';
                    errorElement.classList.remove('hidden');
                } else {
                    alert('Please enter your full name');
                }
                customerNameEl.focus();
                return;
            }

            if (!customerPhone) {
                console.log('Customer phone validation failed');
                const errorElement = document.getElementById('error-message');
                if (errorElement) {
                    errorElement.textContent = 'Please enter your phone number';
                    errorElement.classList.remove('hidden');
                } else {
                    alert('Please enter your phone number');
                }
                customerPhoneEl.focus();
                return;
            }

            if (!customerEmail) {
                console.log('Customer email validation failed');
                const errorElement = document.getElementById('error-message');
                if (errorElement) {
                    errorElement.textContent = 'Please enter your email address';
                    errorElement.classList.remove('hidden');
                } else {
                    alert('Please enter your email address');
                }
                customerEmailEl.focus();
                return;
            }

            if (!selectedAddressId) {
                console.log('No address selected');
                const errorElement = document.getElementById('error-message');
                if (errorElement) {
                    errorElement.textContent = 'Please select a delivery address';
                    errorElement.classList.remove('hidden');
                } else {
                    alert('Please select a delivery address');
                }
                return;
            }

            // Validate COD eligibility
            const paymentMethod = paymentMethodEl.value;
            if (paymentMethod === 'COD' && !userCodEnabled) {
                console.log('COD not enabled for user');
                const errorElement = document.getElementById('error-message');
                if (errorElement) {
                    errorElement.textContent = 'COD (Cash on Delivery) is not available for your account. Please select a different payment method.';
                    errorElement.classList.remove('hidden');
                } else {
                    alert('COD (Cash on Delivery) is not available for your account. Please select a different payment method.');
                }
                paymentMethodEl.focus();
                return;
            }

            // Validate stock availability for all cart items (block orders with out-of-stock items)
            const stockValidationResult = await validateCartStock(cart);
            if (!stockValidationResult.valid) {
                console.log('Stock validation failed:', stockValidationResult.message);
                const errorElement = document.getElementById('error-message');
                if (errorElement) {
                    errorElement.textContent = stockValidationResult.message + '\n\nPlease remove out-of-stock items from your cart or wait for them to be restocked.';
                    errorElement.classList.remove('hidden');
                } else {
                    alert(stockValidationResult.message + '\n\nPlease remove out-of-stock items from your cart or wait for them to be restocked.');
                }
                // Refresh cart to show updated stock info
                await loadCart();
                return;
            }

            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                window.location.href = '../login/';
                return;
            }

            if (!cart.length) {
                console.log('Cart is empty');
                const errorElement = document.getElementById('error-message');
                if (errorElement) {
                    errorElement.textContent = 'Your cart is empty';
                    errorElement.classList.remove('hidden');
                } else {
                    alert('Your cart is empty');
                }
                return;
            }

            try {
                setButtonLoading(placeOrderBtn, true, 'Placing Order...');

                // Get selected address details
                const { data: address, error: addressError } = await supabase
                    .from(TABLES.addresses)
                    .select('*')
                    .eq('id', selectedAddressId)
                    .single();

                if (addressError || !address) {

                    console.log('Address not found:', addressError);
                    const errorElement = document.getElementById('error-message');
                    if (errorElement) {
                        errorElement.textContent = 'Selected address not found. Please select another address.';
                        errorElement.classList.remove('hidden');
                    } else {
                        alert('Selected address not found. Please select another address.');
                    }
                    return;
                }

                // Validate delivery area
                const deliveryValidation = validateDeliveryArea(address);
                if (!deliveryValidation.valid) {
                    console.log('Delivery validation failed:', deliveryValidation.message);
                    const errorElement = document.getElementById('error-message');
                    if (errorElement) {
                        errorElement.textContent = deliveryValidation.message;
                        errorElement.classList.remove('hidden');
                    } else {
                        alert(deliveryValidation.message);
                    }
                    return;
                }

                // Use the full address string from database
                const deliveryAddress = address.address;

                const total = cart.reduce((s, i) => s + i.price * i.quantity, 0);
                const deliveryFee = calculateDeliveryFee(address, total);
                const grandTotal = total + deliveryFee;
                const paymentMethod = paymentMethodEl.value;
                const paymentInfo = paymentMethod === 'COD' ? 'Pay upon delivery' : 'Pending confirmation';

                // Get database user ID
                console.log('Getting database user ID for:', user.id);
                const databaseUserId = await getUserIdFromUid(user.id);
                console.log('Database user ID result:', databaseUserId);
                if (!databaseUserId) {
                    console.error('Failed to get database user ID');
                    const errorElement = document.getElementById('error-message');
                    if (errorElement) {
                        errorElement.textContent = 'Unable to verify user account. Please try logging in again.';
                        errorElement.classList.remove('hidden');
                    } else {
                        alert('Unable to verify user account. Please try logging in again.');
                    }
                    return;
                }

                // Ensure cart items have productId field for proper stock management
                const orderItems = cart.map(item => ({
                    ...item,
                    productId: item.id // Add productId field for pharmacy order processing
                }));

                // Create order data that matches the exact database schema
                const order = {
                    user_id: databaseUserId,
                    total: parseFloat(total.toFixed(2)),
                    delivery_fee: parseFloat(deliveryFee.toFixed(2)),
                    grand_total: parseFloat(grandTotal.toFixed(2)),
                    payment_method: paymentMethod, // This might need to be a specific enum value
                    payment_status: 'Pending',
                    payment_info: paymentInfo,
                    cod: paymentMethod === 'COD',
                    stage: 'Pending',
                    delivery_address: deliveryAddress,
                    customer_name: customerName,
                    customer_phone: customerPhone,
                    customer_email: customerEmail
                };

                console.log('=== ORDER DATA BEING INSERTED ===');
                console.log('Order object:', order);
                console.log('Database user ID:', databaseUserId);
                console.log('Payment method:', paymentMethod);
                console.log('================================');

                console.log('About to insert order...');
                const { data: orderRef, error: orderError } = await supabase.from(TABLES.orders).insert(order).select().single();
                console.log('Order insertion result:', { orderRef, orderError });
                
                if (orderError) {
                    console.error('Order insertion error:', orderError);
                    throw orderError;
                }
                
                const orderId = orderRef.id;
                console.log('Order created successfully with ID:', orderId);

                // Insert order items into order_items table
                console.log('Inserting order items...');
                const orderItemsForDB = cart.map(item => ({
                    order_id: orderId,
                    product_id: item.id,
                    product_name: item.name,
                    price: parseFloat(item.price),
                    quantity: parseInt(item.quantity),
                    subtotal: parseFloat((item.price * item.quantity).toFixed(2))
                }));

                console.log('Order items to insert:', orderItemsForDB);

                const { data: orderItemsData, error: orderItemsError } = await supabase
                    .from(TABLES.order_items)
                    .insert(orderItemsForDB)
                    .select();

                if (orderItemsError) {
                    console.error('Error inserting order items:', orderItemsError);
                    // Don't throw error - order was created successfully
                } else {
                    console.log('Order items inserted successfully:', orderItemsData);
                }

                // Clear cart for all payment methods
                localStorage.removeItem('cart');
                updateCartCount();
                await loadCart();

                // Handle different payment methods
                if (paymentMethod === 'COD') {
                    showOrderSuccessModal('Order placed successfully! You can track it in Track Order.', orderId);
                } else {
                    // For Card/GCash/PayMaya, show payment modal with QR code
                    showPaymentModal(orderId, order);
                }

                // Clear form
                customerNameEl.value = '';
                customerPhoneEl.value = '';
                customerEmailEl.value = '';

            } catch (error) {
                console.error('=== ORDER PLACEMENT ERROR ===');
                console.error('Error details:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                console.error('User authenticated:', user ? 'YES' : 'NO');
                console.error('User UID:', user?.id);
                console.error('Database user ID:', databaseUserId);
                console.error('Order data:', order);
                console.error('========================');

                // Show specific error message based on error type
                let errorMessage = 'An unexpected error occurred. Please try again.1';
                
                if (error.code === '23503') {
                    errorMessage = 'Database error: Invalid user or address reference. Please try logging in again.';
                } else if (error.code === '23505') {
                    errorMessage = 'Order already exists. Please refresh the page and try again.';
                } else if (error.code === 'PGRST301') {
                    errorMessage = 'Permission denied. Please check your authentication.';
                } else if (error.code === 'PGRST116') {
                    errorMessage = 'Database error: Required data not found. Please refresh and try again.';
                } else if (error.code === '42704') {
                    errorMessage = 'Database error: Invalid enum value. Please try a different payment method.';
                } else if (error.message) {
                    errorMessage = `Error: ${error.message}`;
                }

                console.error('Final error message:', errorMessage);
                console.error('Error element found:', !!document.getElementById('error-message'));
                console.error('Document ready state:', document.readyState);
                console.error('All elements with error in id:', document.querySelectorAll('[id*="error"]'));
                
                // Display error directly instead of using showError which calls getProfessionalErrorMessage
                const errorElement = document.getElementById('error-message');
                if (errorElement) {
                    console.log('Using error element to display message');
                    errorElement.textContent = errorMessage;
                    errorElement.classList.remove('hidden');
                } else {
                    console.log('Error element not found, using alert');
                    alert(`DEBUG: ${errorMessage}`);
                }
            } finally {
                setButtonLoading(placeOrderBtn, false);
            }
        }

        // Add address modal functionality
        const citiesByProvince = {
            'Metro Manila': ['Manila', 'Quezon City', 'Caloocan', 'Las Piñas', 'Makati', 'Malabon', 'Mandaluyong', 'Marikina', 'Muntinlupa', 'Navotas', 'Parañaque', 'Pasay', 'Pasig', 'Pateros', 'San Juan', 'Taguig', 'Valenzuela'],
            'Cavite': ['Bacoor', 'Cavite City', 'Dasmariñas', 'Imus', 'Kawit', 'Noveleta', 'Rosario', 'Silang', 'Tanza', 'Trece Martires City'],
            'Laguna': ['Biñan', 'Cabuyao', 'Calamba', 'San Pablo', 'Santa Rosa', 'Alaminos', 'Bay', 'Calauan', 'Cavinti', 'Famy', 'Kalayaan', 'Liliw', 'Los Baños', 'Luisiana', 'Lumban', 'Mabitac', 'Magdalena', 'Majayjay', 'Nagcarlan', 'Paete', 'Pagsanjan', 'Pakil', 'Pangil', 'Pila', 'Rizal', 'San Pedro', 'Siniloan', 'Victoria'],
            'Batangas': ['Batangas City', 'Lipa', 'Tanauan', 'Bauan', 'Calaca', 'Calatagan', 'Cuenca', 'Ibaan', 'Laurel', 'Lemery', 'Lian', 'Lobo', 'Mabini', 'Malvar', 'Mataasnakahoy', 'Nasugbu', 'Padre Garcia', 'Rosario', 'San Jose', 'San Juan', 'San Luis', 'San Nicolas', 'Santo Tomas', 'Taal', 'Talisay', 'Taysan', 'Tingloy', 'Tuy'],
            'Rizal': ['Antipolo', 'Angono', 'Baras', 'Binangonan', 'Cainta', 'Cardona', 'Jalajala', 'Morong', 'Pililla', 'Rodriguez', 'San Mateo', 'Tanay', 'Taytay', 'Teresa'],
            'Quezon': ['Lucena', 'Tayabas', 'Alabat', 'Atimonan', 'Buenavista', 'Burdeos', 'Calauag', 'Candelaria', 'Catanauan', 'Dolores', 'General Luna', 'General Nakar', 'Guinayangan', 'Gumaca', 'Infanta', 'Jomalig', 'Lopez', 'Lucban', 'Macalelon', 'Mauban', 'Mulanay', 'Padre Burgos', 'Pagbilao', 'Panukulan', 'Patnanungan', 'Perez', 'Pitogo', 'Plaridel', 'Polillo', 'Quezon', 'Real', 'Sampaloc', 'San Andres', 'San Antonio', 'San Francisco', 'San Narciso', 'Sariaya', 'Tagkawayan', 'Tiaong', 'Unisan'],
            'Bulacan': ['Malolos', 'Meycauayan', 'San Jose del Monte', 'Baliuag', 'Bocaue', 'Calumpit', 'Doña Remedios Trinidad', 'Guiguinto', 'Hagonoy', 'Marilao', 'Norzagaray', 'Obando', 'Pandi', 'Paombong', 'Plaridel', 'Pulilan', 'San Ildefonso', 'San Miguel', 'San Rafael', 'Santa Maria'],
            'Pampanga': ['Angeles', 'San Fernando', 'Apalit', 'Arayat', 'Bacolor', 'Candaba', 'Floridablanca', 'Guagua', 'Lubao', 'Mabalacat', 'Macabebe', 'Magalang', 'Masantol', 'Mexico', 'Minalin', 'Porac', 'San Luis', 'San Simon', 'Santa Ana', 'Santa Rita', 'Santo Tomas', 'Sasmuan'],
            'Tarlac': ['Tarlac City', 'Anao', 'Bamban', 'Camiling', 'Capas', 'Concepcion', 'Gerona', 'La Paz', 'Mayantoc', 'Moncada', 'Paniqui', 'Pura', 'Ramos', 'San Clemente', 'San Jose', 'San Manuel', 'Santa Ignacia', 'Victoria'],
            'Nueva Ecija': ['Cabanatuan', 'Gapan', 'San Jose', 'Aliaga', 'Bongabon', 'Cabiao', 'Carranglan', 'Cuyapo', 'Gabaldon', 'General Mamerto Natividad', 'General Tinio', 'Guimba', 'Jaen', 'Laur', 'Llanera', 'Lupao', 'Muñoz', 'Nampicuan', 'Palayan', 'Pantabangan', 'Peñaranda', 'Quezon', 'Rizal', 'San Antonio', 'San Isidro', 'San Leonardo', 'Santa Rosa', 'Santo Domingo', 'Talavera', 'Talugtug', 'Zaragoza']
        };

        // Address modal functionality
        let addressModal = null;

        function showAddressModal() {
            if (addressModal) return;

            addressModal = document.createElement('div');
            addressModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            addressModal.innerHTML = `
                <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="p-6 border-b">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold">Add New Address</h3>
                            <button onclick="closeAddressModal()" class="text-gray-400 hover:text-gray-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <form id="quick-address-form" class="p-6">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Province</label>
                                <select id="modal-province" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500" required>
                                    <option value="">Select Province</option>
                                    <option value="Metro Manila">Metro Manila</option>
                                    <option value="Cavite">Cavite</option>
                                    <option value="Laguna">Laguna</option>
                                    <option value="Batangas">Batangas</option>
                                    <option value="Rizal">Rizal</option>
                                    <option value="Quezon">Quezon</option>
                                    <option value="Bulacan">Bulacan</option>
                                    <option value="Pampanga">Pampanga</option>
                                    <option value="Tarlac">Tarlac</option>
                                    <option value="Nueva Ecija">Nueva Ecija</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">City/Municipality</label>
                                <select id="modal-city" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500" required>
                                    <option value="">Select City/Municipality</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Barangay</label>
                                    <input type="text" id="modal-barangay" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="Enter barangay" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Postal Code</label>
                                    <input type="text" id="modal-postal-code" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="1234" required>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">House/Unit No. & Street</label>
                                <input type="text" id="modal-street" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="123 Main Street" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Landmark/Notes (Optional)</label>
                                <textarea id="modal-landmark" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500" rows="2" placeholder="Near the church, beside the school, etc."></textarea>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" onclick="closeAddressModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                            <button type="submit" class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">Save Address</button>
                        </div>
                    </form>
                </div>
            `;

            document.body.appendChild(addressModal);

            // Province change handler
            const provinceSelect = addressModal.querySelector('#modal-province');
            const citySelect = addressModal.querySelector('#modal-city');

            provinceSelect.addEventListener('change', (e) => {
                const selectedProvince = e.target.value;
                citySelect.innerHTML = '<option value="">Select City/Municipality</option>';

                if (citiesByProvince[selectedProvince]) {
                    citiesByProvince[selectedProvince].forEach(city => {
                        const option = document.createElement('option');
                        option.value = city;
                        option.textContent = city;
                        citySelect.appendChild(option);
                    });
                }
            });

            // Form submission
            const form = addressModal.querySelector('#quick-address-form');
            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                // Validate user authentication
                if (!currentUserId) {
                    showError('Please log in to save addresses.');
                    closeAddressModal();
                    return;
                }

                // Get database user ID from auth UID
                const databaseUserId = await getUserIdFromUid(currentUserId);
                if (!databaseUserId) {
                    showError('Unable to verify user account. Please try logging in again.');
                    closeAddressModal();
                    return;
                }

                // Build full address string to match database schema
                const houseNumber = addressModal.querySelector('#modal-street').value.split(' ')[0] || '';
                const street = addressModal.querySelector('#modal-street').value;
                const barangay = addressModal.querySelector('#modal-barangay').value;
                const city = citySelect.value;
                const province = provinceSelect.value;
                const postalCode = addressModal.querySelector('#modal-postal-code').value;
                const landmark = addressModal.querySelector('#modal-landmark').value;
                
                // Concatenate address components into a single address field
                let fullAddress = `${houseNumber} ${street}`.trim();
                if (barangay) fullAddress += `, ${barangay}`;
                if (city) fullAddress += `, ${city}`;
                if (province) fullAddress += `, ${province}`;
                if (postalCode) fullAddress += ` ${postalCode}`;
                if (landmark) fullAddress += ` (Landmark: ${landmark})`;

                const formData = {
                    user_id: databaseUserId,
                    name: 'Home', // Default address name
                    address: fullAddress,
                    is_default: false
                };

                try {
                    await supabase.from(TABLES.addresses).insert(formData);

                    closeAddressModal();
                    await loadAddresses();

                    // Show success message
                    showSuccessMessage('Address added successfully!');

                } catch (error) {
                    console.error('Error saving address:', error);

                    // Show professional error message
                    showError(getProfessionalErrorMessage(error));
                }
            });
        }

        function closeAddressModal() {
            if (addressModal) {
                addressModal.remove();
                addressModal = null;
            }
        }

        // Helper function to show success messages
        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            successDiv.textContent = message;
            document.body.appendChild(successDiv);

            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        // Quick test for order permissions
        window.quickOrderTest = async () => {
            console.log('🚀 QUICK ORDER TEST');
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    console.log('❌ Not logged in');
                    return;
                }

                const testOrder = {
                    userId: user.id,
                    test: 'quick test',
                    createdAt: Date.now()
                };

                console.log('📝 Creating test order...');
                const { data: testOrderData, error: createError } = await supabase
                    .from(TABLES.orders)
                    .insert(testOrder)
                    .select()
                    .single();

                if (createError) {
                    console.error('❌ Test order creation failed:', createError);
                    return;
                }

                console.log('✅ Test order created successfully!');
                
                // Clean up test order
                const { error: deleteError } = await supabase
                    .from(TABLES.orders)
                    .delete()
                    .eq('id', testOrderData.id);
                
                if (deleteError) {
                    console.error('❌ Test cleanup failed:', deleteError);
                } else {
                    console.log('🧹 Test cleaned up');
                }

            } catch (error) {
                console.error('❌ Quick test failed:', error.code);
                if (error.code === 'permission-denied') {
                    console.log('🔧 Deploy firestore.rules to Firebase Console');
                }
            }
        };

        // Test function for debugging order permissions
        window.testOrderPermissions = async () => {
            console.log('=== ORDER PERMISSIONS TEST ===');
            try {
                const { data: { user } } = await supabase.auth.getUser();
                console.log('User authenticated:', user ? 'YES' : 'NO');

                if (!user) {
                    console.log('❌ No user authenticated');
                    return;
                }

                // Test data for order
                const testOrder = {
                    userId: user.id,
                    customerInfo: {
                        name: 'Test User',
                        phone: '09123456789',
                        email: 'test@example.com'
                    },
                    deliveryAddress: 'Test Address',
                    items: [{ name: 'Test Item', price: 100, quantity: 1 }],
                    total: 100,
                    paymentMethod: 'COD',
                    paymentStatus: 'Pending',
                    stage: 'Pending',
                    createdAt: Date.now()
                };

                console.log('Testing order creation...');
                const { data: testOrderData, error: createError } = await supabase
                    .from(TABLES.orders)
                    .insert(testOrder)
                    .select()
                    .single();

                if (createError) {
                    console.error('❌ Test order creation failed:', createError);
                    return;
                }

                console.log('✅ Order creation test successful!');

                // Clean up test order
                const { error: deleteError } = await supabase
                    .from(TABLES.orders)
                    .delete()
                    .eq('id', testOrderData.id);
                
                if (deleteError) {
                    console.error('❌ Test cleanup failed:', deleteError);
                } else {
                    console.log('✅ Test cleanup successful');
                }

                console.log('🎉 ORDER PERMISSIONS WORKING!');

            } catch (error) {
                console.error('❌ ORDER TEST FAILED:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);

                if (error.code === 'permission-denied') {
                    console.log('🔧 SOLUTION: Update Firebase security rules for orders collection');
                    console.log('   Copy the rules from firestore.rules to Firebase Console');
                }
            }
            console.log('================================');
        };

        // Global functions
        window.selectAddress = selectAddress;
        window.showAddressModal = showAddressModal;
        window.closeAddressModal = closeAddressModal;
        window.testOrderPermissions = testOrderPermissions;
        window.quickOrderTest = quickOrderTest;
        
        // Test order creation function for debugging
        window.testOrderCreation = async () => {
            console.log('=== TESTING ORDER CREATION ===');
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    console.error('No user authenticated');
                    return;
                }

                const databaseUserId = await getUserIdFromUid(user.id);
                if (!databaseUserId) {
                    console.error('Could not get database user ID');
                    return;
                }

                console.log('User ID (auth):', user.id);
                console.log('Database user ID:', databaseUserId);

                const testOrder = {
                    user_id: databaseUserId,
                    total: 100.00,
                    delivery_fee: 50.00,
                    grand_total: 150.00,
                    payment_method: 'COD',
                    payment_status: 'Pending',
                    payment_info: 'Test payment info',
                    cod: true,
                    stage: 'Pending',
                    delivery_address: 'Test Address, Test City, Test Province',
                    customer_name: 'Test User',
                    customer_phone: '09123456789',
                    customer_email: 'test@example.com'
                };

                console.log('Test order data:', testOrder);

                const { data: orderRef, error: orderError } = await supabase
                    .from(TABLES.orders)
                    .insert(testOrder)
                    .select()
                    .single();

                if (orderError) {
                    console.error('❌ Order creation failed:', orderError);
                    console.error('Error code:', orderError.code);
                    console.error('Error message:', orderError.message);
                    console.error('Error details:', orderError.details);
                } else {
                    console.log('✅ Order creation successful:', orderRef);
                    
                    // Clean up test order
                    const { error: deleteError } = await supabase
                        .from(TABLES.orders)
                        .delete()
                        .eq('id', orderRef.id);
                    
                    if (deleteError) {
                        console.error('Failed to delete test order:', deleteError);
                    } else {
                        console.log('✅ Test order cleaned up');
                    }
                }

            } catch (error) {
                console.error('❌ Test failed:', error);
            }
            console.log('=============================');
        };

        // Function to check database schema and enum values
        window.checkDatabaseSchema = async () => {
            console.log('=== CHECKING DATABASE SCHEMA ===');
            try {
                // Try to get the orders table structure
                const { data, error } = await supabase
                    .from('information_schema.columns')
                    .select('column_name, data_type, is_nullable, column_default')
                    .eq('table_name', 'orders')
                    .eq('table_schema', 'public');

                if (error) {
                    console.error('Error getting schema:', error);
                    return;
                }

                console.log('Orders table columns:', data);

                // Try to get enum values for payment_method, payment_status, and stage
                const enumQueries = [
                    supabase.rpc('get_enum_values', { enum_name: 'payment_method' }),
                    supabase.rpc('get_enum_values', { enum_name: 'payment_status' }),
                    supabase.rpc('get_enum_values', { enum_name: 'order_stage' })
                ];

                for (const query of enumQueries) {
                    try {
                        const { data: enumData, error: enumError } = await query;
                        if (!enumError && enumData) {
                            console.log('Enum values:', enumData);
                        }
                    } catch (e) {
                        console.log('Could not get enum values (this is normal if they dont exist)');
                    }
                }

            } catch (error) {
                console.error('Schema check failed:', error);
            }
            console.log('==============================');
        };

        // Simple order test with minimal data
        window.testSimpleOrder = async () => {
            console.log('=== TESTING SIMPLE ORDER ===');
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    console.error('No user authenticated');
                    return;
                }

                const databaseUserId = await getUserIdFromUid(user.id);
                if (!databaseUserId) {
                    console.error('Could not get database user ID');
                    return;
                }

                // Minimal order with only required fields
                const simpleOrder = {
                    user_id: databaseUserId,
                    total: 100.00,
                    grand_total: 100.00,
                    payment_method: 'COD',
                    delivery_address: 'Test Address',
                    customer_name: 'Test User'
                };

                console.log('Simple order data:', simpleOrder);

                const { data: orderRef, error: orderError } = await supabase
                    .from(TABLES.orders)
                    .insert(simpleOrder)
                    .select()
                    .single();

                if (orderError) {
                    console.error('❌ Simple order failed:', orderError);
                    console.error('Error code:', orderError.code);
                    console.error('Error message:', orderError.message);
                    console.error('Error details:', orderError.details);
                    console.error('Error hint:', orderError.hint);
                } else {
                    console.log('✅ Simple order successful:', orderRef);
                    
                    // Clean up
                    await supabase.from(TABLES.orders).delete().eq('id', orderRef.id);
                    console.log('✅ Test order cleaned up');
                }

            } catch (error) {
                console.error('❌ Simple test failed:', error);
            }
            console.log('============================');
        };

        // Global error handler to catch any unhandled errors
        window.addEventListener('error', (event) => {
            console.error('Global error caught:', event.error);
            console.error('Error message:', event.message);
            console.error('Error filename:', event.filename);
            console.error('Error line:', event.lineno);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
        });

        // Event listeners
        addNewAddressBtn.addEventListener('click', showAddressModal);
        
        console.log('Place order button found:', !!placeOrderBtn);
        placeOrderBtn.addEventListener('click', (e) => {
            console.log('Place order button clicked!', e);
            e.preventDefault();
            e.stopPropagation();
            placeOrder();
        });


        onAuthStateChanged(async (user) => {
            if (!user) {
                // Show loading message before redirect
                showLoadingModal('Please log in to access your cart');
                setTimeout(() => {
                    window.location.href = '../login/';
                }, 1500);
                return;
            }

            currentUserId = user.id;
            await loadUserData(user.id);  // Load user data including COD status
            await loadAddresses();
            await loadCart(); // Load cart with stock validation
        });

        // Reload addresses when page becomes visible (e.g., navigating back from addresses page)
        document.addEventListener('visibilitychange', async () => {
            if (!document.hidden && currentUserId) {
                console.log('Page became visible, reloading addresses...');
                await loadAddresses();
            }
        });

        // Also reload addresses when window gains focus
        window.addEventListener('focus', async () => {
            if (currentUserId) {
                console.log('Window focused, reloading addresses...');
                await loadAddresses();
            }
        });

        renderPaymentUI();
        
        // Mobile menu functionality
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');
        const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');
        const mobileMenuClose = document.getElementById('mobile-menu-close');
        const mobileAccountSection = document.getElementById('mobile-account-section');
        const mobileLoginSection = document.getElementById('mobile-login-section');
        const mobileAccountName = document.getElementById('mobile-account-name');
        const mobileAccountEmail = document.getElementById('mobile-account-email');
        const mobileDashboardLink = document.getElementById('mobile-dashboard-link');
        const mobileLogoutBtn = document.getElementById('mobile-logout-btn');
        const mobileCartCount = document.getElementById('mobile-cart-count');
        
        // Force logout button to be visible
        if (mobileLogoutBtn) {
            mobileLogoutBtn.classList.remove('hidden');
            mobileLogoutBtn.style.display = 'flex';
            console.log('Logout button forced to be visible on page load');
        }
        
        if (mobileMenuBtn && mobileMenu) {
            // Update mobile cart count
            if (mobileCartCount) {
                mobileCartCount.textContent = String(JSON.parse(localStorage.getItem("cart") || "[]").reduce((sum, i) => sum + i.quantity, 0));
            }
            
            // Mobile menu toggle
            mobileMenuBtn.onclick = (e) => {
                e.stopPropagation();
                mobileMenu.classList.remove('hidden');
                mobileMenuOverlay.classList.remove('hidden');
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
            };
            
            // Mobile menu close
            const closeMobileMenu = () => {
                mobileMenu.classList.add('hidden');
                mobileMenuOverlay.classList.add('hidden');
                document.body.style.overflow = ''; // Restore scrolling
            };
            
            if (mobileMenuClose) {
                mobileMenuClose.onclick = (e) => {
                    e.stopPropagation();
                    closeMobileMenu();
                };
            }
            
            // Close on overlay click
            if (mobileMenuOverlay) {
                mobileMenuOverlay.onclick = (e) => {
                    e.stopPropagation();
                    closeMobileMenu();
                };
            }
            
            // Mobile logout
            if (mobileLogoutBtn) {
                mobileLogoutBtn.onclick = async () => { 
                    await logout(); 
                };
            }
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (mobileMenuBtn && mobileMenu && !mobileMenuBtn.contains(e.target) && !mobileMenu.contains(e.target)) {
                    closeMobileMenu();
                }
            });
            
        // Update mobile menu content based on auth state
        function updateMobileMenuContent(user, role) {
            const mobileAddressLink = document.getElementById('mobile-address-link');
            
            if (user) {
                // Show account section, hide login section
                if (mobileAccountSection) mobileAccountSection.classList.remove('hidden');
                if (mobileLoginSection) mobileLoginSection.classList.add('hidden');
                if (mobileDashboardLink) mobileDashboardLink.classList.remove('hidden');
                if (mobileLogoutBtn) mobileLogoutBtn.classList.remove('hidden');
                if (mobileAddressLink) mobileAddressLink.classList.remove('hidden');
                
                // Update mobile account info
                if (mobileAccountName) mobileAccountName.textContent = user?.displayName || 'Account';
                if (mobileAccountEmail) mobileAccountEmail.textContent = user?.email || '';
                if (mobileDashboardLink) mobileDashboardLink.href = role === 'admin' ? '../admin/' : role === 'pharmacy' ? '../pharmacy/' : '../user-dashboard/';
            } else {
                // Show login section, hide account section
                if (mobileAccountSection) mobileAccountSection.classList.add('hidden');
                if (mobileLoginSection) mobileLoginSection.classList.remove('hidden');
                if (mobileDashboardLink) mobileDashboardLink.classList.add('hidden');
                if (mobileLogoutBtn) mobileLogoutBtn.classList.add('hidden');
                if (mobileAddressLink) mobileAddressLink.classList.add('hidden');
            }
            
            // Always ensure logout button is visible for logged-in users
            if (user && mobileLogoutBtn) {
                mobileLogoutBtn.classList.remove('hidden');
            }
        }
            
            // Listen for auth state changes to update mobile menu content
            onAuthStateChanged(async (user) => {
                const role = localStorage.getItem('role') || await fetchUserRole(user?.id);
                updateMobileMenuContent(user, role);
            });
        }

        // Payment Modal Functions
        function showPaymentModal(orderId, order) {
            const modal = document.getElementById('payment-modal');
            const orderIdEl = document.getElementById('payment-order-id');
            const totalEl = document.getElementById('payment-total');
            
            // Store full order ID in data attribute and show last 6 characters
            orderIdEl.setAttribute('data-full-id', orderId);
            orderIdEl.textContent = orderId.slice(-6);
            totalEl.textContent = `₱${order.total.toFixed(2)}`;
            
            modal.classList.remove('hidden');
        }

        function showOrderSuccessModal(message, orderId) {
            const modal = document.getElementById('order-success-modal');
            const messageEl = document.getElementById('success-message');
            
            messageEl.textContent = message;
            modal.classList.remove('hidden');
        }

        function hidePaymentModal() {
            const modal = document.getElementById('payment-modal');
            modal.classList.add('hidden');
        }

        function hideOrderSuccessModal() {
            const modal = document.getElementById('order-success-modal');
            modal.classList.add('hidden');
        }

        // Generate QR Code
        function generateQRCode(orderId, total) {
            const qrContainer = document.getElementById('qr-code-container');
            qrContainer.innerHTML = '';
            
            // Create payment URL
            const paymentUrl = `${window.location.origin}/pharma-direct-sql/pay/?orderId=${orderId}`;
            
            // Check if QRCode library is loaded
            if (typeof QRCode === 'undefined') {
                console.log('QRCode library not loaded, using external service');
                // Use external QR service as fallback
                qrContainer.innerHTML = `
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(paymentUrl)}&color=10b981&bgcolor=ffffff" 
                         alt="QR Code for Payment" 
                         class="mx-auto w-48 h-48 border rounded-lg">
                `;
                return;
            }
            
            // Use toCanvas method like pay.html
            QRCode.toCanvas(qrContainer, paymentUrl, {
                width: 200,
                height: 200,
                color: { dark: '#10b981', light: '#ffffff' }
            }, function (error) {
                if (error) {
                    console.error('QR Code generation error:', error);
                    // Fallback to external QR service
                    qrContainer.innerHTML = `
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(paymentUrl)}&color=10b981&bgcolor=ffffff" 
                             alt="QR Code for Payment" 
                             class="mx-auto w-48 h-48 border rounded-lg">
                    `;
                }
            });
        }

        // Payment Modal Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Close payment modal
            document.getElementById('close-payment-modal').addEventListener('click', hidePaymentModal);
            document.getElementById('close-payment-modal-btn').addEventListener('click', hidePaymentModal);
            
            // Close success modal
            document.getElementById('close-success-modal').addEventListener('click', hideOrderSuccessModal);
            document.getElementById('close-success-modal-btn').addEventListener('click', hideOrderSuccessModal);
            
            // QR Payment button
            document.getElementById('qr-payment-btn').addEventListener('click', function() {
                const orderIdEl = document.getElementById('payment-order-id');
                const orderId = orderIdEl.getAttribute('data-full-id') || orderIdEl.textContent;
                const total = document.getElementById('payment-total').textContent.replace('₱', '');
                
                // Show QR section first
                document.getElementById('qr-section').classList.remove('hidden');
                
                // Add a delay to ensure QRCode library is loaded
                if (typeof QRCode === 'undefined') {
                    setTimeout(() => {
                        generateQRCode(orderId, total);
                    }, 1000);
                } else {
                    generateQRCode(orderId, total);
                }
            });
            
            // Online payment button
            document.getElementById('online-payment-btn').addEventListener('click', function() {
                const orderIdEl = document.getElementById('payment-order-id');
                const orderId = orderIdEl.getAttribute('data-full-id') || orderIdEl.textContent;
                window.location.href = `../pay/?orderId=${orderId}`;
            });
            
            
            // Track order buttons
            document.getElementById('track-order-btn').addEventListener('click', function() {
                window.location.href = '../track/';
            });
            
            document.getElementById('track-order-success-btn').addEventListener('click', function() {
                window.location.href = '../track/';
            });
        });
    </script>
</body>

</html>
<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manage Addresses — PHARMA DIRECT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../css/styles.css" />
    <style>
        /* Mobile menu height constraints - prevent overflow */
        #mobile-menu {
            height: 100vh;
            max-height: 100vh;
            overflow: hidden;
            position: fixed;
            top: 0;
            right: 0;
            width: 320px;
            max-width: 90vw;
        }
        
        /* Use actual viewport height for mobile browsers */
        @media (max-width: 768px) {
            #mobile-menu {
                height: 100vh;
                max-height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom));
            }
        }
        
        /* Ensure logout button is always visible */
        .mobile-menu-content {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }
        
        .mobile-nav-scroll {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
            max-height: calc(100vh - 180px); /* Reserve space for header and bottom actions */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }
        
        /* Ensure the menu never exceeds viewport */
        @supports (height: 100dvh) {
            #mobile-menu {
                height: 100dvh;
                max-height: 100dvh;
            }
            
            .mobile-nav-scroll {
                max-height: calc(100dvh - 200px);
            }
        }
        
        /* Fallback for older browsers - use smaller viewport */
        @media (max-width: 768px) {
            .mobile-nav-scroll {
                max-height: calc(100vh - 200px);
            }
        }
        
        /* Improved button styles for better UX */
        .address-action-btn {
            min-height: 44px; /* Better touch target for mobile */
            min-width: 80px;
            font-weight: 500;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s ease-in-out;
        }

        .address-action-btn:hover {
            transform: translateY(-1px);
        }

        .address-action-btn:active {
            transform: translateY(0);
        }

        .address-action-btn:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }

        .edit-btn {
            background-color: #2563eb;
            color: white;
        }

        .edit-btn:hover {
            background-color: #1d4ed8;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .edit-btn:focus {
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.5);
        }

        .delete-btn {
            background-color: #dc2626;
            color: white;
        }

        .delete-btn:hover {
            background-color: #b91c1c;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }

        .delete-btn:focus {
            box-shadow: 0 0 0 2px rgba(220, 38, 38, 0.5);
        }

        /* Mobile-specific improvements */
        @media (max-width: 768px) {
            .address-action-btn {
                min-height: 48px; /* Larger touch target on mobile */
                min-width: 90px;
                font-size: 0.875rem;
            }
        }

        /* Professional address card styling */
        .address-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease-in-out;
            overflow: hidden;
        }

        .address-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
        }

        .address-card.default {
            border-left: 4px solid #10b981;
            background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%);
        }

        .address-card.default:hover {
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
        }

        .address-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 1.25rem 1.25rem 0.75rem 1.25rem;
        }

        .address-title {
            font-weight: 600;
            font-size: 1.125rem;
            color: #111827;
            margin: 0;
        }

        .address-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            background: #10b981;
            color: white;
            font-size: 0.75rem;
            font-weight: 500;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            margin-left: 0.75rem;
        }

        .address-content {
            padding: 0 1.25rem 1rem 1.25rem;
        }

        .address-text {
            color: #6b7280;
            font-size: 0.875rem;
            line-height: 1.5;
            margin: 0 0 1rem 0;
            word-wrap: break-word;
        }

        .address-actions {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 0.75rem;
            padding: 0 1.25rem 1.25rem 1.25rem;
            border-top: 1px solid #f3f4f6;
            margin-top: 1rem;
            padding-top: 1rem;
        }

        /* Warning styling for multiple defaults */
        .address-warning {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 0.75rem;
            margin: 0.5rem 0;
            font-size: 0.875rem;
            color: #92400e;
        }

        .address-warning-icon {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            background: #f59e0b;
            color: white;
            font-size: 0.75rem;
            font-weight: 500;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            margin-left: 0.75rem;
        }

        /* Page layout improvements */
        .addresses-container {
            max-width: 768px;
            margin: 0 auto;
            padding: 1rem;
        }

        .addresses-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .addresses-title {
            font-size: 1.875rem;
            font-weight: 700;
            color: #111827;
            margin: 0 0 0.5rem 0;
        }

        .addresses-subtitle {
            font-size: 1rem;
            color: #6b7280;
            margin: 0;
        }

        .addresses-list {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        /* Empty state styling */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6b7280;
        }

        .empty-state-icon {
            width: 4rem;
            height: 4rem;
            margin: 0 auto 1rem auto;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #374151;
            margin: 0 0 0.5rem 0;
        }

        .empty-state-text {
            font-size: 1rem;
            color: #6b7280;
            margin: 0;
        }
        
        /* Bottom actions always visible and fixed */
        .mobile-bottom-actions {
            flex-shrink: 0;
            margin-top: auto;
        }
        
        /* User info section */
        .mobile-user-info {
            flex-shrink: 0;
        }
        
        /* Navigation items */
        .mobile-nav-item {
            flex-shrink: 0;
        }
        
        /* Prevent body scroll when menu is open */
        body.menu-open {
            overflow: hidden;
            height: 100vh;
        }
    </style>
</head>

<body class="min-h-screen bg-gray-50">
    <header class="bg-white border-b sticky top-0 z-40">
        <div class="mx-auto container-max px-4 py-3">
            <div class="flex items-center justify-between">
                <!-- Logo -->
                <a href="../" class="flex items-center gap-2 flex-shrink-0">
                    <img src="../img/icon.png" alt="logo" class="w-6 h-6" />
                    <span class="font-semibold text-lg hidden sm:block">PHARMA DIRECT</span>
                    <span class="font-semibold text-lg sm:hidden">PHARMA</span>
                </a>
                
                <!-- Mobile Menu Button -->
                <div class="lg:hidden">
                    <button id="mobile-menu-btn" class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Desktop Account Button -->
                <div class="hidden lg:block relative">
                    <button id="account-btn"
                        class="inline-flex items-center gap-2 rounded-lg border px-3 py-2 hover:bg-gray-50 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                        <span id="account-name" class="text-sm font-medium truncate max-w-32"></span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 flex-shrink-0" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                    <div id="account-menu" class="dropdown-panel hidden">
                        <div class="user-info">
                            <p class="user-email" id="account-email"></p>
                            <p class="user-role" id="account-role"></p>
                        </div>
                        <a href="../user-dashboard/" class="dropdown-item">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M8 5a2 2 0 012-2h4a2 2 0 012 2v2H8V5z"></path>
                            </svg>
                            <span>Dashboard</span>
                        </a>
                        <a href="../track/" class="dropdown-item">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2">
                                </path>
                            </svg>
                            <span>My Orders</span>
                        </a>
                        <button id="logout-btn" class="dropdown-item w-full text-left">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                                </path>
                            </svg>
                            <span>Logout</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Mobile Menu Overlay -->
            <div id="mobile-menu-overlay" class="lg:hidden hidden fixed inset-0 z-50 bg-black bg-opacity-50 transition-opacity duration-300"></div>
            
            <!-- Mobile Menu -->
            <div id="mobile-menu" class="lg:hidden hidden fixed top-0 right-0 h-screen w-80 max-w-sm bg-white shadow-2xl transform transition-transform duration-300 ease-in-out z-50 flex flex-col">
                <!-- Mobile Menu Header -->
                <div class="flex items-center justify-between p-6 bg-gradient-to-r from-emerald-600 to-emerald-700 text-white">
                    <div class="flex items-center gap-3">
                        <img src="../img/icon.png" alt="logo" class="w-8 h-8" />
                        <div>
                            <h2 class="font-bold text-lg">PHARMA DIRECT</h2>
                            <p class="text-emerald-100 text-sm">Your Health Partner</p>
                        </div>
                    </div>
                    <button id="mobile-menu-close" class="p-2 rounded-full hover:bg-white hover:bg-opacity-20 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Mobile Menu Content -->
                <div class="flex flex-col flex-1 min-h-0">
                    <!-- User Info Section -->
                    <div id="mobile-account-section" class="p-6 bg-gray-50 border-b border-gray-200 flex-shrink-0">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center">
                                <svg class="w-8 h-8 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="font-bold text-lg text-gray-900" id="mobile-account-name">Loading...</p>
                                <p class="text-sm text-gray-500" id="mobile-account-email">Loading...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Navigation Links -->
                    <div class="flex-1 overflow-y-auto min-h-0">
                        <nav class="p-6 space-y-2">
                            <!-- Primary Navigation -->
                            <div class="space-y-2">
                                <!-- Home -->
                                <a href="../" class="flex items-center gap-4 px-4 py-3 rounded-xl hover:bg-emerald-50 hover:text-emerald-700 transition-all duration-200 group">
                                    <div class="w-10 h-10 bg-emerald-100 group-hover:bg-emerald-200 rounded-xl flex items-center justify-center transition-colors">
                                        <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                                        </svg>
                                    </div>
                                    <span class="font-medium text-gray-700 group-hover:text-emerald-700">Home</span>
                                </a>
                                
                                <!-- Categories -->
                                <a href="../categories/" class="flex items-center gap-4 px-4 py-3 rounded-xl hover:bg-blue-50 hover:text-blue-700 transition-all duration-200 group">
                                    <div class="w-10 h-10 bg-blue-100 group-hover:bg-blue-200 rounded-xl flex items-center justify-center transition-colors">
                                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                        </svg>
                                    </div>
                                    <span class="font-medium text-gray-700 group-hover:text-blue-700">Categories</span>
                                </a>
                                
                                <!-- Track Order -->
                                <a href="../track/" class="flex items-center gap-4 px-4 py-3 rounded-xl hover:bg-purple-50 hover:text-purple-700 transition-all duration-200 group">
                                    <div class="w-10 h-10 bg-purple-100 group-hover:bg-purple-200 rounded-xl flex items-center justify-center transition-colors">
                                        <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                        </svg>
                                    </div>
                                    <span class="font-medium text-gray-700 group-hover:text-purple-700">Track Order</span>
                                </a>
                                
                                <!-- Cart -->
                                <a href="../cart/" class="flex items-center gap-4 px-4 py-3 rounded-xl hover:bg-green-50 hover:text-green-700 transition-all duration-200 group">
                                    <div class="w-10 h-10 bg-green-100 group-hover:bg-green-200 rounded-xl flex items-center justify-center transition-colors">
                                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-2.5 5M7 13l2.5 5"></path>
                                        </svg>
                                    </div>
                                    <div class="flex-1 flex items-center justify-between">
                                        <span class="font-medium text-gray-700 group-hover:text-green-700">Cart</span>
                                        <span id="mobile-cart-count" class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-emerald-600 text-white text-xs font-bold">0</span>
                                    </div>
                                </a>
                            </div>
                            
                            <!-- Divider -->
                            <div class="my-4 border-t border-gray-200"></div>
                            
                            <!-- Account Section -->
                            <div class="space-y-2">
                                <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider px-4">Account</p>
                                
                                <!-- Dashboard (for logged-in users) -->
                                <a id="mobile-dashboard-link" href="../user-dashboard/" class="flex items-center gap-4 px-4 py-3 rounded-xl hover:bg-indigo-50 hover:text-indigo-700 transition-all duration-200 group">
                                    <div class="w-10 h-10 bg-indigo-100 group-hover:bg-indigo-200 rounded-xl flex items-center justify-center transition-colors">
                                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                                        </svg>
                                    </div>
                                    <span class="font-medium text-gray-700 group-hover:text-indigo-700">Dashboard</span>
                                </a>
                                
                                <!-- Manage Address (for logged-in users) - Active State -->
                                <a id="mobile-address-link" href="../addresses/" class="flex items-center gap-4 px-4 py-3 rounded-xl bg-purple-50 text-purple-700 transition-all duration-200 group">
                                    <div class="w-10 h-10 bg-purple-100 group-hover:bg-purple-200 rounded-xl flex items-center justify-center transition-colors">
                                        <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        </svg>
                                    </div>
                                    <span class="font-medium text-purple-700">Manage Address</span>
                                </a>
                            </div>
                        </nav>
                    </div>
                    
                    <!-- Bottom Actions -->
                    <div class="p-6 border-t border-gray-200 bg-gray-50 flex-shrink-0">
                        <!-- Login Button (for non-logged-in users) -->
                        <a id="mobile-login-section" href="../login/" class="hidden flex items-center justify-center gap-3 w-full px-4 py-3 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 transition-colors font-medium">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>
                            </svg>
                            <span>Login / Register</span>
                        </a>
                        
                        <!-- Logout Button (for logged-in users) -->
                        <button id="mobile-logout-btn" class="flex items-center justify-center gap-3 w-full px-4 py-3 bg-red-600 text-white rounded-xl hover:bg-red-700 transition-colors font-medium">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                            </svg>
                            <span>Logout</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="addresses-container py-8 pb-24">
        <!-- Back Button -->
        <div class="mb-6">
            <a href="../cart/"
                class="inline-flex items-center gap-2 text-emerald-600 hover:text-emerald-700 font-medium transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                Back to Cart
            </a>
        </div>

        <!-- Manage Addresses Header -->
        <div class="mb-8">
            <div class="bg-gradient-to-r from-emerald-600 to-emerald-700 rounded-2xl p-6 sm:p-8 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl sm:text-3xl font-bold mb-2">Manage Addresses</h1>
                        <p class="text-emerald-100 text-sm sm:text-base">Add and manage your delivery addresses</p>
                    </div>
                    <div class="hidden sm:block">
                        <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Address Button -->
        <div class="mb-6">
            <button id="add-address-btn" class="bg-gradient-to-r from-emerald-600 to-emerald-700 text-white px-6 py-3 rounded-xl hover:from-emerald-700 hover:to-emerald-800 transition-all duration-300 font-medium flex items-center gap-2 shadow-lg hover:shadow-xl">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                Add New Address
            </button>
        </div>

        <!-- Address List -->
        <div id="addresses-list" class="addresses-list">
            <div class="text-gray-500">Loading addresses...</div>
        </div>

        <!-- Add/Edit Address Modal -->
        <div id="address-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-2xl">
                    <!-- Modal Header -->
                    <div class="bg-gradient-to-r from-emerald-600 to-emerald-700 px-6 py-4 rounded-t-2xl">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-bold text-white flex items-center gap-2" id="modal-title">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                Add New Address
                            </h3>
                            <button id="close-address-modal" class="text-emerald-100 hover:text-white transition-colors p-1 rounded-lg hover:bg-white hover:bg-opacity-20">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <form id="address-form" class="p-6">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Province</label>
                                <select id="province"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                    required>
                                    <option value="">Select Province</option>
                                    <option value="Metro Manila">Metro Manila</option>
                                    <option value="Cavite">Cavite</option>
                                    <option value="Laguna">Laguna</option>
                                    <option value="Batangas">Batangas</option>
                                    <option value="Rizal">Rizal</option>
                                    <option value="Quezon">Quezon</option>
                                    <option value="Bulacan">Bulacan</option>
                                    <option value="Pampanga">Pampanga</option>
                                    <option value="Tarlac">Tarlac</option>
                                    <option value="Nueva Ecija">Nueva Ecija</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">City/Municipality</label>
                                <select id="city"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                    required>
                                    <option value="">Select City/Municipality</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Barangay</label>
                                <input type="text" id="barangay"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                    placeholder="Enter barangay" required>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Postal Code</label>
                                    <input type="text" id="postal-code"
                                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                        placeholder="1234" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">House/Unit No.</label>
                                    <input type="text" id="house-number"
                                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                        placeholder="123" required>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Street Address</label>
                                <input type="text" id="street"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                    placeholder="Enter street name" required>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Landmark/Notes
                                    (Optional)</label>
                                <textarea id="landmark"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                    rows="3" placeholder="Near the church, beside the school, etc."></textarea>
                            </div>

                            <div class="flex items-center">
                                <input type="checkbox" id="default-address"
                                    class="h-4 w-4 text-emerald-600 focus:ring-emerald-500 border-gray-300 rounded">
                                <label for="default-address" class="ml-2 block text-sm text-gray-700">Set as default
                                    address</label>
                            </div>
                        </div>

                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" id="cancel-address"
                                class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">
                                Cancel
                            </button>
                            <button type="submit"
                                class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">
                                Save Address
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <script src="../js/imageCache.js"></script>
    <script src="../js/loading.js"></script>
    <script type="module">
        import { showError, showSuccess, getProfessionalErrorMessage, setButtonLoading, showLoadingModal, hideLoadingModal } from '../js/supabase-config.js';
        import { logout, onAuthStateChanged, fetchUserRole, fetchUserDoc, getUserIdFromUid } from '../js/supabase-auth.js';
        import { supabase } from '../js/supabase-auth.js';
        import { TABLES } from '../js/supabase-config.js';
        import { getAddressesByUser, addAddress, updateAddress, deleteAddress } from '../js/supabase-database.js';

        const accountBtn = document.getElementById('account-btn');
        const accountMenu = document.getElementById('account-menu');
        const accountName = document.getElementById('account-name');
        const accountEmail = document.getElementById('account-email');
        const accountRole = document.getElementById('account-role');
        const logoutBtn = document.getElementById('logout-btn');
        const addressesList = document.getElementById('addresses-list');
        const addAddressBtn = document.getElementById('add-address-btn');
        const addressModal = document.getElementById('address-modal');
        const addressForm = document.getElementById('address-form');
        const modalTitle = document.getElementById('modal-title');
        const provinceSelect = document.getElementById('province');
        const citySelect = document.getElementById('city');

        let currentUserId = null;
        let editingAddressId = null;

        // Philippine cities by province
        const citiesByProvince = {
            'Metro Manila': ['Manila', 'Quezon City', 'Caloocan', 'Las Piñas', 'Makati', 'Malabon', 'Mandaluyong', 'Marikina', 'Muntinlupa', 'Navotas', 'Parañaque', 'Pasay', 'Pasig', 'Pateros', 'San Juan', 'Taguig', 'Valenzuela'],
            'Cavite': ['Bacoor', 'Cavite City', 'Dasmariñas', 'Imus', 'Kawit', 'Noveleta', 'Rosario', 'Silang', 'Tanza', 'Trece Martires City'],
            'Laguna': ['Biñan', 'Cabuyao', 'Calamba', 'San Pablo', 'Santa Rosa', 'Alaminos', 'Bay', 'Calauan', 'Cavinti', 'Famy', 'Kalayaan', 'Liliw', 'Los Baños', 'Luisiana', 'Lumban', 'Mabitac', 'Magdalena', 'Majayjay', 'Nagcarlan', 'Paete', 'Pagsanjan', 'Pakil', 'Pangil', 'Pila', 'Rizal', 'San Pedro', 'Siniloan', 'Victoria'],
            'Batangas': ['Batangas City', 'Lipa', 'Tanauan', 'Bauan', 'Calaca', 'Calatagan', 'Cuenca', 'Ibaan', 'Laurel', 'Lemery', 'Lian', 'Lobo', 'Mabini', 'Malvar', 'Mataasnakahoy', 'Nasugbu', 'Padre Garcia', 'Rosario', 'San Jose', 'San Juan', 'San Luis', 'San Nicolas', 'Santo Tomas', 'Taal', 'Talisay', 'Taysan', 'Tingloy', 'Tuy'],
            'Rizal': ['Antipolo', 'Angono', 'Baras', 'Binangonan', 'Cainta', 'Cardona', 'Jalajala', 'Morong', 'Pililla', 'Rodriguez', 'San Mateo', 'Tanay', 'Taytay', 'Teresa'],
            'Quezon': ['Lucena', 'Tayabas', 'Alabat', 'Atimonan', 'Buenavista', 'Burdeos', 'Calauag', 'Candelaria', 'Catanauan', 'Dolores', 'General Luna', 'General Nakar', 'Guinayangan', 'Gumaca', 'Infanta', 'Jomalig', 'Lopez', 'Lucban', 'Macalelon', 'Mauban', 'Mulanay', 'Padre Burgos', 'Pagbilao', 'Panukulan', 'Patnanungan', 'Perez', 'Pitogo', 'Plaridel', 'Polillo', 'Quezon', 'Real', 'Sampaloc', 'San Andres', 'San Antonio', 'San Francisco', 'San Narciso', 'Sariaya', 'Tagkawayan', 'Tiaong', 'Unisan'],
            'Bulacan': ['Malolos', 'Meycauayan', 'San Jose del Monte', 'Baliuag', 'Bocaue', 'Calumpit', 'Doña Remedios Trinidad', 'Guiguinto', 'Hagonoy', 'Marilao', 'Norzagaray', 'Obando', 'Pandi', 'Paombong', 'Plaridel', 'Pulilan', 'San Ildefonso', 'San Miguel', 'San Rafael', 'Santa Maria'],
            'Pampanga': ['Angeles', 'San Fernando', 'Apalit', 'Arayat', 'Bacolor', 'Candaba', 'Floridablanca', 'Guagua', 'Lubao', 'Mabalacat', 'Macabebe', 'Magalang', 'Masantol', 'Mexico', 'Minalin', 'Porac', 'San Luis', 'San Simon', 'Santa Ana', 'Santa Rita', 'Santo Tomas', 'Sasmuan'],
            'Tarlac': ['Tarlac City', 'Anao', 'Bamban', 'Camiling', 'Capas', 'Concepcion', 'Gerona', 'La Paz', 'Mayantoc', 'Moncada', 'Paniqui', 'Pura', 'Ramos', 'San Clemente', 'San Jose', 'San Manuel', 'Santa Ignacia', 'Victoria'],
            'Nueva Ecija': ['Cabanatuan', 'Gapan', 'San Jose', 'Aliaga', 'Bongabon', 'Cabiao', 'Carranglan', 'Cuyapo', 'Gabaldon', 'General Mamerto Natividad', 'General Tinio', 'Guimba', 'Jaen', 'Laur', 'Llanera', 'Lupao', 'Muñoz', 'Nampicuan', 'Palayan', 'Pantabangan', 'Peñaranda', 'Quezon', 'Rizal', 'San Antonio', 'San Isidro', 'San Leonardo', 'Santa Rosa', 'Santo Domingo', 'Talavera', 'Talugtug', 'Zaragoza']
        };

        // Update cities when province changes
        provinceSelect.addEventListener('change', (e) => {
            const selectedProvince = e.target.value;
            citySelect.innerHTML = '<option value="">Select City/Municipality</option>';

            if (citiesByProvince[selectedProvince]) {
                citiesByProvince[selectedProvince].forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    citySelect.appendChild(option);
                });
            }
        });

        async function loadAddresses() {
            if (!currentUserId) return;

            // Get database user ID from auth UID
            const databaseUserId = await getUserIdFromUid(currentUserId);
            if (!databaseUserId) {
                console.error('Unable to get database user ID');
                return;
            }

            const { data: addresses, error } = await supabase
                .from(TABLES.addresses)
                .select('*')
                .eq('user_id', databaseUserId)
                .order('is_default', { ascending: false });

            if (error) {
                console.error('Error loading addresses:', error);
                return;
            }

            if (!addresses || addresses.length === 0) {
                addressesList.innerHTML = `
                    <div class="text-center py-8">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">No addresses</h3>
                        <p class="mt-1 text-sm text-gray-500">Get started by adding a new address.</p>
                    </div>
                `;
                return;
            }

            // Count default addresses to handle multiple defaults
            let defaultAddressesCount = 0;
            addresses.forEach(address => {
                if (address.is_default) {
                    defaultAddressesCount++;
                }
            });

            console.log(`User has ${defaultAddressesCount} default addresses`);

            addressesList.innerHTML = addresses.map(address => {
                const shouldShowAsDefault = address.is_default && defaultAddressesCount <= 1;
                const shouldShowWarning = address.is_default && defaultAddressesCount > 1;
                const cardClass = shouldShowAsDefault ? 'address-card default' : 'address-card';

                return `
                    <div class="${cardClass}">
                        <div class="address-header">
                            <div class="flex items-center">
                                <h3 class="address-title">${address.name || 'Address'}</h3>
                                ${shouldShowAsDefault ? '<span class="address-badge">Default</span>' : ''}
                                ${shouldShowWarning ? '<span class="address-warning-icon">⚠️ Multiple Default</span>' : ''}
                                </div>
                            </div>
                        <div class="address-content">
                            <p class="address-text">${address.address || 'No address details'}</p>
                            ${shouldShowWarning ? '<div class="address-warning">⚠️ Multiple addresses are marked as default. Please set only one as default.</div>' : ''}
                            </div>
                        <div class="address-actions">
                            <button onclick="editAddress('${address.id}')" class="address-action-btn edit-btn px-4 py-2 rounded-lg shadow-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                                Edit
                            </button>
                            <button onclick="deleteAddress('${address.id}')" class="address-action-btn delete-btn px-4 py-2 rounded-lg shadow-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                                Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            // Show warning if there are multiple default addresses
            if (defaultAddressesCount > 1) {
                console.warn(`⚠️ User has ${defaultAddressesCount} default addresses. This violates the business rule of having only one default address per user.`);
            }
        }

        // Test function for debugging Supabase connection
        window.testSupabaseConnection = async () => {
            console.log('=== SUPABASE CONNECTION TEST ===');
            try {
                // Test 1: Check authentication
                const { data: { user } } = await supabase.auth.getUser();
                console.log('User authenticated:', user ? 'YES' : 'NO');
                if (user) {
                    console.log('User ID:', user.id);
                    console.log('User email:', user.email);
                } else {
                    console.log('❌ No user authenticated - please log in first');
                    return;
                }

                // Test 2: Try to read addresses
                console.log('Testing read permissions...');
                const { data: addresses, error: readError } = await supabase
                    .from(TABLES.addresses)
                    .select('*')
                    .limit(1);
                
                if (readError) {
                    console.error('❌ Read test failed:', readError);
                } else {
                    console.log('✅ Read test successful');
                }

                console.log('🎉 SUPABASE CONNECTION TEST COMPLETE');

            } catch (error) {
                console.error('❌ TEST FAILED:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
            }
            console.log('================================');
        };

        // Function to clean up multiple default addresses (for data integrity)
        window.cleanupMultipleDefaults = async () => {
            if (!currentUserId) {
                console.error('No user ID available');
                return;
            }

            console.log('🧹 Starting cleanup of multiple default addresses...');

            try {
                // Get database user ID
                const databaseUserId = await getUserIdFromUid(currentUserId);
                if (!databaseUserId) {
                    console.error('Unable to get database user ID');
                    return;
                }

                // Find all default addresses for this user
                const { data: defaultAddresses, error } = await supabase
                    .from(TABLES.addresses)
                    .select('id')
                    .eq('user_id', databaseUserId)
                    .eq('is_default', true);

                if (error) {
                    console.error('Error fetching default addresses:', error);
                    return;
                }

                if (!defaultAddresses || defaultAddresses.length <= 1) {
                    console.log('✅ No cleanup needed - user has 1 or 0 default addresses');
                    return;
                }

                console.log(`Found ${defaultAddresses.length} default addresses, cleaning up...`);

                // Keep the first one as default, unset others
                const addressesToUpdate = defaultAddresses.slice(1); // Skip the first one

                if (addressesToUpdate.length > 0) {
                    const { error: updateError } = await supabase
                        .from(TABLES.addresses)
                        .update({ is_default: false })
                        .in('id', addressesToUpdate.map(addr => addr.id));

                    if (updateError) {
                        console.error('Error updating addresses:', updateError);
                        return;
                    }
                }

                console.log(`✅ Cleanup complete! Kept default: ${defaultAddresses[0].id}, unset ${addressesToUpdate.length} others`);

                // Reload addresses to show updated state
                await loadAddresses();

            } catch (error) {
                console.error('❌ Error during cleanup:', error);
            }
        };

        // Global functions for address management

        window.editAddress = async (addressId) => {
            try {
                const { data: address, error } = await supabase
                    .from(TABLES.addresses)
                    .select('*')
                    .eq('id', addressId)
                    .single();

                if (error) {
                    console.error('Error fetching address:', error);
                    return;
                }

                if (address) {
                editingAddressId = addressId;
                modalTitle.textContent = 'Edit Address';

                    // Parse the address string to populate form fields
                    
                    // Extract components from the address string
                    const addressText = address.address;
                    let street = '';
                    let barangay = '';
                    let city = '';
                    let province = '';
                    let postalCode = '';
                    let landmark = '';
                    let houseNumber = '';

                    // Helper function to parse house number and street from a string
                    function parseHouseNumberAndStreet(input) {
                        let houseNumber = '';
                        let streetName = '';
                        
                        if (!input) return { houseNumber, streetName };
                        
                        // Special case for "1 1 1" format - this should be treated as house number only
                        if (input.trim() === "1 1 1") {
                            houseNumber = "1 1 1";
                            streetName = '';
                            return { houseNumber, streetName };
                        }
                        
                        // Look for patterns like "123 Main St", "123 456 St", "123 Street Name"
                        const patterns = [
                            // Pattern: "123 Main St" or "123 456 Main St" - numbers followed by space and text
                            /^(\d+(?:\s+\d+)*)\s+(.+)$/,
                            // Pattern: "123" (just numbers)
                            /^(\d+(?:\s+\d+)*)$/,
                            // Pattern: "Main St" (no numbers)
                            /^([^0-9]+)$/
                        ];
                        
                        for (let i = 0; i < patterns.length; i++) {
                            const pattern = patterns[i];
                            const match = input.trim().match(pattern);
                            if (match) {
                                if (match[2]) {
                                    // Has both number and street name
                                    houseNumber = match[1];
                                    streetName = match[2];
                                } else if (match[1] && /^\d/.test(match[1])) {
                                    // Just numbers
                                    houseNumber = match[1];
                                    streetName = '';
                                } else {
                                    // Just street name
                                    houseNumber = '';
                                    streetName = match[1];
                                }
                                break;
                            }
                        }
                        
                        return { houseNumber, streetName };
                    }

                    
                    // Check if there's a landmark in parentheses
                    const landmarkMatch = addressText.match(/\(Landmark: ([^)]+)\)/);
                    if (landmarkMatch) {
                        landmark = landmarkMatch[1];
                    }

                    // Remove landmark from address for parsing
                    const cleanAddress = addressText.replace(/\s*\(Landmark: [^)]+\)/, '');
                    
                    // Extract postal code (4 digits) or single digit at the end
                    const postalMatch = cleanAddress.match(/\b(\d{4})\b/) || cleanAddress.match(/\b(\d)\s*$/);
                    if (postalMatch) {
                        postalCode = postalMatch[1];
                    }

                    // Remove postal code for further parsing (handle both 4-digit and single digit)
                    let addressWithoutPostal = cleanAddress.replace(/\b\d{4}\b/, '').replace(/\b\d\s*$/, '').replace(/\s+/g, ' ').trim();
                    
                    // Split by commas and clean up
                    const parts = addressWithoutPostal.split(',').map(part => part.trim()).filter(part => part.length > 0);

                    // More flexible parsing - try different approaches
                    
                    if (parts.length >= 4) {
                        // Format: "House Number Street, Barangay, City, Province"
                        const streetPart = parts[0];
                        const result = parseHouseNumberAndStreet(streetPart);
                        houseNumber = result.houseNumber;
                        street = result.streetName;
                        barangay = parts[1];
                        city = parts[2];
                        province = parts[3];
                    } else if (parts.length >= 3) {
                        // Format: "Street, Barangay, City" or "Street, City, Province"
                        const streetPart = parts[0];
                        const result = parseHouseNumberAndStreet(streetPart);
                        houseNumber = result.houseNumber;
                        street = result.streetName;
                        
                        // Check if the second part looks like a barangay (usually short, might be numeric)
                        const secondPart = parts[1];
                        const thirdPart = parts[2];
                        
                        // If second part is short and third part is a known city, treat second as barangay
                        if (secondPart.length <= 10 && thirdPart && thirdPart.length > 3) {
                            barangay = secondPart;
                            city = thirdPart;
                        } else {
                            // Otherwise treat as Street, City, Province
                            city = secondPart;
                            province = thirdPart;
                        }
                    } else if (parts.length >= 2) {
                        // Format: "Street, City"
                        const streetPart = parts[0];
                        const result = parseHouseNumberAndStreet(streetPart);
                        houseNumber = result.houseNumber;
                        street = result.streetName;
                        city = parts[1];
                    } else if (parts.length >= 1) {
                        // Just street - but this might be the full address
                        if (parts[0].length > 50) {
                            // This looks like a full concatenated address, try to parse it differently
                            
                            // Try to find common patterns
                            const fullAddress = parts[0];
                            
                            // Pattern 1: Look for "Barangay" keyword
                            const barangayMatch = fullAddress.match(/(\d+)\s+([^,]+),\s*Barangay\s+([^,]+),\s*([^,]+),\s*([^,]+)/i);
                            if (barangayMatch) {
                                const result = parseHouseNumberAndStreet(barangayMatch[1] + ' ' + barangayMatch[2]);
                                houseNumber = result.houseNumber;
                                street = result.streetName;
                                barangay = barangayMatch[3];
                                city = barangayMatch[4];
                                province = barangayMatch[5];
                            } else {
                                // Pattern 2: Look for common Philippine address patterns
                                const phPattern = fullAddress.match(/(\d+)\s+([^,]+),\s*([^,]+),\s*([^,]+),\s*([^,]+)/);
                                if (phPattern) {
                                    const result = parseHouseNumberAndStreet(phPattern[1] + ' ' + phPattern[2]);
                                    houseNumber = result.houseNumber;
                                    street = result.streetName;
                                    barangay = phPattern[3];
                                    city = phPattern[4];
                                    province = phPattern[5];
                                } else {
                                    // Fallback: treat the whole thing as street
                                    const result = parseHouseNumberAndStreet(parts[0]);
                                    houseNumber = result.houseNumber;
                                    street = result.streetName;
                                }
                            }
                        } else {
                            const result = parseHouseNumberAndStreet(parts[0]);
                            houseNumber = result.houseNumber;
                            street = result.streetName;
                        }
                    } else {
                        const result = parseHouseNumberAndStreet(addressText);
                        houseNumber = result.houseNumber;
                        street = result.streetName;
                    }

                    // Try to extract province from city if not found
                    if (!province && city) {
                        // Common Philippine provinces and their major cities
                        const provinceCities = {
                            'Metro Manila': ['Manila', 'Quezon City', 'Makati', 'Taguig', 'Pasig', 'Mandaluyong', 'San Juan', 'Marikina', 'Muntinlupa', 'Las Piñas', 'Parañaque', 'Pasay', 'Valenzuela', 'Malabon', 'Navotas', 'Caloocan', 'Pateros'],
                            'Cebu': ['Cebu City', 'Mandaue', 'Lapu-Lapu', 'Talisay', 'Toledo', 'Naga'],
                            'Laguna': ['Calamba', 'San Pedro', 'Biñan', 'Santa Rosa', 'Cabuyao', 'Los Baños'],
                            'Cavite': ['Bacoor', 'Imus', 'Dasmariñas', 'General Trias', 'Trece Martires', 'Tagaytay'],
                            'Bulacan': ['Malolos', 'Meycauayan', 'San Jose del Monte', 'Santa Maria', 'Marilao'],
                            'Rizal': ['Antipolo', 'Taytay', 'Cainta', 'Angono', 'Binangonan'],
                            'Pampanga': ['San Fernando', 'Angeles', 'Mabalacat', 'Mexico', 'Arayat'],
                            'Nueva Ecija': ['Cabanatuan', 'San Jose', 'Gapan', 'Muñoz', 'Palayan']
                        };

                        for (const [prov, cities] of Object.entries(provinceCities)) {
                            if (cities.some(c => c.toLowerCase() === city.toLowerCase())) {
                                province = prov;
                                break;
                            }
                        }
                    }


                    // Populate form fields
                    document.getElementById('house-number').value = houseNumber || '';
                    document.getElementById('street').value = street;
                    document.getElementById('barangay').value = barangay;
                    document.getElementById('postal-code').value = postalCode;
                    document.getElementById('landmark').value = landmark;
                    document.getElementById('default-address').checked = address.is_default || false;

                    // Set province first, then populate cities
                    if (province) {
                        const provinceSelect = document.getElementById('province');
                        provinceSelect.value = province;
                        
                        // Populate cities for the selected province
                        const citySelect = document.getElementById('city');
                        citySelect.innerHTML = '<option value="">Select City/Municipality</option>';
                        
                        if (citiesByProvince[province]) {
                            citiesByProvince[province].forEach(cityName => {
                        const option = document.createElement('option');
                                option.value = cityName;
                                option.textContent = cityName;
                                if (cityName === city) {
                                    option.selected = true;
                                }
                        citySelect.appendChild(option);
                    });
                }
                    }

                    // If parsing failed completely, show the raw address in the street field as fallback
                    if (!street && !barangay && !city && !province && addressText) {
                        document.getElementById('street').value = addressText;
                    }

                addressModal.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error editing address:', error);
            }
        };

        window.deleteAddress = async (addressId) => {
            if (confirm('Are you sure you want to delete this address?')) {
                try {
                    const { error } = await supabase
                        .from(TABLES.addresses)
                        .delete()
                        .eq('id', addressId);

                    if (error) {
                        console.error('Error deleting address:', error);
                        alert('Error deleting address. Please try again.');
                        return;
                    }

                await loadAddresses();
                } catch (error) {
                    console.error('Error deleting address:', error);
                    alert('Error deleting address. Please try again.');
                }
            }
        };

        // Form submission
        addressForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Validate user authentication
            if (!currentUserId) {
                alert('Please log in to save addresses.');
                return;
            }

            // Get database user ID from auth UID
            const databaseUserId = await getUserIdFromUid(currentUserId);
            if (!databaseUserId) {
                alert('Unable to verify user account. Please try logging in again.');
                return;
            }

            // DEBUG: Log authentication status
            console.log('=== DEBUG INFO ===');
            const { data: { user } } = await supabase.auth.getUser();
            console.log('Current user authenticated:', user ? 'YES' : 'NO');
            console.log('Current user ID (auth):', user?.id);
            console.log('Current user ID from state:', currentUserId);
            console.log('Database user ID:', databaseUserId);
            console.log('===================');

            // Build form data - match the original Firebase schema
            const houseNumber = document.getElementById('house-number').value;
            const street = document.getElementById('street').value;
            const barangay = document.getElementById('barangay').value;
            const city = document.getElementById('city').value;
            const province = document.getElementById('province').value;
            const postalCode = document.getElementById('postal-code').value;
            const landmark = document.getElementById('landmark').value;
            
            // Concatenate address components into a single address field (matching original Firebase schema)
            let fullAddress = `${houseNumber} ${street}`.trim();
            if (barangay) fullAddress += `, ${barangay}`;
            if (city) fullAddress += `, ${city}`;
            if (province) fullAddress += `, ${province}`;
            if (postalCode) fullAddress += ` ${postalCode}`;
            if (landmark) fullAddress += ` (Landmark: ${landmark})`;

            const formData = {
                user_id: databaseUserId,
                name: 'Home', // Default address name
                address: fullAddress,
                is_default: document.getElementById('default-address').checked
            };

            try {
                // If this address is being set as default, unset default from other addresses
                if (formData.is_default) {
                    console.log('Setting address as default, checking for existing default addresses...');

                    // Find all addresses for this user that are currently default
                    const { data: defaultAddresses, error: defaultError } = await supabase
                        .from(TABLES.addresses)
                        .select('id')
                        .eq('user_id', databaseUserId)
                        .eq('is_default', true);

                    if (defaultError) {
                        console.error('Error fetching default addresses:', defaultError);
                    } else if (defaultAddresses && defaultAddresses.length > 0) {
                        // Unset default flag from all other addresses
                        const addressesToUpdate = defaultAddresses
                            .filter(addr => !editingAddressId || addr.id !== editingAddressId)
                            .map(addr => addr.id);

                        if (addressesToUpdate.length > 0) {
                            console.log(`Unsetting default flag from ${addressesToUpdate.length} other addresses...`);
                            const { error: updateError } = await supabase
                                .from(TABLES.addresses)
                                .update({ is_default: false })
                                .in('id', addressesToUpdate);

                            if (updateError) {
                                console.error('Error unsetting default flag:', updateError);
                            } else {
                                console.log('Successfully unset default flag from other addresses');
                            }
                        }
                    }
                }

                let result;
                let savedAddressId;

                if (editingAddressId) {
                    // For editing, update existing address
                    const { data, error } = await supabase
                        .from(TABLES.addresses)
                        .update(formData)
                        .eq('id', editingAddressId)
                        .select()
                        .single();
                    
                    if (error) {
                        throw error;
                    }
                    result = data;
                    savedAddressId = editingAddressId;
                } else {
                    // For new addresses, insert new record
                    const { data, error } = await supabase
                        .from(TABLES.addresses)
                        .insert(formData)
                        .select()
                        .single();
                    
                    if (error) {
                        throw error;
                    }
                    result = data;
                    savedAddressId = data.id;
                }

                console.log('Address saved successfully with ID:', savedAddressId);

                addressModal.classList.add('hidden');
                addressForm.reset();
                editingAddressId = null;
                modalTitle.textContent = 'Add New Address';
                await loadAddresses();

                // Show success message
                showSuccessMessage('Address saved successfully!');

            } catch (error) {
                console.error('=== ADDRESS SAVE ERROR ===');
                console.error('Error details:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                console.error('Current user ID:', currentUserId);
                console.error('Form data user_id:', formData.user_id);
                const { data: { user } } = await supabase.auth.getUser();
                console.error('Is user authenticated?', user ? 'Yes' : 'No');
                console.error('Current user ID:', user?.id);
                console.error('=======================');

                // Provide helpful error messages based on error type
                let errorMessage = 'Error saving address. ';
                if (error.code === 'PGRST301' || error.message?.includes('permission')) {
                    errorMessage += 'Permission denied. Please check your authentication.';
                } else if (error.code === 'PGRST301' || error.message?.includes('network')) {
                    errorMessage += 'Network connection issue. Please try again.';
                } else {
                    errorMessage += `Unexpected error: ${error.code || error.message || 'Unknown'}`;
                }

                alert(errorMessage);
            }
        });

        // Helper function to show success messages
        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            successDiv.textContent = message;
            document.body.appendChild(successDiv);

            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        // Modal controls
        addAddressBtn.onclick = () => {
            editingAddressId = null;
            modalTitle.textContent = 'Add New Address';
            addressForm.reset();
            addressModal.classList.remove('hidden');
        };

        document.getElementById('close-address-modal').onclick = () => {
            addressModal.classList.add('hidden');
        };

        document.getElementById('cancel-address').onclick = () => {
            addressModal.classList.add('hidden');
        };

        addressModal.onclick = (e) => {
            if (e.target.id === 'address-modal') {
                addressModal.classList.add('hidden');
            }
        };

        onAuthStateChanged(async (user) => {
            const uid = user?.id || localStorage.getItem('uid');
            if (!uid) { 
                // Show loading message before redirect
                showLoadingModal('Please log in to manage your addresses');
                setTimeout(() => {
                    window.location.href = '../login/';
                }, 1500);
                return; 
            }

            const role = localStorage.getItem('role') || await fetchUserRole(uid);
            if (role !== 'user') {
                window.location.href = role === 'admin' ? '../admin/' : '../pharmacy/';
                return;
            }

            // Ensure user record exists in database
            await fetchUserDoc(uid);

            currentUserId = uid;

            // Update account info
            accountName.textContent = user?.displayName || 'Account';
            accountEmail.textContent = user?.email || '';
            accountRole.textContent = 'User';

            // Setup dropdown
            accountBtn.onclick = (e) => {
                e.stopPropagation();
                accountMenu.classList.toggle('hidden');
            };
            logoutBtn.onclick = async () => { await logout(); };

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!accountBtn.closest('.relative').contains(e.target)) {
                    accountMenu.classList.add('hidden');
                }
            });

            // Mobile menu functionality
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const mobileMenu = document.getElementById('mobile-menu');
            const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');
            const mobileMenuClose = document.getElementById('mobile-menu-close');
            const mobileAccountSection = document.getElementById('mobile-account-section');
            const mobileAccountName = document.getElementById('mobile-account-name');
            const mobileAccountEmail = document.getElementById('mobile-account-email');
            const mobileDashboardLink = document.getElementById('mobile-dashboard-link');
            const mobileAddressLink = document.getElementById('mobile-address-link');
            const mobileLoginSection = document.getElementById('mobile-login-section');
            const mobileLogoutBtn = document.getElementById('mobile-logout-btn');
            const mobileCartCount = document.getElementById('mobile-cart-count');
            
            // Update cart count from localStorage
            function updateCartCount() {
                const cart = JSON.parse(localStorage.getItem("cart") || "[]");
                const count = cart.reduce((sum, i) => sum + i.quantity, 0);
                const el = document.getElementById("cart-count");
                const bottomEl = document.getElementById("bottom-cart-count");
                const mobileEl = document.getElementById("mobile-cart-count");
                if (el) el.textContent = String(count);
                if (bottomEl) bottomEl.textContent = String(count);
                if (mobileEl) mobileEl.textContent = String(count);
            }
            
            // Update cart count on page load
            updateCartCount();
            
            // Force logout button to be visible
            if (mobileLogoutBtn) {
                mobileLogoutBtn.classList.remove('hidden');
                mobileLogoutBtn.style.display = 'flex';
                console.log('Logout button forced to be visible on page load');
            }

            // Mobile menu functionality
            mobileMenuBtn.onclick = (e) => {
                e.stopPropagation();
                mobileMenu.classList.remove('hidden');
                mobileMenuOverlay.classList.remove('hidden');
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
            };
            
            // Mobile menu close
            const closeMobileMenu = () => {
                mobileMenu.classList.add('hidden');
                mobileMenuOverlay.classList.add('hidden');
                document.body.style.overflow = ''; // Restore scrolling
            };
            
            if (mobileMenuClose) {
                mobileMenuClose.onclick = (e) => {
                    e.stopPropagation();
                    closeMobileMenu();
                };
            }
            
            // Close on overlay click
            if (mobileMenuOverlay) {
                mobileMenuOverlay.onclick = (e) => {
                    e.stopPropagation();
                    closeMobileMenu();
                };
            }
            mobileLogoutBtn.onclick = async () => { await logout(); };

            // Update mobile menu content based on auth state
            function updateMobileMenuContent(user, role) {
                if (user) {
                    // Show account section and hide login
                    if (mobileAccountSection) mobileAccountSection.classList.remove('hidden');
                    if (mobileDashboardLink) mobileDashboardLink.classList.remove('hidden');
                    if (mobileAddressLink) mobileAddressLink.classList.remove('hidden');
                    if (mobileLogoutBtn) mobileLogoutBtn.classList.remove('hidden');
                    if (mobileLoginSection) mobileLoginSection.classList.add('hidden');
                    
                    // Update mobile account info
                    if (mobileAccountName) mobileAccountName.textContent = user?.displayName || 'Account';
                    if (mobileAccountEmail) mobileAccountEmail.textContent = user?.email || '';
                    if (mobileDashboardLink) mobileDashboardLink.href = role === 'admin' ? '../admin/' : role === 'pharmacy' ? '../pharmacy/' : '../user-dashboard/';
                } else {
                    // Hide account section and show login
                    if (mobileAccountSection) mobileAccountSection.classList.add('hidden');
                    if (mobileDashboardLink) mobileDashboardLink.classList.add('hidden');
                    if (mobileAddressLink) mobileAddressLink.classList.add('hidden');
                    if (mobileLogoutBtn) mobileLogoutBtn.classList.add('hidden');
                    if (mobileLoginSection) mobileLoginSection.classList.remove('hidden');
                }
                
                // Always ensure logout button is visible for logged-in users
                if (user && mobileLogoutBtn) {
                    mobileLogoutBtn.classList.remove('hidden');
                }
            }

            // Update mobile cart count
            if (mobileCartCount) {
                mobileCartCount.textContent = String(JSON.parse(localStorage.getItem("cart") || "[]").reduce((sum, i) => sum + i.quantity, 0));
            }

            // Update mobile menu content
            updateMobileMenuContent(user, role);

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!accountBtn.closest('.relative').contains(e.target)) {
                    accountMenu.classList.add('hidden');
                }
                if (!mobileMenuBtn.contains(e.target) && !mobileMenu.contains(e.target)) {
                    closeMobileMenu();
                }
            });

            // Load addresses
            await loadAddresses();
        });
    </script>
</body>

</html>
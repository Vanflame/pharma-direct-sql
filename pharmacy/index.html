<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pharmacy Dashboard ‚Äî PHARMA DIRECT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../css/styles.css" />
    <link rel="icon" type="image/x-icon" href="../favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="../img/icon.png">
    <link rel="apple-touch-icon" href="../img/icon.png">
    <link rel="manifest" href="../manifest.json?v=2">
    <meta name="theme-color" content="#10b981">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="PHARMA DIRECT">
    <style>
        /* Ensure badges appear above everything with proper z-index */
        .pharmacy-order-count-badge {
            z-index: 9999 !important;
            position: absolute !important;
            top: -8px !important;
            right: -8px !important;
            min-width: 20px;
            height: 20px;
            border-radius: 50% !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 11px !important;
            font-weight: bold !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important;
            border: 2px solid white !important;
            /* Display controlled by JavaScript based on count > 0 */
        }
        
        /* Ensure tab buttons allow overflow for badges */
        .pharmacy-tab-button {
            overflow: visible !important;
        }
        
        /* Active tab styling */
        .pharmacy-tab-button.active {
            background: linear-gradient(135deg, #10b981, #3b82f6);
            color: white !important;
            border-color: #10b981 !important;
        }
    </style>
</head>

<body class="min-h-screen bg-gray-50">
    <div class="grid md:grid-cols-[260px_1fr] min-h-screen">
        <aside class="bg-white border-r border-gray-200 shadow-sm">
            <!-- Header -->
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-r from-emerald-500 to-blue-600 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">Pharmacy Panel</h1>
                        <p class="text-sm text-gray-500">Business Management</p>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="p-4 space-y-2">
                <button data-tab="products" class="w-full flex items-center gap-3 px-4 py-3 text-left rounded-xl bg-gradient-to-r from-emerald-500 to-blue-600 text-white shadow-sm transition-all duration-200 hover:shadow-md">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                    </svg>
                    <span class="font-medium">Products</span>
                </button>
                
                <button data-tab="orders" class="w-full flex items-center gap-3 px-4 py-3 text-left rounded-xl text-gray-700 hover:bg-gray-100 transition-all duration-200 hover:shadow-sm">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                    </svg>
                    <span class="font-medium">Orders</span>
                </button>
                
                <button data-tab="wallet" class="w-full flex items-center gap-3 px-4 py-3 text-left rounded-xl text-gray-700 hover:bg-gray-100 transition-all duration-200 hover:shadow-sm">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                    </svg>
                    <span class="font-medium">Wallet</span>
                </button>
            </nav>

            <!-- Logout Section -->
            <div class="p-4 border-t border-gray-200 mt-auto">
                <button id="logout" class="w-full flex items-center gap-3 px-4 py-3 text-left rounded-xl text-red-600 hover:bg-red-50 transition-all duration-200 hover:shadow-sm">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                    </svg>
                    <span class="font-medium">Logout</span>
                </button>
            </div>
        </aside>
        <main class="p-4">
            <div id="tab-products" class="space-y-6">
                <div class="bg-gradient-to-r from-emerald-500 to-blue-600 rounded-xl p-6 text-white">
                    <h1 class="text-2xl font-bold">Product Management</h1>
                    <p class="text-emerald-100 mt-1">Add and manage your pharmacy products</p>
                </div>
                <!-- Add Product Button -->
                <div class="bg-white rounded-xl border border-gray-200 p-6 shadow-sm mb-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">Product Management</h3>
                            <p class="text-gray-600 mt-1">Add and manage your pharmacy products</p>
                        </div>
                        <button id="open-product-modal" 
                            class="px-6 py-3 bg-gradient-to-r from-emerald-500 to-blue-600 text-white rounded-lg hover:from-emerald-600 hover:to-blue-700 transition-all duration-200 font-medium flex items-center gap-2 shadow-lg">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Add Product
                        </button>
                    </div>
                </div>
                <div id="products-list" class="bg-white rounded-xl border"></div>
            </div>
            <div id="tab-orders" class="hidden">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold">Orders</h2>
                </div>

                <!-- Order Status Tabs -->
                <div class="bg-white rounded-xl border mb-6">
                    <div class="border-b">
                        <nav class="flex" id="order-status-tabs">
                            <button id="tab-all"
                                class="pharmacy-tab-button flex-1 py-4 px-6 text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium relative overflow-visible">
                                All Orders
                                <span
                                    class="pharmacy-order-count-badge bg-red-500 text-white"
                                    style="display: none;">0</span>
                            </button>
                            <button id="tab-pending"
                                class="pharmacy-tab-button active flex-1 py-4 px-6 text-center border-b-2 border-emerald-500 text-emerald-600 font-medium relative overflow-visible">
                                Pending
                                <span
                                    class="pharmacy-order-count-badge bg-yellow-500 text-white"
                                    style="display: none;">0</span>
                            </button>
                            <button id="tab-confirmed"
                                class="pharmacy-tab-button flex-1 py-4 px-6 text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium relative overflow-visible">
                                Confirmed
                                <span
                                    class="pharmacy-order-count-badge bg-blue-500 text-white"
                                    style="display: none;">0</span>
                            </button>
                            <button id="tab-to-be-received"
                                class="pharmacy-tab-button flex-1 py-4 px-6 text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium relative overflow-visible">
                                To Be Received
                                <span
                                    class="pharmacy-order-count-badge bg-purple-500 text-white"
                                    style="display: none;">0</span>
                            </button>
                            <button id="tab-delivered"
                                class="pharmacy-tab-button flex-1 py-4 px-6 text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium relative overflow-visible">
                                Delivered
                                <span
                                    class="pharmacy-order-count-badge bg-green-500 text-white"
                                    style="display: none;">0</span>
                            </button>
                            <button id="tab-declined"
                                class="pharmacy-tab-button flex-1 py-4 px-6 text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium relative overflow-visible">
                                Declined
                                <span
                                    class="pharmacy-order-count-badge bg-gray-500 text-white"
                                    style="display: none;">0</span>
                            </button>
                        </nav>
                    </div>
                </div>

                <div id="orders-list" class="bg-white rounded-xl border"></div>
            </div>

            <!-- Wallet Tab -->
            <div id="tab-wallet" class="hidden space-y-6">
                <div class="bg-gradient-to-r from-emerald-500 to-blue-600 rounded-xl p-6 text-white">
                    <h2 class="text-2xl font-bold">Wallet Management</h2>
                    <p class="text-emerald-100 mt-1">Manage your earnings and withdrawal requests</p>
                </div>

                <!-- Wallet Balance Cards -->
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl border border-gray-200 p-6 shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex items-center gap-4 mb-6">
                            <div class="w-14 h-14 bg-emerald-100 rounded-full flex items-center justify-center">
                                <svg class="w-7 h-7 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-900">Available Balance</h3>
                                <p class="text-sm text-gray-600">Ready for withdrawal</p>
                            </div>
                        </div>
                        <div class="text-4xl font-bold text-emerald-600" id="wallet-balance">‚Ç±0.00</div>
                    </div>

                    <div class="bg-white rounded-xl border border-gray-200 p-6 shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex items-center gap-4 mb-6">
                            <div class="w-14 h-14 bg-blue-100 rounded-full flex items-center justify-center">
                                <svg class="w-7 h-7 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-900">Pending Balance</h3>
                                <p class="text-sm text-gray-600">Awaiting confirmation</p>
                            </div>
                        </div>
                        <div class="text-4xl font-bold text-blue-600" id="pending-balance">‚Ç±0.00</div>
                    </div>
                </div>

                <!-- Withdrawal Section -->
                <div class="bg-white rounded-xl border border-gray-200 p-6 shadow-sm">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 bg-emerald-100 rounded-full flex items-center justify-center">
                            <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900">Withdrawal Request</h3>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- Amount Section -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Amount to Withdraw *</label>
                            <input type="number" id="withdrawal-amount" min="100" step="0.01"
                                class="w-full rounded-lg border border-gray-300 px-4 py-3 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors" placeholder="0.00" />
                            <p class="text-sm text-gray-500 mt-2">Minimum withdrawal: ‚Ç±100.00</p>
                        </div>

                        <!-- Payment Method Section -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <label class="block text-sm font-medium text-gray-700 mb-3">Payment Method *</label>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <label class="relative cursor-pointer">
                                    <input type="radio" name="payment-method" value="gcash" class="sr-only peer" />
                                    <div class="flex items-center gap-3 p-4 border-2 border-gray-200 rounded-lg peer-checked:border-emerald-500 peer-checked:bg-emerald-50 transition-colors">
                                        <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                            <span class="text-green-600 font-bold text-sm">G</span>
                                        </div>
                                        <span class="font-medium text-gray-700">GCash</span>
                                    </div>
                                </label>
                                
                                <label class="relative cursor-pointer">
                                    <input type="radio" name="payment-method" value="maya" class="sr-only peer" />
                                    <div class="flex items-center gap-3 p-4 border-2 border-gray-200 rounded-lg peer-checked:border-emerald-500 peer-checked:bg-emerald-50 transition-colors">
                                        <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                                            <span class="text-purple-600 font-bold text-sm">M</span>
                                        </div>
                                        <span class="font-medium text-gray-700">Maya</span>
                                    </div>
                                </label>
                                
                                <label class="relative cursor-pointer">
                                    <input type="radio" name="payment-method" value="bank" class="sr-only peer" />
                                    <div class="flex items-center gap-3 p-4 border-2 border-gray-200 rounded-lg peer-checked:border-emerald-500 peer-checked:bg-emerald-50 transition-colors">
                                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                            <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                                            </svg>
                                        </div>
                                        <span class="font-medium text-gray-700">Bank Transfer</span>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Account Details Section -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="text-lg font-semibold text-gray-900 mb-4">Account Details</h4>
                            
                            <!-- GCash/Maya Details -->
                            <div id="digital-wallet-details" class="hidden space-y-4">
                        <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Mobile Number *</label>
                                    <input type="tel" id="mobile-number" placeholder="09XX XXX XXXX"
                                        class="w-full rounded-lg border border-gray-300 px-4 py-3 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Account Name *</label>
                                    <input type="text" id="account-name" placeholder="Full Name"
                                        class="w-full rounded-lg border border-gray-300 px-4 py-3 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors" />
                                </div>
                            </div>

                            <!-- Bank Details -->
                            <div id="bank-details" class="hidden space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Bank Name *</label>
                                        <select id="bank-name" class="w-full rounded-lg border border-gray-300 px-4 py-3 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors">
                                            <option value="">Select Bank</option>
                                            <option value="BDO">BDO (Banco de Oro)</option>
                                            <option value="BPI">BPI (Bank of the Philippine Islands)</option>
                                            <option value="Metrobank">Metrobank</option>
                                            <option value="Landbank">Landbank</option>
                                            <option value="PNB">PNB (Philippine National Bank)</option>
                                            <option value="Security Bank">Security Bank</option>
                                            <option value="Union Bank">Union Bank</option>
                                            <option value="RCBC">RCBC</option>
                                            <option value="EastWest Bank">EastWest Bank</option>
                                            <option value="Chinabank">Chinabank</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Account Number *</label>
                                <input type="text" id="account-number" placeholder="Account Number"
                                            class="w-full rounded-lg border border-gray-300 px-4 py-3 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors" />
                            </div>
                        </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Account Name *</label>
                                    <input type="text" id="bank-account-name" placeholder="Full Name as it appears on bank account"
                                        class="w-full rounded-lg border border-gray-300 px-4 py-3 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors" />
                                </div>
                            </div>
                        </div>

                        <button id="request-withdrawal"
                            class="w-full bg-emerald-600 text-white py-4 px-6 rounded-lg font-semibold hover:bg-emerald-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                            </svg>
                            Request Withdrawal
                        </button>
                    </div>
                </div>

                <!-- Recent Transactions -->
                <div class="bg-white rounded-xl border border-gray-200 p-6 shadow-sm">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900">Recent Transactions</h3>
                    </div>
                    <div id="transactions-list" class="space-y-3">
                        <!-- Transactions will be loaded here -->
                    </div>
                </div>
            </div>
        </main>

        <!-- Product Modal -->
        <div id="product-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
            <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                <!-- Modal Header -->
                <div class="bg-gradient-to-r from-emerald-500 to-blue-600 text-white p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 id="product-modal-title" class="text-2xl font-bold">Add Product</h2>
                            <p class="text-emerald-100 mt-1">Add a new product to your inventory</p>
                        </div>
                        <button id="close-product-modal" class="text-white hover:text-gray-200 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Modal Body -->
                <div class="p-6 overflow-y-auto max-h-[calc(90vh-140px)]">
                    <form id="product-modal-form" class="space-y-6">
                        <!-- Basic Information -->
                        <div class="bg-gray-50 rounded-xl p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                Basic Information
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Product Name *</label>
                                    <input type="text" name="name" required
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors"
                                        placeholder="Enter product name">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Category *</label>
                                    <select name="category" required
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors">
                                        <option value="">Select Category</option>
                                        <option value="cold-flu">Cold & Flu</option>
                                        <option value="pain-relief">Pain Relief</option>
                                        <option value="vitamins">Vitamins & Supplements</option>
                                        <option value="skincare">Skincare</option>
                                        <option value="digestive">Digestive Health</option>
                                        <option value="respiratory">Respiratory</option>
                                        <option value="diabetes">Diabetes Care</option>
                                        <option value="heart">Heart Health</option>
                                        <option value="mental-health">Mental Health</option>
                                        <option value="women-health">Women's Health</option>
                                        <option value="men-health">Men's Health</option>
                                        <option value="children">Children's Health</option>
                                        <option value="elderly">Elderly Care</option>
                                        <option value="first-aid">First Aid</option>
                                        <option value="medical-devices">Medical Devices</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                <textarea name="description" rows="3"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors resize-none"
                                    placeholder="Product description..."></textarea>
                            </div>
                        </div>

                        <!-- Pricing & Inventory -->
                        <div class="bg-gray-50 rounded-xl p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                </svg>
                                Pricing & Inventory
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Price (‚Ç±) *</label>
                                    <input type="number" name="price" step="0.01" min="0" required
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors"
                                        placeholder="0.00">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Discount (%)</label>
                                    <input type="number" name="discount" step="0.01" min="0" max="100"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors"
                                        placeholder="0" value="0">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Stock Quantity *</label>
                                    <input type="number" name="stock" min="0" required
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors"
                                        placeholder="0">
                                </div>
                            </div>
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Image URL</label>
                                <input type="url" name="imageURL"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors"
                                    placeholder="https://example.com/image.jpg">
                            </div>
                        </div>

                        <!-- Product Settings -->
                        <div class="bg-gray-50 rounded-xl p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                Product Settings
                            </h3>
                            <div class="space-y-4">
                                <label class="flex items-center">
                                    <input type="checkbox" name="featured" class="w-4 h-4 text-emerald-600 border-gray-300 rounded focus:ring-emerald-500">
                                    <span class="ml-3 text-sm font-medium text-gray-700">Featured Product</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="prescription" class="w-4 h-4 text-emerald-600 border-gray-300 rounded focus:ring-emerald-500">
                                    <span class="ml-3 text-sm font-medium text-gray-700">Requires Prescription</span>
                                </label>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Modal Footer -->
                <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-3">
                    <button id="cancel-product-modal" type="button"
                        class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                        Cancel
                    </button>
                    <button id="save-product-modal" type="button"
                        class="px-6 py-2 bg-gradient-to-r from-emerald-500 to-blue-600 text-white rounded-lg hover:from-emerald-600 hover:to-blue-700 transition-all duration-200 font-medium">
                        <span id="save-product-text">Add Product</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/imageCache.js"></script>
    <script src="../js/loading.js"></script>
    <script type="module">
        import { formatCurrency, safeDateConversion, formatDate, formatRelativeTime, showError, showSuccess, getProfessionalErrorMessage, setButtonLoading, showLoadingModal, hideLoadingModal } from '../js/supabase-config.js';
        import { logout, onAuthStateChanged } from '../js/supabase-auth.js';
        import { supabase } from '../js/supabase-auth.js';
        import { TABLES } from '../js/supabase-config.js';
        import { getProductsByPharmacy, addProduct, updateProduct, deleteProduct, getOrdersByPharmacy, updateOrderStage, updatePharmacyWallet } from '../js/supabase-database.js';

        const tabs = document.querySelectorAll('aside [data-tab]');
        const panels = {
            products: document.getElementById('tab-products'),
            orders: document.getElementById('tab-orders'),
            wallet: document.getElementById('tab-wallet'),
        };
        tabs.forEach(btn => btn.addEventListener('click', async () => {
            // Remove active styling from all tabs
            tabs.forEach(b => {
                b.classList.remove('bg-gradient-to-r', 'from-emerald-500', 'to-blue-600', 'text-white', 'shadow-sm');
                b.classList.add('text-gray-700');
            });
            
            // Add active styling to clicked tab
            btn.classList.remove('text-gray-700');
            btn.classList.add('bg-gradient-to-r', 'from-emerald-500', 'to-blue-600', 'text-white', 'shadow-sm');
            
            // Show/hide panels
            Object.values(panels).forEach(p => p.classList.add('hidden'));
            panels[btn.dataset.tab].classList.remove('hidden');

            // Load wallet data when wallet tab is selected
            if (btn.dataset.tab === 'wallet') {
                await loadWalletData();
                setupPaymentMethodHandlers();
            }
        }));

        let pharmacyId = null;

        async function ensurePharmacy(user) {
            console.log('üîç ensurePharmacy: Checking user:', user.id);
            const { data: userDoc } = await supabase.from(TABLES.users).select('*').eq('uid', user.id).single();
            const exists = !!userDoc;
            const data = userDoc;
            const role = exists ? (data.role || 'user') : 'user';
            console.log('üîç ensurePharmacy: Document exists:', exists, 'Role:', role);
            
            if (!exists || role !== 'pharmacy') {
                console.log('‚ùå ensurePharmacy: User is not pharmacy, redirecting to main page');
                window.location.href = '../';
                return;
            }
            if (data.disabled) {
                console.log('‚ùå ensurePharmacy: User is disabled, redirecting to disabled page');
                window.location.href = '../disabled/';
                return;
            }
            
            // Get the pharmacy record using the user database ID
            const { data: pharmacyDoc } = await supabase
                .from(TABLES.pharmacies)
                .select('*')
                .eq('user_id', data.id) // Use database user ID to find pharmacy
                .single();
            
            if (!pharmacyDoc) {
                console.log('‚ùå ensurePharmacy: No pharmacy record found for user');
                window.location.href = '../';
                return;
            }
            
            // Use pharmacy table ID as pharmacyId (not user table ID)
            pharmacyId = pharmacyDoc.id;
            console.log('üîç ensurePharmacy: Using pharmacy ID:', pharmacyId);
        }

        let editingProductId = null;
        
        // Category mapping from name to UUID
        const categoryMap = {
            "Respiratory": "05f2d0e8-2629-4e8d-8121-cb3587872d81",
            "Eye Care": "40094e15-6366-4fa4-8100-58131400187f",
            "Pain Relief": "5b8e9786-6a0b-4fe8-b227-9d16aa8e499a",
            "Skin Care": "76434f0e-b1bf-418f-919f-38e2ce225c0b",
            "Personal Care": "858bb0de-9a5c-421a-8eed-eb2cfab1b1a9",
            "Fever & Flu": "b1754f65-794b-4140-9c6e-e3074ce71ed1",
            "Others": "b2e7b92c-6c2d-4e21-a8bb-4f0bbffdc000",
            "Vitamins & Supplements": "b4ced4bd-19f7-440a-91ad-7642cc4e0c02",
            "First Aid": "bf1f7354-d790-4b1b-a71f-c661695b7a0b",
            "Baby Care": "c3c250d9-92ce-4a80-8f6f-d43bb84cb991",
            "Digestive Health": "fdc69433-aecb-4096-b47a-7913af497532"
        };

        async function loadProducts() {
            console.log('üîç Loading products for pharmacy ID:', pharmacyId);
            const { data: products, error } = await supabase.from(TABLES.products).select('*').eq('pharmacy_id', pharmacyId);
            console.log('üîç Products query result:', { products, error });
            
            // Store all products for filtering
            allProducts = products || [];
            
            // Also check if there are products with wrong pharmacy_id (auth UID)
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                const { data: wrongProducts } = await supabase.from(TABLES.products).select('*').eq('pharmacy_id', user.id);
                console.log('üîç Products with wrong pharmacy_id (auth UID):', wrongProducts);
            }
            
            // Check if we have active filters
            const hasActiveFilters = currentProductSearch || currentCategoryFilter !== 'all' || currentStatusFilter !== 'all';
            
            // If we have active filters, just call the filter function instead of re-rendering everything
            if (hasActiveFilters) {
                console.log('üîç Active filters detected, calling filterProducts...');
                filterProducts();
                return;
            }
            
            // For initial load without filters, render the full structure
            const el = document.getElementById('products-list');

            if (!allProducts || allProducts.length === 0) {
                el.innerHTML = `
                    <div class="p-8 text-center">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">No products</h3>
                        <p class="mt-1 text-sm text-gray-500">Get started by adding your first product.</p>
                    </div>
                `;
                return;
            }

            // Calculate product statistics (always use all products for stats)
            const totalProducts = allProducts.length;
            const activeProducts = allProducts.filter(p => !p.disabled && p.stock > 0).length;
            const soldOutProducts = allProducts.filter(p => p.stock === 0).length;
            const disabledProducts = allProducts.filter(p => p.disabled).length;

            el.innerHTML = `
                <!-- Product Statistics -->
                <div class="bg-white rounded-xl border mb-6">
                    <div class="p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            Product Statistics
                        </h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                            <!-- Active Products (Most Important) -->
                            <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg p-4 h-full">
                                <div class="flex items-center justify-between h-full">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0">
                                            <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                        </div>
                                        <div>
                                            <p class="text-sm font-medium text-green-800">Active Products</p>
                                            <p class="text-2xl font-bold text-green-900">${activeProducts}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Total Products -->
                            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-4 h-full">
                                <div class="flex items-center justify-between h-full">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                            </svg>
                                        </div>
                                        <div>
                                            <p class="text-sm font-medium text-blue-800">Total Products</p>
                                            <p class="text-2xl font-bold text-blue-900">${totalProducts}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Sold Out Products -->
                            <div class="bg-gradient-to-r from-red-50 to-pink-50 border border-red-200 rounded-lg p-4 h-full">
                                <div class="flex items-center justify-between h-full">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0">
                                            <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                            </svg>
                                        </div>
                                        <div>
                                            <p class="text-sm font-medium text-red-800">Sold Out</p>
                                            <p class="text-2xl font-bold text-red-900">${soldOutProducts}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Disabled Products -->
                            <div class="bg-gradient-to-r from-gray-50 to-slate-50 border border-gray-200 rounded-lg p-4 h-full">
                                <div class="flex items-center justify-between h-full">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center flex-shrink-0">
                                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L18.364 5.636M5.636 18.364l12.728-12.728"></path>
                                            </svg>
                                        </div>
                                        <div>
                                            <p class="text-sm font-medium text-gray-800">Disabled</p>
                                            <p class="text-2xl font-bold text-gray-900">${disabledProducts}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-gradient-to-r from-emerald-500 to-blue-600 rounded-t-xl p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                    <h3 class="text-xl font-bold">Your Products</h3>
                            <p class="text-emerald-100 mt-1">${allProducts.length} product${allProducts.length !== 1 ? 's' : ''} in your inventory</p>
                </div>
                    </div>
                </div>
                
                <!-- Search and Filter Section -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex flex-col md:flex-row gap-4 items-center justify-between">
                        <!-- Search Input -->
                        <div class="flex-1 max-w-md">
                            <div class="relative">
                                <input 
                                    type="text" 
                                    id="product-search-input" 
                                    placeholder="Search products by name or description..." 
                                    class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors"
                                >
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Filter Controls -->
                        <div class="flex items-center gap-4">
                            <!-- Category Filter -->
                            <div class="flex items-center gap-2">
                                <label class="text-sm font-medium text-gray-700">Category:</label>
                                <select id="category-filter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                                    <option value="all">All Categories</option>
                                    <option value="Personal Care">Personal Care</option>
                                    <option value="Health & Wellness">Health & Wellness</option>
                                    <option value="Vitamins & Supplements">Vitamins & Supplements</option>
                                    <option value="Medical Supplies">Medical Supplies</option>
                                    <option value="Baby Care">Baby Care</option>
                                    <option value="Beauty & Cosmetics">Beauty & Cosmetics</option>
                                    <option value="Home Health">Home Health</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            
                            <!-- Status Filter -->
                            <div class="flex items-center gap-2">
                                <label class="text-sm font-medium text-gray-700">Status:</label>
                                <select id="status-filter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                                    <option value="all">All Status</option>
                                    <option value="active">Active Only</option>
                                    <option value="disabled">Disabled Only</option>
                                    <option value="out-of-stock">Out of Stock</option>
                                    <option value="low-stock">Low Stock</option>
                                </select>
                            </div>
                            
                            <!-- Clear Filters Button -->
                            <button 
                                id="clear-product-filters" 
                                class="px-4 py-2 text-gray-600 hover:text-gray-800 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
                            >
                                Clear
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="p-6 space-y-4 bg-gray-50">
                    ${allProducts.map(product => {
                const p = {
                    ...product,
                    imageURL: product.image_url, // Transform snake_case to camelCase
                    categoryId: product.category_id,
                    pharmacyId: product.pharmacy_id
                };
                const isOutOfStock = p.stock === 0;
                const isDisabled = p.disabled;
                const discountPrice = p.discount > 0 ? (p.price * (1 - p.discount / 100)).toFixed(2) : null;
                
                return `
                            <div class="relative bg-white rounded-lg border border-gray-200 p-6 hover:shadow-lg transition-shadow duration-200 ${isDisabled ? 'opacity-60 bg-gray-50 border-gray-300' : ''} ${isOutOfStock ? 'opacity-75' : ''}">
                                <!-- Disabled Overlay Badge -->
                                ${isDisabled ? `
                                    <div class="absolute top-2 right-2 bg-red-500 text-white px-2 py-1 rounded-full text-xs font-medium z-10">
                                        DISABLED
                                    </div>
                                ` : ''}
                                <div class="flex items-start justify-between">
                                    
                                    <!-- Product Image & Info -->
                                    <div class="flex items-start gap-4 flex-1">
                                        <div class="relative">
                                        <img src="${p.imageURL || 'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?q=80&w=100&auto=format&fit=crop'}" 
                                                 class="w-20 h-20 rounded-lg border object-cover ${isDisabled ? 'grayscale' : ''}" />
                                            ${isOutOfStock ? `
                                                <div class="absolute inset-0 bg-red-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                                                    <span class="bg-red-500 text-white text-xs px-2 py-1 rounded-full font-medium">Sold Out</span>
                                                </div>
                                            ` : ''}
                                            ${isDisabled && !isOutOfStock ? `
                                                <div class="absolute inset-0 bg-gray-500 bg-opacity-30 rounded-lg flex items-center justify-center">
                                                    <span class="bg-gray-600 text-white text-xs px-2 py-1 rounded-full font-medium">Disabled</span>
                                                </div>
                                            ` : ''}
                                        </div>
                                        
                                        <div class="flex-1">
                                            <div class="flex items-start justify-between mb-2">
                                                <div>
                                                    <h4 class="text-lg font-semibold text-gray-900 mb-1">${p.name}</h4>
                                                    <p class="text-sm text-gray-600">${Object.keys(categoryMap).find(name => categoryMap[name] === p.category_id) || 'Uncategorized'}</p>
                                            </div>
                                                
                                                <!-- Status Badges -->
                                                <div class="flex flex-wrap gap-1">
                                                    ${p.featured ? '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Featured</span>' : ''}
                                                    ${p.prescription ? '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Prescription</span>' : ''}
                                                </div>
                                            </div>
                                            
                                            ${p.description ? `<p class="text-sm text-gray-600 mb-3 line-clamp-2">${p.description}</p>` : ''}
                                            
                                            <!-- Pricing & Stock -->
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center gap-3">
                                                    ${discountPrice ? `
                                                    <div class="flex items-center gap-2">
                                                            <span class="text-xl font-bold text-emerald-600">‚Ç±${discountPrice}</span>
                                                        <span class="text-sm text-gray-500 line-through">‚Ç±${p.price.toFixed(2)}</span>
                                                            <span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full font-medium">${p.discount}% OFF</span>
                                                    </div>
                                                ` : `
                                                        <span class="text-xl font-bold text-emerald-600">‚Ç±${p.price.toFixed(2)}</span>
                                                `}
                                            </div>
                                                
                                                <div class="flex items-center gap-4">
                                                    <div class="text-right">
                                                        <div class="text-sm text-gray-500">Stock</div>
                                                        <div class="text-lg font-semibold ${isOutOfStock ? 'text-red-600' : 'text-gray-900'}">${p.stock}</div>
                                        </div>
                                    </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Action Buttons -->
                                    <div class="flex flex-col gap-2 ml-4">
                                        <button onclick="editProduct('${p.id}')" class="flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg text-sm font-medium hover:bg-blue-600 transition-colors">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                            </svg>
                                            Edit
                                        </button>
                                        <button onclick="toggleProductStatus('${p.id}', ${p.disabled})" class="flex items-center gap-2 px-4 py-2 ${p.disabled ? 'bg-green-500 hover:bg-green-600' : 'bg-orange-500 hover:bg-orange-600'} text-white rounded-lg text-sm font-medium transition-colors">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                ${p.disabled ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>' : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>'}
                                            </svg>
                                            ${p.disabled ? 'Enable' : 'Disable'}
                                        </button>
                                        <button onclick="deleteProduct('${p.id}')" class="flex items-center gap-2 px-4 py-2 bg-red-500 text-white rounded-lg text-sm font-medium hover:bg-red-600 transition-colors">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
            }).join('')}
                </div>
            `;
        }

        let currentOrderStatus = 'pending';
        let allOrders = [];
        let orderCounts = { all: 0, pending: 0, confirmed: 0, 'to-be-received': 0, delivered: 0, declined: 0 };

        function updateOrderCounts() {
            // Reset counts
            orderCounts = { all: 0, pending: 0, confirmed: 0, 'to-be-received': 0, delivered: 0, declined: 0 };

            // Count orders by status (only orders containing pharmacy's products)
            allOrders.forEach(({ order }) => {
                const status = order.stage.toLowerCase().replace(/\s+/g, '-');
                if (status in orderCounts) {
                    orderCounts[status]++;
                }
                orderCounts.all++;
            });

            // Update tab badges (simple approach like user track.html)
            document.querySelectorAll('.pharmacy-tab-button').forEach(tab => {
                const tabId = tab.id.replace('tab-', '');
                const badge = tab.querySelector('.pharmacy-order-count-badge');

                if (badge) {
                    const count = orderCounts[tabId] || 0;
                    badge.textContent = count;
                    // Hide badges with 0 count for cleaner professional look
                    if (count > 0) {
                        badge.style.display = 'inline-flex';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            });

            console.log('Pharmacy order counts:', orderCounts);
        }

        function renderFilteredOrders() {
            const filteredOrders = currentOrderStatus === 'all'
                ? allOrders
                : allOrders.filter(({ order }) => {
                    const stage = order.stage.toLowerCase().replace(/\s+/g, '-');
                    // Handle special case for declined tab (matches both 'declined' and 'cancelled')
                    if (currentOrderStatus === 'declined') {
                        return stage === 'declined' || stage === 'cancelled';
                    }
                    return stage === currentOrderStatus;
                });

            const el = document.getElementById('orders-list');
            el.innerHTML = '';

            if (filteredOrders.length === 0) {
                el.innerHTML = `
                    <div class="p-8 text-center">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">No orders</h3>
                        <p class="mt-1 text-sm text-gray-500">Orders will appear here when customers place them.</p>
                    </div>
                `;
                return;
            }

            el.innerHTML = `
                <div class="bg-gradient-to-r from-emerald-500 to-blue-600 rounded-t-xl p-6 text-white">
                    <h3 class="text-xl font-bold">Recent Orders</h3>
                    <p class="text-emerald-100 mt-1">${filteredOrders.length} order${filteredOrders.length !== 1 ? 's' : ''} found</p>
                </div>
                <div class="p-6 space-y-6 bg-gray-50">
                    ${filteredOrders.map(({ order }) => {
                const o = order;

                // Handle Supabase timestamp objects properly
                const orderDate = safeDateConversion(o.created_at).toLocaleString();

                // For Supabase, we'll need to fetch order items separately or display basic info
                const items = 'Order items'; // Will be populated when we load order details

                // Handle Supabase customer info structure
                const customerName = o.customer_name || 'Unknown';
                const customerPhone = o.customer_phone || 'Not provided';
                const customerEmail = o.customer_email || 'Not provided';

                return `
                            <div class="bg-white border border-gray-200 rounded-xl p-6 hover:shadow-lg transition-shadow duration-200">
                                <!-- Order Header -->
                                <div class="flex items-center justify-between mb-6">
                                    <div class="flex items-center gap-4">
                                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                                            </svg>
                                        </div>
                                        <div>
                                            <h4 class="text-xl font-bold text-gray-900">Order #${o.id.slice(-6)}</h4>
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStageColor(o.stage)}">
                                                ${o.stage}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm text-gray-500">Order Date</div>
                                        <div class="text-sm font-medium text-gray-900">${orderDate}</div>
                                    </div>
                                </div>

                                <!-- Order Content -->
                                <div class="grid md:grid-cols-2 gap-6 mb-4">
                                    <!-- Left Column: Items & Payment -->
                                    <div class="space-y-4">
                                        <div>
                                            <h5 class="font-medium text-gray-900 mb-2">Items Ordered</h5>
                                            <div class="bg-gray-50 rounded-lg p-3">
                                                <p class="text-sm text-gray-700">${items}</p>
                                            </div>
                                        </div>
                                        
                                        <div class="grid grid-cols-2 gap-4">
                                            <div class="bg-blue-50 rounded-lg p-3">
                                                <p class="text-xs font-medium text-blue-600 uppercase tracking-wide">Total Amount</p>
                                                <p class="text-lg font-semibold text-blue-900">‚Ç±${o.total.toFixed(2)}</p>
                                            </div>
                                            <div class="bg-green-50 rounded-lg p-3">
                                                <p class="text-xs font-medium text-green-600 uppercase tracking-wide">Payment</p>
                                                <p class="text-sm font-semibold text-green-900">${o.payment_method}</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Right Column: Customer & Delivery -->
                                    <div class="space-y-4">
                                        <div>
                                            <h5 class="font-medium text-gray-900 mb-2">Customer Information</h5>
                                            <div class="bg-gray-50 rounded-lg p-3 space-y-1">
                                                <p class="text-sm"><span class="font-medium">Name:</span> ${customerName}</p>
                                                ${customerPhone !== 'Not provided' ? `<p class="text-sm"><span class="font-medium">Phone:</span> ${customerPhone}</p>` : ''}
                                                ${customerEmail !== 'Not provided' ? `<p class="text-sm"><span class="font-medium">Email:</span> ${customerEmail}</p>` : ''}
                                            </div>
                                        </div>
                                        
                                        ${o.deliveryAddress ? `
                                        <div>
                                            <h5 class="font-medium text-gray-900 mb-2">Delivery Address</h5>
                                            <div class="bg-gray-50 rounded-lg p-3">
                                                <p class="text-sm text-gray-700">${o.deliveryAddress}</p>
                                            </div>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="flex flex-wrap gap-2 pt-4 border-t border-gray-200">
                                    <button onclick="viewOrderDetails('${o.id}')" class="flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg text-sm font-medium hover:bg-blue-600 transition-colors">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                        </svg>
                                        View Details
                                    </button>
                                        ${o.stage === 'Pending' ? `
                                        <button onclick="confirmOrder('${o.id}')" class="flex items-center gap-2 px-4 py-2 bg-emerald-500 text-white rounded-lg text-sm font-medium hover:bg-emerald-600 transition-colors">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                                Confirm & Deduct Stock
                                            </button>
                                        <button onclick="declineOrder('${o.id}')" class="flex items-center gap-2 px-4 py-2 bg-red-500 text-white rounded-lg text-sm font-medium hover:bg-red-600 transition-colors">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                                Decline Order
                                            </button>
                                        ` : ''}
                                        ${getNextActionText(o.stage) ? `
                                        <button onclick="advanceOrder('${o.id}')" class="flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg text-sm font-medium hover:bg-blue-600 transition-colors">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                                            </svg>
                                                ${getNextActionText(o.stage)}
                                            </button>
                                        ` : ''}
                                </div>
                            </div>
                        `;
            }).join('')}
                </div>
            `;
        }

        function loadOrders(status = 'pending') {
            currentOrderStatus = status;

            // Update tab styling
            document.querySelectorAll('.pharmacy-tab-button').forEach(tab => {
                if (tab.id === `tab-${status}`) {
                    tab.classList.add('active', 'border-emerald-500', 'text-emerald-600');
                    tab.classList.remove('border-transparent', 'text-gray-500');
                } else {
                    tab.classList.remove('active', 'border-emerald-500', 'text-emerald-600');
                    tab.classList.add('border-transparent', 'text-gray-500');
                }
            });

            // Render filtered orders (client-side filtering)
            renderFilteredOrders();
        }

        // Load all orders and set up real-time updates
        async function loadAllOrders() {
            // Show initial loading state
            const el = document.getElementById('orders-list');
            el.innerHTML = `
                <div class="flex items-center justify-center p-12">
                    <div class="text-center">
                        <div class="inline-flex items-center px-4 py-2 font-semibold leading-6 text-sm shadow rounded-md text-white bg-emerald-500 hover:bg-emerald-400 transition ease-in-out duration-150 cursor-not-allowed">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Loading orders...
                        </div>
                    </div>
                </div>
            `;

            // Load orders using Supabase
            const { data: orders, error } = await supabase
                .from(TABLES.orders)
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading orders:', error);
                return;
            }

            allOrders = [];

            // Process all orders and filter for pharmacy's products
            for (const order of orders || []) {
                // Check if this pharmacy owns any products in this order
                const ownsItems = await pharmacyOwnsOrderItems(order);
                if (ownsItems) {
                    allOrders.push({ order });
                }
            }

            // Update counts and render
            updateOrderCounts();
            renderFilteredOrders();
        }

        // Helper function to check if pharmacy owns products in the order
        async function pharmacyOwnsOrderItems(order) {
            // Get order items from Supabase
            const { data: orderItems } = await supabase
                .from(TABLES.order_items)
                .select('*')
                .eq('order_id', order.id);

            if (!orderItems || orderItems.length === 0) {
                return false;
            }

            for (const item of orderItems) {
                // Check if item has product_id and if pharmacy owns it
                if (item.product_id) {
                    const { data: product } = await supabase
                        .from(TABLES.products)
                        .select('*')
                        .eq('id', item.product_id)
                        .single();

                    if (product && product.pharmacy_id === pharmacyId) {
                            return true; // Pharmacy owns at least one product in this order
                        }
                } else if (item.product_name) {
                    // Fallback: find product by name
                    const { data: products } = await supabase
                        .from(TABLES.products)
                        .select('*')
                        .eq('name', item.product_name)
                        .eq('pharmacy_id', pharmacyId);

                    if (products && products.length > 0) {
                        return true; // Pharmacy owns at least one product in this order
                    }
                }
            }
            return false; // Pharmacy doesn't own any products in this order
        }

        // Make test function globally available
        window.testPharmacyPermissions = testPharmacyPermissions;
        
        // Migration function to fix products with wrong pharmacy_id
        window.fixProductsPharmacyId = async function() {
            try {
                console.log('üîß Fixing products with wrong pharmacy_id...');
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    console.error('No user logged in');
                    return;
                }
                
                // Get the database user record
                const { data: userDoc } = await supabase.from(TABLES.users).select('*').eq('uid', user.id).single();
                if (!userDoc) {
                    console.error('No user document found');
                    return;
                }
                
                console.log('Database user ID:', userDoc.id);
                
                // Check if there are products with wrong pharmacy_id (auth UID)
                const { data: wrongProducts } = await supabase
                    .from(TABLES.products)
                    .select('*')
                    .eq('pharmacy_id', user.id); // Auth UID
                
                if (wrongProducts && wrongProducts.length > 0) {
                    console.log(`Found ${wrongProducts.length} products with wrong pharmacy_id, updating...`);
                    const { error: updateError } = await supabase
                        .from(TABLES.products)
                        .update({ pharmacy_id: userDoc.id }) // Update to database user ID
                        .eq('pharmacy_id', user.id); // Where current pharmacy_id is auth UID
                    
                    if (updateError) {
                        console.error('Error updating products:', updateError);
                    } else {
                        console.log('‚úÖ Products updated successfully');
                        alert(`${wrongProducts.length} products fixed! Please refresh the page.`);
                    }
                } else {
                    console.log('No products with wrong pharmacy_id found');
                }
            } catch (error) {
                console.error('Error fixing products:', error);
            }
        };
        
        // Migration function to fix pharmacy records with wrong user_id
        window.fixPharmacyRecord = async function() {
            try {
                console.log('üîß Fixing pharmacy record for current user...');
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    console.error('No user logged in');
                    return;
                }
                
                // Get the database user record
                const { data: userDoc } = await supabase.from(TABLES.users).select('*').eq('uid', user.id).single();
                if (!userDoc) {
                    console.error('No user document found');
                    return;
                }
                
                console.log('Database user ID:', userDoc.id);
                
                // Check if pharmacy record exists with wrong user_id
                const { data: wrongPharmacy } = await supabase
                    .from(TABLES.pharmacies)
                    .select('*')
                    .eq('user_id', user.id) // Auth UID
                    .single();
                
                if (wrongPharmacy) {
                    console.log('Found pharmacy record with wrong user_id, updating...');
                    const { error: updateError } = await supabase
                        .from(TABLES.pharmacies)
                        .update({ user_id: userDoc.id }) // Update to database user ID
                        .eq('user_id', user.id); // Where current user_id is auth UID
                    
                    if (updateError) {
                        console.error('Error updating pharmacy record:', updateError);
                    } else {
                        console.log('‚úÖ Pharmacy record updated successfully');
                        alert('Pharmacy record fixed! Please refresh the page.');
                    }
                } else {
                    console.log('No pharmacy record with wrong user_id found');
                }
            } catch (error) {
                console.error('Error fixing pharmacy record:', error);
            }
        };

        // Test function for pharmacy permissions
        async function testPharmacyPermissions() {
            console.log('üè• TESTING PHARMACY PERMISSIONS');
            console.log('Pharmacy ID:', pharmacyId);

            try {
                // Test 1: Can we read our own products?
                console.log('üì¶ Testing product read permissions...');
                const { data: products, error: productsError } = await supabase
                    .from(TABLES.products)
                    .select('*')
                    .eq('pharmacy_id', pharmacyId);
                
                if (productsError) {
                    console.error('‚ùå Product read error:', productsError);
                } else {
                    console.log(`‚úÖ Can read ${products?.length || 0} products`);
                }

                // Test 2: Can we update our own products?
                if (products && products.length > 0) {
                    const testProduct = products[0];
                    const originalStock = testProduct.stock;

                    console.log('üìù Testing product update permissions...');
                    const { error: updateError } = await supabase
                        .from(TABLES.products)
                        .update({
                        stock: originalStock,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', testProduct.id);
                    
                    if (updateError) {
                        console.error('‚ùå Product update error:', updateError);
                    } else {
                    console.log('‚úÖ Can update products');
                    }
                }

                // Test 3: Can we read orders?
                console.log('üìã Testing order read permissions...');
                const { data: orders, error: ordersError } = await supabase
                    .from(TABLES.orders)
                    .select('*')
                    .limit(1);
                
                if (ordersError) {
                    console.error('‚ùå Order read error:', ordersError);
                } else {
                    console.log(`‚úÖ Can read ${orders?.length || 0} orders`);
                }

                // Test 4: Can we update orders?
                if (orders && orders.length > 0) {
                    const testOrder = orders[0];
                    const originalStage = testOrder.stage;

                    console.log('üìù Testing order update permissions...');
                    const { error: orderUpdateError } = await supabase
                        .from(TABLES.orders)
                        .update({
                        stage: originalStage,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', testOrder.id);
                    
                    if (orderUpdateError) {
                        console.error('‚ùå Order update error:', orderUpdateError);
                    } else {
                    console.log('‚úÖ Can update orders');
                    }
                }

                console.log('üéâ ALL PHARMACY PERMISSIONS WORKING!');

            } catch (error) {
                console.error('‚ùå PERMISSION TEST FAILED:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);

                if (error.code === 'permission-denied') {
                    console.log('üîß SOLUTION: Check Supabase RLS policies');
                    console.log('   Update your Row Level Security policies in Supabase');
                }
            }
            console.log('=====================================');
        };

        // Global functions for order management
        window.declineOrder = async (orderId) => {
            console.log('‚ùå Declining order:', orderId);

            if (!confirm('Are you sure you want to decline this order? This action cannot be undone.')) {
                return;
            }

            // Find the decline button and set loading state
            const declineButton = document.querySelector(`button[onclick="declineOrder('${orderId}')"]`);
            setButtonLoading(declineButton, true, 'Declining...');

            try {
                const { error } = await supabase
                    .from(TABLES.orders)
                    .update({
                    stage: 'Declined',
                        declined_at: new Date().toISOString(),
                        declined_by: pharmacyId,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', orderId);
                
                if (error) throw error;

                console.log('‚úÖ Order declined successfully');
                showSuccess('Order has been declined.');
                // Orders will be updated automatically via real-time listener

            } catch (error) {
                console.error('‚ùå Error declining order:', error);
                alert(getProfessionalErrorMessage(error));
            } finally {
                setButtonLoading(declineButton, false);
            }
        };

        window.confirmOrder = async (orderId) => {
            console.log('üõí Starting order confirmation for:', orderId);

            // Find the confirm button and set loading state
            const confirmButton = document.querySelector(`button[onclick="confirmOrder('${orderId}')"]`);
            setButtonLoading(confirmButton, true, 'Confirming...');

            try {
            const { data: order, error: orderError } = await supabase
                .from(TABLES.orders)
                .select('*')
                .eq('id', orderId)
                .single();

            if (orderError) throw orderError;

            if (order) {

                // Check if pharmacy owns products in this order
                const ownsItems = await pharmacyOwnsOrderItems(order);
                if (!ownsItems) {
                    alert('You can only confirm orders that contain your products.');
                    console.warn('‚ùå Pharmacy does not own any products in this order');
                    return;
                }

                console.log('‚úÖ Pharmacy owns products in this order, proceeding with confirmation');

                // Validate stock availability before confirming order
                console.log('üîç Validating stock availability for all items...');
                const insufficientStockItems = [];

                // Get order items from Supabase
                const { data: orderItems } = await supabase
                    .from(TABLES.order_items)
                    .select('*')
                    .eq('order_id', orderId);

                for (const item of orderItems || []) {
                    let product = null;

                    // Try to find product by ID first, then by name as fallback
                    if (item.product_id) {
                        const { data } = await supabase
                            .from(TABLES.products)
                            .select('*')
                            .eq('id', item.product_id)
                            .single();
                        product = data;
                    } else if (item.product_name) {
                        const { data } = await supabase
                            .from(TABLES.products)
                            .select('*')
                            .eq('name', item.product_name)
                            .eq('pharmacy_id', pharmacyId)
                            .single();
                        product = data;
                    }

                    if (product) {
                        const availableStock = product.stock || 0;

                        if (availableStock === 0) {
                            insufficientStockItems.push(`${product.name} - Out of stock`);
                        } else if (availableStock < item.quantity) {
                            insufficientStockItems.push(`${product.name} - Only ${availableStock} available, ordered ${item.quantity}`);
                        }
                    } else {
                        insufficientStockItems.push(`${item.product_name || item.name} - Product not found`);
                    }
                }

                // If any items have insufficient stock, block the order confirmation
                if (insufficientStockItems.length > 0) {
                    const errorMessage = '‚ùå Cannot confirm order due to insufficient stock:\n\n' +
                        insufficientStockItems.join('\n') +
                        '\n\nPlease restock these items before confirming the order.';
                    alert(errorMessage);
                    console.error('‚ùå Order confirmation blocked due to insufficient stock:', insufficientStockItems);
                    return;
                }

                console.log('‚úÖ All items have sufficient stock, proceeding with confirmation');

                // Deduct stock for each item
                console.log('üì¶ Starting stock deduction for', orderItems.length, 'items');
                for (const item of orderItems) {
                    let product = null;

                    console.log(`üîç Processing item: ${item.product_name} (Qty: ${item.quantity})`);

                    // Try to find product by ID first, then by name as fallback
                    if (item.product_id) {
                        console.log(`üìç Looking for product by ID: ${item.product_id}`);
                        // If product_id is available, use it directly
                        const { data } = await supabase
                            .from(TABLES.products)
                            .select('*')
                            .eq('id', item.product_id)
                            .single();
                        product = data;
                    } else if (item.product_name) {
                        console.log(`üìç Looking for product by name: ${item.product_name}`);
                        // Fallback: find product by name (less reliable but better than nothing)
                        const { data } = await supabase
                            .from(TABLES.products)
                            .select('*')
                            .eq('name', item.product_name)
                            .eq('pharmacy_id', pharmacyId)
                            .single();
                        product = data;
                    }

                    if (product) {
                        console.log(`‚úÖ Found product: ${product.name} (Current stock: ${product.stock})`);
                        console.log(`üîç Product pharmacy_id: ${product.pharmacy_id}`);
                        console.log(`üîç Current pharmacyId: ${pharmacyId}`);
                        console.log(`üîç Do they match? ${product.pharmacy_id === pharmacyId ? 'YES' : 'NO'}`);

                        const newStock = Math.max(0, product.stock - item.quantity); // Prevent negative stock
                        console.log(`üîÑ Updating stock: ${product.stock} ‚Üí ${newStock}`);
                        if (product.stock - item.quantity < 0) {
                            console.warn(`‚ö†Ô∏è Attempted to deduct ${item.quantity} from ${product.stock} stock for ${product.name}, set to 0`);
                        }

                        try {
                            const { error: updateError } = await supabase
                                .from(TABLES.products)
                                .update({ 
                                    stock: newStock, 
                                    updated_at: new Date().toISOString() 
                                })
                                .eq('id', product.id);
                            
                            if (updateError) throw updateError;
                            console.log(`‚úÖ Successfully updated stock for ${product.name}`);
                        } catch (stockError) {
                            console.error(`‚ùå Failed to update stock for ${product.name}:`, stockError);
                            throw stockError; // Re-throw to stop the process
                        }
                    } else {
                        console.warn(`‚ö†Ô∏è Could not find product for item: ${item.product_name} (ID: ${item.product_id || 'N/A'})`);
                        // Continue with other items instead of failing completely
                    }
                }
                console.log('‚úÖ Stock deduction completed');

                // Update order status
                console.log('üìù Updating order status to Confirmed');
                try {
                    const { error: orderError } = await supabase
                        .from(TABLES.orders)
                        .update({
                        stage: 'Confirmed',
                            payment_status: 'Confirmed',
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', orderId);
                    
                    if (orderError) throw orderError;
                    console.log('‚úÖ Order status updated successfully');
                } catch (orderError) {
                    console.error('‚ùå Failed to update order status:', orderError);
                    throw orderError; // Re-throw to stop the process
                }

                // COD payment will be credited when order is marked as delivered
                // (not at confirmation, since customer hasn't paid yet)

                await loadProducts();
                console.log('üéâ Order confirmation completed successfully!');
                showSuccess('Order confirmed and stock deducted successfully!');
                // Orders will be updated automatically via real-time listener
            }
            } catch (error) {
                console.error('‚ùå Error confirming order:', error);
                alert(getProfessionalErrorMessage(error));
            } finally {
                setButtonLoading(confirmButton, false);
            }
        };

        // Function to get the next action text based on current stage
        function getNextActionText(currentStage) {
            const stageActions = {
                'Pending': null, // No next action - use "Confirm & Deduct Stock" button instead
                'Confirmed': 'Mark as Shipped',
                'To Be Received': 'Mark as Delivered',
                'Delivered': null // No next action
            };
            return stageActions[currentStage] || null;
        }

        // Function to get color classes for order stages
        function getStageColor(stage) {
            const stageColors = {
                'Pending': 'text-yellow-600 bg-yellow-50',
                'Confirmed': 'text-blue-600 bg-blue-50',
                'To Be Received': 'text-purple-600 bg-purple-50',
                'Delivered': 'text-green-600 bg-green-50',
                'Declined': 'text-red-600 bg-red-50',
                'Cancelled': 'text-gray-600 bg-gray-50'
            };
            return stageColors[stage] || 'text-gray-600 bg-gray-50';
        }

        window.advanceOrder = async (orderId) => {
            // Find the advance button and set loading state
            const advanceButton = document.querySelector(`button[onclick="advanceOrder('${orderId}')"]`);
            setButtonLoading(advanceButton, true, 'Processing...');

            try {
            const { data: order, error: orderError } = await supabase
                .from(TABLES.orders)
                .select('*')
                .eq('id', orderId)
                .single();

            if (orderError) throw orderError;

            if (order) {
                const stages = ['Pending', 'Confirmed', 'To Be Received', 'Delivered'];
                const currentIndex = stages.indexOf(order.stage);
                const nextStage = stages[Math.min(currentIndex + 1, stages.length - 1)];

                const { error: updateError } = await supabase
                    .from(TABLES.orders)
                    .update({
                    stage: nextStage,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', orderId);
                
                if (updateError) throw updateError;

                console.log('‚úÖ Order status updated successfully');
                
                // Credit COD payment to pharmacy wallet when order is delivered
                if (nextStage === 'Delivered' && (order.cod || order.payment_method === 'COD')) {
                    console.log('üí∞ Order delivered! Crediting COD payment to pharmacy wallet');
                    try {
                        const { data: creditResult, error: creditError } = await supabase
                            .rpc('credit_cod_to_pharmacy', { order_id_param: orderId });
                        
                        if (creditError) {
                            console.error('‚ùå Error crediting wallet:', creditError);
                            showSuccess(`Order delivered (Wallet credit pending - please refresh wallet)`);
                        } else {
                            console.log('‚úÖ Wallet credited:', creditResult);
                            showSuccess(`Order delivered! ‚Ç±${creditResult.amount?.toFixed(2)} credited to your wallet`);
                        }
                    } catch (walletError) {
                        console.error('‚ùå Exception crediting wallet:', walletError);
                        showSuccess(`Order status updated to ${nextStage}`);
                    }
                } else {
                    showSuccess(`Order status updated to ${nextStage}`);
                }
                
                // Reload orders to show updated status
                await loadAllOrders();
                }
            } catch (error) {
                console.error('‚ùå Error advancing order:', error);
                alert(getProfessionalErrorMessage(error));
            } finally {
                setButtonLoading(advanceButton, false);
            }
        };

        // Test function to manually update badges
        window.testBadges = async () => {
            console.log('Testing pharmacy badges...');
            await updateOrderCounts();

            // Force show a badge for testing
            const testBadge = document.querySelector('.pharmacy-order-count-badge');
            if (testBadge) {
                testBadge.textContent = '99';
                testBadge.style.display = 'inline-flex';
                console.log('Forced badge to show with count 99');
            }
        };

        window.viewOrderDetails = async (orderId) => {
            const { data: order, error: orderError } = await supabase
                .from(TABLES.orders)
                .select('*')
                .eq('id', orderId)
                .single();

            if (orderError) {
                console.error('Error fetching order:', orderError);
                return;
            }

            if (order) {
                // Fetch order items separately from Supabase
                const { data: orderItems } = await supabase
                    .from(TABLES.order_items)
                    .select('*')
                    .eq('order_id', orderId);

                // Handle Supabase timestamp objects properly
                const orderDate = safeDateConversion(order.created_at).toLocaleString();

                // Handle customer info structure
                const customerName = order.customer_name || 'Unknown';
                const customerPhone = order.customer_phone || 'Not provided';
                const customerEmail = order.customer_email || 'Not provided';

                const detailsHTML = `
                    <div class="space-y-8">
                        <div class="grid lg:grid-cols-2 gap-8">
                            <!-- Order Information Card -->
                            <div class="bg-gray-50 rounded-xl p-6">
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                    <h4 class="text-xl font-bold text-gray-900">Order Information</h4>
                                </div>
                    <div class="space-y-4">
                                    <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                        <span class="font-medium text-gray-600">Order #</span>
                                        <span class="text-gray-900 font-mono">${orderId.slice(-6)}</span>
                            </div>
                                    <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                        <span class="font-medium text-gray-600">Status</span>
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStageColor(order.stage)}">
                                            ${order.stage}
                                        </span>
                                    </div>
                                    <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                        <span class="font-medium text-gray-600">Date</span>
                                        <span class="text-gray-900">${orderDate}</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2">
                                        <span class="font-medium text-gray-600">Total</span>
                                        <span class="text-gray-900 font-semibold">‚Ç±${order.total.toFixed(2)}</span>
                                    </div>
                            </div>
                        </div>

                            <!-- Customer Information Card -->
                            <div class="bg-gray-50 rounded-xl p-6">
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                        </svg>
                            </div>
                                    <h4 class="text-xl font-bold text-gray-900">Customer Information</h4>
                                </div>
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                        <span class="font-medium text-gray-600">Name</span>
                                        <span class="text-gray-900">${customerName}</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                        <span class="font-medium text-gray-600">Phone</span>
                                        <span class="text-gray-900">${customerPhone}</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2">
                                        <span class="font-medium text-gray-600">Email</span>
                                        <span class="text-gray-900">${customerEmail}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid lg:grid-cols-2 gap-8">
                            <!-- Payment Details Card -->
                            <div class="bg-gray-50 rounded-xl p-6">
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                                        <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                                        </svg>
                                    </div>
                                    <h4 class="text-xl font-bold text-gray-900">Payment Details</h4>
                                </div>
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                        <span class="font-medium text-gray-600">Method</span>
                                        <span class="text-gray-900">${order.payment_method}</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                        <span class="font-medium text-gray-600">Status</span>
                                        <span class="text-gray-900">${order.payment_status}</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2">
                                        <span class="font-medium text-gray-600">COD</span>
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${order.cod ? 'bg-orange-100 text-orange-800' : 'bg-gray-100 text-gray-800'}">
                                            ${order.cod ? 'Yes' : 'No'}
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Order Summary Card -->
                            <div class="bg-gray-50 rounded-xl p-6">
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="w-10 h-10 bg-emerald-100 rounded-full flex items-center justify-center">
                                        <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                        </svg>
                                    </div>
                                    <h4 class="text-xl font-bold text-gray-900">Order Summary</h4>
                                </div>
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                        <span class="font-medium text-gray-600">Items</span>
                                        <span class="text-gray-900 font-semibold">${orderItems?.length || 0}</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                        <span class="font-medium text-gray-600">Total Amount</span>
                                        <span class="text-gray-900 font-semibold">‚Ç±${order.total.toFixed(2)}</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2">
                                        <span class="font-medium text-gray-600">Order Date</span>
                                        <span class="text-gray-900">${orderDate}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Items Ordered Section -->
                        <div class="bg-gray-50 rounded-xl p-6">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center">
                                    <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                    </svg>
                                </div>
                                <h4 class="text-xl font-bold text-gray-900">Items Ordered</h4>
                            </div>
                            <div class="bg-white rounded-lg p-4 space-y-3">
                                ${orderItems?.map(item => `
                                    <div class="flex justify-between items-center py-3 border-b border-gray-200 last:border-0">
                                        <div class="flex-1">
                                            <p class="font-medium text-gray-900">${item.product_name || 'Product'}</p>
                                            <p class="text-sm text-gray-600">‚Ç±${item.price} each</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="font-medium text-gray-900">Qty: ${item.quantity}</p>
                                            <p class="text-sm text-gray-600">‚Ç±${(item.price * item.quantity).toFixed(2)}</p>
                                        </div>
                                    </div>
                                `).join('') || '<p class="text-gray-500 text-center py-4">No items found</p>'}
                            </div>
                        </div>
                        
                        ${order.deliveryAddress ? `
                        <!-- Delivery Address Section -->
                        <div class="bg-gray-50 rounded-xl p-6">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
                                    <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                </div>
                                <h4 class="text-xl font-bold text-gray-900">Delivery Address</h4>
                            </div>
                            <div class="bg-white rounded-lg p-4">
                                <p class="text-gray-900">${order.deliveryAddress}</p>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;

                // Create and show modal
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-hidden">
                        <!-- Header -->
                        <div class="bg-gradient-to-r from-emerald-500 to-blue-600 p-6 text-white">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="text-2xl font-bold">Order Details</h3>
                                        <p class="text-emerald-100">#${orderId.slice(-6)}</p>
                                    </div>
                                </div>
                                <button onclick="this.closest('.fixed').remove()" class="text-white hover:text-emerald-200 transition-colors">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <!-- Content -->
                        <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                            ${detailsHTML}
                        </div>

                        <!-- Footer -->
                        <div class="bg-gray-50 px-6 py-4 flex justify-end">
                            <button onclick="this.closest('.fixed').remove()" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-medium">
                                Close
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
                modal.onclick = (e) => {
                    if (e.target === modal) modal.remove();
                };
            }
        };

        // Global functions for product management
        window.editProduct = async (productId) => {
            const { data: product, error: productError } = await supabase
                .from(TABLES.products)
                .select('*')
                .eq('id', productId)
                .single();

            if (productError) {
                console.error('Error fetching product:', productError);
                return;
            }

            if (product) {
                editingProductId = productId;

                // Convert category_id (UUID) back to category name for the select
                const categoryMap = {
                    'cold-flu': 'a1b2c3d4-e5f6-7890-abcd-ef1234567890',
                    'pain-relief': 'b2c3d4e5-f6g7-8901-bcde-f23456789012',
                    'vitamins': 'c3d4e5f6-g7h8-9012-cdef-345678901234',
                    'skincare': 'd4e5f6g7-h8i9-0123-defg-456789012345',
                    'digestive': 'e5f6g7h8-i9j0-1234-efgh-567890123456',
                    'respiratory': 'f6g7h8i9-j0k1-2345-fghi-678901234567',
                    'diabetes': 'g7h8i9j0-k1l2-3456-ghij-789012345678',
                    'heart': 'h8i9j0k1-l2m3-4567-hijk-890123456789',
                    'mental-health': 'i9j0k1l2-m3n4-5678-ijkl-901234567890',
                    'women-health': 'j0k1l2m3-n4o5-6789-jklm-012345678901',
                    'men-health': 'k1l2m3n4-o5p6-7890-klmn-123456789012',
                    'children': 'l2m3n4o5-p6q7-8901-lmno-234567890123',
                    'elderly': 'm3n4o5p6-q7r8-9012-mnop-345678901234',
                    'first-aid': 'n4o5p6q7-r8s9-0123-nopq-456789012345',
                    'medical-devices': 'o5p6q7r8-s9t0-1234-opqr-567890123456',
                    'other': 'p6q7r8s9-t0u1-2345-pqrs-678901234567'
                };
                
                const categoryName = Object.keys(categoryMap).find(name => categoryMap[name] === product.category_id);

                // Update modal title and button text
                document.getElementById('product-modal-title').textContent = 'Edit Product';
                document.getElementById('save-product-text').textContent = 'Update Product';

                // Populate modal form
                document.querySelector('#product-modal-form input[name="name"]').value = product.name;
                document.querySelector('#product-modal-form input[name="price"]').value = product.price;
                document.querySelector('#product-modal-form input[name="discount"]').value = product.discount || 0;
                document.querySelector('#product-modal-form input[name="stock"]').value = product.stock;
                document.querySelector('#product-modal-form select[name="category"]').value = categoryName || '';
                document.querySelector('#product-modal-form input[name="imageURL"]').value = product.image_url || '';
                document.querySelector('#product-modal-form textarea[name="description"]').value = product.description || '';
                document.querySelector('#product-modal-form input[name="featured"]').checked = product.featured || false;
                document.querySelector('#product-modal-form input[name="prescription"]').checked = product.prescription || false;

                // Show modal
                document.getElementById('product-modal').classList.remove('hidden');
            }
        };

        window.deleteProduct = async (productId) => {
            if (confirm('Are you sure you want to delete this product?')) {
                const { error } = await supabase
                    .from(TABLES.products)
                    .delete()
                    .eq('id', productId);
                
                if (error) {
                    console.error('Error deleting product:', error);
                    showError('Failed to delete product. Please try again.');
                    return;
                }
                
                await loadProducts();
                showSuccess('Product deleted successfully!');
            }
        };

        // Toggle product status (enable/disable)
        window.toggleProductStatus = async (productId, currentStatus) => {
            const newStatus = !currentStatus;
            const action = newStatus ? 'disable' : 'enable';
            
            if (confirm(`Are you sure you want to ${action} this product?`)) {
                try {
                    const { error } = await supabase
                        .from(TABLES.products)
                        .update({ 
                            disabled: newStatus,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', productId);
                    
                    if (error) {
                        console.error('Error updating product status:', error);
                        showError('Failed to update product status. Please try again.');
                        return;
                    }
                    
                    await loadProducts();
                    showSuccess(`Product ${action}d successfully!`);
                } catch (error) {
                    console.error('Error updating product status:', error);
                    showError('Failed to update product status. Please try again.');
                }
            }
        };

        // Cancel edit
        const cancelEditBtn = document.getElementById('cancel-edit');
        if (cancelEditBtn) {
            cancelEditBtn.onclick = () => {
            editingProductId = null;
            document.getElementById('product-form').reset();
                const submitText = document.getElementById('submit-text');
                if (submitText) {
                    submitText.textContent = 'Add Product';
                }
                cancelEditBtn.classList.add('hidden');
            };
        }

        // Modal functionality

        // Open modal for adding product
        document.getElementById('open-product-modal').addEventListener('click', () => {
            editingProductId = null;
            document.getElementById('product-modal-title').textContent = 'Add Product';
            document.getElementById('save-product-text').textContent = 'Add Product';
            document.getElementById('product-modal-form').reset();
            document.getElementById('product-modal').classList.remove('hidden');
        });

        // Close modal
        document.getElementById('close-product-modal').addEventListener('click', closeProductModal);
        document.getElementById('cancel-product-modal').addEventListener('click', closeProductModal);

        function closeProductModal() {
            document.getElementById('product-modal').classList.add('hidden');
            editingProductId = null;
        }

        // Save product (modal form)
        document.getElementById('save-product-modal').addEventListener('click', async () => {
            const form = document.getElementById('product-modal-form');
            const data = Object.fromEntries(new FormData(form).entries());
            const saveBtn = document.getElementById('save-product-modal');
            
            // Set loading state
            const isEditing = editingProductId !== null;
            setButtonLoading(saveBtn, true, isEditing ? 'Updating...' : 'Adding...');

            // Convert category name to UUID
            const categoryMap = {
                'cold-flu': 'a1b2c3d4-e5f6-7890-abcd-ef1234567890',
                'pain-relief': 'b2c3d4e5-f6g7-8901-bcde-f23456789012',
                'vitamins': 'c3d4e5f6-g7h8-9012-cdef-345678901234',
                'skincare': 'd4e5f6g7-h8i9-0123-defg-456789012345',
                'digestive': 'e5f6g7h8-i9j0-1234-efgh-567890123456',
                'respiratory': 'f6g7h8i9-j0k1-2345-fghi-678901234567',
                'diabetes': 'g7h8i9j0-k1l2-3456-ghij-789012345678',
                'heart': 'h8i9j0k1-l2m3-4567-hijk-890123456789',
                'mental-health': 'i9j0k1l2-m3n4-5678-ijkl-901234567890',
                'women-health': 'j0k1l2m3-n4o5-6789-jklm-012345678901',
                'men-health': 'k1l2m3n4-o5p6-7890-klmn-123456789012',
                'children': 'l2m3n4o5-p6q7-8901-lmno-234567890123',
                'elderly': 'm3n4o5p6-q7r8-9012-mnop-345678901234',
                'first-aid': 'n4o5p6q7-r8s9-0123-nopq-456789012345',
                'medical-devices': 'o5p6q7r8-s9t0-1234-opqr-567890123456',
                'other': 'p6q7r8s9-t0u1-2345-pqrs-678901234567'
            };
            
            // Validate required fields
            if (!data.category || !categoryMap[data.category]) {
                showError('Please select a valid category');
                setButtonLoading(saveBtn, false);
                return;
            }

            const productData = {
                name: data.name,
                price: Number(data.price || 0),
                discount: Number(data.discount || 0),
                stock: Number(data.stock || 0),
                category_id: categoryMap[data.category],
                image_url: data.imageURL || 'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?q=80&w=800&auto=format&fit=crop',
                description: data.description || '',
                featured: Boolean(data.featured),
                prescription: Boolean(data.prescription),
                pharmacy_id: pharmacyId,
                disabled: false,
                updated_at: new Date().toISOString()
            };

            try {
                if (editingProductId) {
                    const { error } = await supabase
                        .from(TABLES.products)
                        .update(productData)
                        .eq('id', editingProductId);
                    
                    if (error) throw error;
                    showSuccess('Product updated successfully!');
                } else {
                    productData.created_at = new Date().toISOString();
                    const { error } = await supabase
                        .from(TABLES.products)
                        .insert(productData);
                    
                    if (error) throw error;
                    showSuccess('Product added successfully!');
                }

                // Close modal and reload products
                closeProductModal();
                await loadProducts();
                
            } catch (error) {
                console.error('‚ùå Error saving product:', error);
                showError(getProfessionalErrorMessage(error));
            } finally {
                setButtonLoading(saveBtn, false);
            }
        });

        // Order status tab event listeners
        document.getElementById('order-status-tabs').addEventListener('click', async (e) => {
            const tab = e.target.closest('.pharmacy-tab-button');
            if (tab) {
                const status = tab.id.replace('tab-', '');
                await loadOrders(status);
            }
        });

        document.getElementById('logout').addEventListener('click', logout);

        // Wallet functionality
        async function loadWalletData() {
            if (!pharmacyId) return;

            try {
                const { data: pharmacy, error: pharmacyError } = await supabase
                    .from(TABLES.pharmacies)
                    .select('*')
                    .eq('id', pharmacyId)
                    .single();

                if (pharmacyError) {
                    console.error('Error fetching pharmacy data:', pharmacyError);
                    return;
                }

                if (pharmacy) {
                    const walletBalance = pharmacy.wallet_balance || 0;
                    const pendingBalance = pharmacy.pending_balance || 0;

                    document.getElementById('wallet-balance').textContent = formatCurrency(walletBalance);
                    document.getElementById('pending-balance').textContent = formatCurrency(pendingBalance);
                }

                // Load recent transactions
                await loadTransactions();
            } catch (error) {
                console.error('Error loading wallet data:', error);
            }
        }

        // Payment method selection handler
        function setupPaymentMethodHandlers() {
            const paymentMethods = document.querySelectorAll('input[name="payment-method"]');
            const digitalWalletDetails = document.getElementById('digital-wallet-details');
            const bankDetails = document.getElementById('bank-details');

            paymentMethods.forEach(method => {
                method.addEventListener('change', function() {
                    // Hide all detail sections
                    digitalWalletDetails.classList.add('hidden');
                    bankDetails.classList.add('hidden');

                    // Show relevant section based on selection
                    if (this.value === 'gcash' || this.value === 'maya') {
                        digitalWalletDetails.classList.remove('hidden');
                    } else if (this.value === 'bank') {
                        bankDetails.classList.remove('hidden');
                    }
                });
            });
        }

        async function loadTransactions() {
            if (!pharmacyId) return;

            const transactionsList = document.getElementById('transactions-list');

            try {
                const { data: transactions, error } = await supabase
                    .from('transactions')
                    .select('*')
                    .eq('pharmacy_id', pharmacyId)
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (error) {
                    console.warn('Transactions table not available:', error);
                    transactionsList.innerHTML = '<p class="text-gray-500 text-center py-4">Transaction history not available</p>';
                    return;
                }

                if (!transactions || transactions.length === 0) {
                    transactionsList.innerHTML = '<p class="text-gray-500 text-center py-4">No transactions yet</p>';
                    return;
                }

                transactionsList.innerHTML = transactions.map(transaction => {
                    const isPayment = transaction.type === 'cod_payment_credit' || transaction.type === 'card_payment_credit';
                    const isWithdrawal = transaction.type === 'withdrawal_request';
                    const isRejected = transaction.status === 'rejected';
                    const isRefund = transaction.type === 'refund' || isRejected; // Rejected withdrawals are refunds
                    
                    let typeText = 'Transaction';
                    if (isPayment) typeText = 'Payment Received';
                    else if (isWithdrawal) typeText = 'Withdrawal Request';
                    else if (isRejected) typeText = 'Refund (Withdrawal Rejected)';
                    else if (transaction.type === 'withdrawal_approved') typeText = 'Withdrawal Approved';
                    else if (transaction.type === 'refund') typeText = 'Refund';
                    
                    // Determine if this is a credit (positive) or debit (negative) transaction
                    const isCredit = isPayment || isRefund;
                    
                    return `
                        <div class="flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50 transition-colors cursor-pointer" onclick="viewTransactionDetails('${transaction.id}')">
                            <div class="flex-1">
                                <p class="font-medium text-gray-900">${typeText}</p>
                                <p class="text-sm text-gray-600">${safeDateConversion(transaction.created_at).toLocaleDateString()}</p>
                                ${transaction.description ? `<p class="text-xs text-gray-500">${transaction.description}</p>` : ''}
                        </div>
                            <div class="text-right flex items-center gap-3">
                                <div>
                                    <p class="font-medium ${isCredit ? 'text-emerald-600' : 'text-blue-600'}">
                                        ${isCredit ? '+' : '-'}‚Ç±${transaction.amount.toFixed(2)}
                                    </p>
                                    <p class="text-xs text-gray-500 capitalize">${transaction.status}</p>
                                    ${transaction.payment_method ? `<p class="text-xs text-gray-400">${transaction.payment_method}</p>` : ''}
                        </div>
                                <div class="flex items-center justify-center w-8 h-8 bg-blue-100 rounded-full">
                                    <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                    </svg>
                    </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading transactions:', error);
            }
        }

        async function requestWithdrawal() {
            const amount = parseFloat(document.getElementById('withdrawal-amount').value);
            const selectedPaymentMethod = document.querySelector('input[name="payment-method"]:checked');

            if (!amount || amount < 100) {
                alert('Please enter a valid amount (minimum ‚Ç±100)');
                return;
            }

            if (!selectedPaymentMethod) {
                alert('Please select a payment method');
                return;
            }

            let accountDetails = {};
            const paymentMethod = selectedPaymentMethod.value;
            
            // Map form values to database values
            let dbPaymentMethod = paymentMethod;
            if (paymentMethod === 'gcash') dbPaymentMethod = 'gcash';
            else if (paymentMethod === 'maya') dbPaymentMethod = 'paymaya';
            else if (paymentMethod === 'bank') dbPaymentMethod = 'bank_transfer'; // Map bank to bank_transfer for database

            if (paymentMethod === 'gcash' || paymentMethod === 'maya') {
                const mobileNumber = document.getElementById('mobile-number').value.trim();
                const accountName = document.getElementById('account-name').value.trim();

                if (!mobileNumber || !accountName) {
                    alert('Please enter mobile number and account name for digital wallet');
                    return;
                }

                accountDetails = {
                    mobileNumber: mobileNumber,
                    accountName: accountName
                };
            } else if (paymentMethod === 'bank') {
                const bankName = document.getElementById('bank-name').value.trim();
                const accountNumber = document.getElementById('account-number').value.trim();
                const bankAccountName = document.getElementById('bank-account-name').value.trim();

                if (!bankName || !accountNumber || !bankAccountName) {
                    alert('Please enter all bank account details');
                    return;
                }

                accountDetails = {
                    bankName: bankName,
                    accountNumber: accountNumber,
                    accountName: bankAccountName
                };
            }

            // Set loading state
            const withdrawalBtn = document.getElementById('request-withdrawal');
            setButtonLoading(withdrawalBtn, true, 'Submitting...');

            try {
                console.log('=== WITHDRAWAL REQUEST DEBUG ===');
                console.log('Pharmacy ID:', pharmacyId);
                const { data: { user: currentUser } } = await supabase.auth.getUser();
                console.log('User UID:', currentUser?.id);
                console.log('Amount:', amount);
                console.log('Payment Method:', paymentMethod);
                console.log('Account Details:', accountDetails);

                // Check if pharmacy has sufficient balance
                const { data: pharmacy, error: pharmacyError } = await supabase
                    .from(TABLES.pharmacies)
                    .select('*')
                    .eq('id', pharmacyId)
                    .single();

                if (pharmacyError || !pharmacy) {
                    alert('Pharmacy not found');
                    return;
                }

                const currentBalance = pharmacy.wallet_balance || 0;
                if (amount > currentBalance) {
                    alert('Insufficient balance');
                    return;
                }

                console.log('Creating withdrawal request...');
                // Create withdrawal request
                const withdrawalData = {
                    pharmacy_id: pharmacyId,
                    amount: amount,
                    payment_method: dbPaymentMethod,
                    account_details: accountDetails,
                    status: 'pending',
                    requested_at: new Date().toISOString()
                };
                console.log('Withdrawal data:', withdrawalData);

                // Try to create withdrawal request (if table exists)
                try {
                    const { error: withdrawalError } = await supabase
                        .from(TABLES.withdrawal_requests)
                        .insert(withdrawalData);
                    
                    if (withdrawalError) {
                        console.warn('Could not create withdrawal request:', withdrawalError);
                    } else {
                console.log('Withdrawal request created successfully');
                    }
                } catch (withdrawalError) {
                    console.warn('Withdrawal requests table not available:', withdrawalError);
                }

                console.log('Updating pharmacy balance...');
                // Update pharmacy balance
                const { error: updateError } = await supabase
                    .from(TABLES.pharmacies)
                    .update({
                        wallet_balance: currentBalance - amount,
                        pending_balance: (pharmacy.pending_balance || 0) + amount,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', pharmacyId);
                
                if (updateError) throw updateError;
                console.log('Pharmacy balance updated successfully');

                // Record withdrawal transaction
                try {
                    const transactionData = {
                        pharmacy_id: pharmacyId,
                        type: 'withdrawal_request',
                        amount: amount,
                        description: `Withdrawal request via ${paymentMethod.toUpperCase()}`,
                        payment_method: dbPaymentMethod,
                        status: 'pending',
                        created_at: new Date().toISOString()
                    };

                    const { error: transactionError } = await supabase
                        .from(TABLES.transactions)
                        .insert(transactionData);

                    if (transactionError) {
                        console.warn('Could not record withdrawal transaction:', transactionError);
                    } else {
                        console.log('Withdrawal transaction recorded successfully');
                    }
                } catch (transactionError) {
                    console.warn('Transaction recording not available:', transactionError);
                }

                showSuccess('Withdrawal request submitted successfully');

                // Reload wallet data and transactions
                await loadWalletData();

                // Clear form
                document.getElementById('withdrawal-amount').value = '';
                
                // Clear payment method selection
                document.querySelectorAll('input[name="payment-method"]').forEach(radio => {
                    radio.checked = false;
                });
                
                // Hide all detail sections
                document.getElementById('digital-wallet-details').classList.add('hidden');
                document.getElementById('bank-details').classList.add('hidden');
                
                // Clear all input fields
                document.getElementById('mobile-number').value = '';
                document.getElementById('account-name').value = '';
                document.getElementById('bank-name').value = '';
                document.getElementById('account-number').value = '';
                document.getElementById('bank-account-name').value = '';

                // Reload wallet data
                await loadWalletData();
            } catch (error) {
                console.error('Error requesting withdrawal:', error);
                alert(getProfessionalErrorMessage(error));
            } finally {
                setButtonLoading(withdrawalBtn, false);
            }
        }

        // Credit COD payment to pharmacy wallet
        async function creditCODToPharmacyWallet(order) {
            try {
                console.log('üí∞ Starting COD wallet credit for order:', order.id);
                console.log('üí∞ Current pharmacyId:', pharmacyId);
                
                // Get order items from Supabase
                const { data: orderItems, error: orderItemsError } = await supabase
                    .from(TABLES.order_items)
                    .select('*')
                    .eq('order_id', order.id);

                if (orderItemsError) {
                    console.error('‚ùå Error fetching order items:', orderItemsError);
                    throw orderItemsError;
                }

                console.log('üí∞ Order items found:', orderItems?.length || 0);

                // Calculate total amount for this pharmacy's items
                let totalAmount = 0;
                const pharmacyItems = [];

                for (const item of orderItems || []) {
                    const productId = item.product_id;
                    if (!productId) {
                        console.log('‚ö†Ô∏è Order item missing product_id:', item);
                        continue;
                    }

                    const { data: product, error: productError } = await supabase
                        .from(TABLES.products)
                        .select('*')
                        .eq('id', productId)
                        .single();

                    if (productError) {
                        console.error('‚ùå Error fetching product:', productError);
                        continue;
                    }

                    if (!product) {
                        console.log('‚ö†Ô∏è Product not found for ID:', productId);
                        continue;
                    }

                    console.log('üîç Product pharmacy_id:', product.pharmacy_id, 'Current pharmacyId:', pharmacyId);

                    if (product.pharmacy_id === pharmacyId) {
                        pharmacyItems.push(item);
                        const itemTotal = parseFloat(item.price) * item.quantity;
                        totalAmount += itemTotal;
                        console.log('‚úÖ Added item to pharmacy total:', item.product_name, '‚Ç±' + itemTotal);
                    } else {
                        console.log('‚ùå Item not owned by this pharmacy:', item.product_name);
                    }
                }

                console.log('üí∞ Total amount for pharmacy:', totalAmount);
                console.log('üí∞ Pharmacy items count:', pharmacyItems.length);

                if (totalAmount === 0) {
                    console.log('‚ö†Ô∏è No items found for this pharmacy in the order');
                    return;
                }

                // Calculate commission (5% platform fee)
                const commission = totalAmount * 0.05;
                const pharmacyAmount = totalAmount - commission;

                // Update pharmacy wallet
                console.log('üí∞ Fetching pharmacy record...');
                const { data: pharmacy, error: pharmacyError } = await supabase
                    .from(TABLES.pharmacies)
                    .select('*')
                    .eq('id', pharmacyId)
                    .single();

                if (pharmacyError) {
                    console.error('‚ùå Error fetching pharmacy record:', pharmacyError);
                    throw pharmacyError;
                }

                if (!pharmacy) {
                    console.error('‚ùå Pharmacy record not found for ID:', pharmacyId);
                    throw new Error('Pharmacy record not found');
                }

                const currentBalance = pharmacy.wallet_balance || 0;
                const currentPending = pharmacy.pending_balance || 0;

                console.log('üí∞ Current wallet balance:', currentBalance);
                console.log('üí∞ Amount to credit:', pharmacyAmount);
                console.log('üí∞ New balance will be:', currentBalance + pharmacyAmount);

                    // For COD payments: Add to Available balance (pharmacy confirmed the payment)
                const { error: updateError } = await supabase
                    .from(TABLES.pharmacies)
                    .update({
                        wallet_balance: currentBalance + pharmacyAmount,
                        pending_balance: currentPending, // Don't add to pending for COD
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', pharmacyId);

                if (updateError) {
                    console.error('‚ùå Error updating pharmacy wallet:', updateError);
                    throw updateError;
                }

                console.log(`‚úÖ Successfully credited ‚Ç±${pharmacyAmount.toFixed(2)} to pharmacy wallet (Commission: ‚Ç±${commission.toFixed(2)})`);

                // Record transaction (if transactions table exists)
                console.log('üí∞ Recording transaction...');
                try {
                    const { error: transactionError } = await supabase
                        .from('transactions')
                        .insert({
                            order_id: order.id || 'unknown',
                            pharmacy_id: pharmacyId,
                    amount: pharmacyAmount,
                    commission: commission,
                    type: 'cod_payment_credit',
                    status: 'completed',
                            created_at: new Date().toISOString()
                        });
                    
                    if (transactionError) {
                        console.warn('‚ö†Ô∏è Could not record transaction:', transactionError);
                    } else {
                        console.log('‚úÖ Transaction recorded successfully');
                    }
                } catch (transactionError) {
                    console.warn('‚ö†Ô∏è Transaction recording not available:', transactionError);
                }

            } catch (error) {
                console.error('Error crediting COD payment:', error);
                throw error;
            }
        }

        // Wallet event listeners
        document.getElementById('request-withdrawal').addEventListener('click', requestWithdrawal);

        // View transaction details function
        window.viewTransactionDetails = async function(transactionId) {
            try {
                // Fetch transaction details
                const { data: transaction, error } = await supabase
                    .from('transactions')
                    .select('*')
                    .eq('id', transactionId)
                    .single();

                if (error) {
                    console.error('Error fetching transaction details:', error);
                    showError('Failed to load transaction details');
                    return;
                }

                if (!transaction) {
                    showError('Transaction not found');
                    return;
                }

                // Fetch order details if available
                let orderDetails = null;
                if (transaction.order_id) {
                    const { data: order, error: orderError } = await supabase
                        .from(TABLES.orders)
                        .select('*')
                        .eq('id', transaction.order_id)
                        .single();
                    
                    if (!orderError && order) {
                        orderDetails = order;
                    }
                }

                // Determine transaction type details
                const isPayment = transaction.type === 'cod_payment_credit' || transaction.type === 'card_payment_credit';
                const isWithdrawal = transaction.type === 'withdrawal_request';
                const isRejected = transaction.status === 'rejected';
                
                let typeText = 'Transaction';
                let typeColor = 'blue';
                let typeIcon = `
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                `;
                
                if (isPayment) {
                    typeText = 'Payment Received';
                    typeColor = 'emerald';
                    typeIcon = `
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    `;
                } else if (isWithdrawal) {
                    if (isRejected) {
                        typeText = 'Refund (Withdrawal Rejected)';
                        typeColor = 'emerald';
                        typeIcon = `
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        `;
                    } else if (transaction.status === 'completed') {
                        typeText = 'Withdrawal Approved';
                        typeColor = 'green';
                        typeIcon = `
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                        `;
                    } else {
                        typeText = 'Withdrawal Request';
                        typeColor = 'blue';
                        typeIcon = `
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                        `;
                    }
                } else if (transaction.type === 'refund') {
                    typeText = 'Refund';
                    typeColor = 'orange';
                    typeIcon = `
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                    `;
                }

                // Calculate totals
                const totalAmount = parseFloat(transaction.amount) + parseFloat(transaction.commission || 0);
                const commission = parseFloat(transaction.commission || 0);
                const netAmount = parseFloat(transaction.amount);

                // Create detailed modal
                const modal = `
                    <div id="transaction-details-modal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                        <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[95vh] overflow-hidden transform transition-all">
                            <!-- Header -->
                            <div class="relative bg-gradient-to-br from-${typeColor}-500 via-${typeColor}-600 to-blue-700 p-8 text-white overflow-hidden">
                                <!-- Background Pattern -->
                                <div class="absolute inset-0 opacity-10">
                                    <div class="absolute top-0 right-0 w-32 h-32 bg-white rounded-full -translate-y-16 translate-x-16"></div>
                                    <div class="absolute bottom-0 left-0 w-24 h-24 bg-white rounded-full translate-y-12 -translate-x-12"></div>
                                </div>
                                
                                <div class="relative flex items-center justify-between">
                                    <div class="flex items-center gap-6">
                                        <div class="w-16 h-16 bg-white bg-opacity-20 backdrop-blur-sm rounded-2xl flex items-center justify-center text-3xl shadow-lg border border-white border-opacity-30">
                                            ${typeIcon}
                                        </div>
                                        <div>
                                            <h3 class="text-2xl font-bold mb-1">Transaction Details</h3>
                                            <p class="text-${typeColor}-100 text-lg">${typeText}</p>
                                            <div class="flex items-center gap-2 mt-2">
                                                <div class="w-2 h-2 bg-white rounded-full opacity-80"></div>
                                                <span class="text-sm text-white opacity-90">Transaction #${transaction.id.slice(-8)}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <button onclick="closeTransactionModal()" class="w-10 h-10 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-xl flex items-center justify-center transition-all duration-200 backdrop-blur-sm border border-white border-opacity-30">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>

                            <!-- Content -->
                            <div class="p-8 overflow-y-auto max-h-[calc(95vh-200px)]">
                                <!-- Transaction Summary -->
                                <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-2xl p-6 mb-8 border border-gray-200">
                                    <div class="flex items-center gap-3 mb-6">
                                        <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center">
                                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                            </svg>
                                        </div>
                                        <h4 class="text-xl font-bold text-gray-900">Transaction Summary</h4>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div class="space-y-4">
                                            <div class="bg-white rounded-xl p-4 border border-gray-200">
                                                <p class="text-sm font-medium text-gray-500 mb-2">Transaction ID</p>
                                                <p class="font-mono text-sm text-gray-900 break-all">${transaction.id}</p>
                                            </div>
                                            <div class="bg-white rounded-xl p-4 border border-gray-200">
                                                <p class="text-sm font-medium text-gray-500 mb-2">Date & Time</p>
                                                <p class="text-gray-900 font-medium">${safeDateConversion(transaction.created_at).toLocaleString()}</p>
                                            </div>
                                        </div>
                                        <div class="space-y-4">
                                            <div class="bg-white rounded-xl p-4 border border-gray-200">
                                                <p class="text-sm font-medium text-gray-500 mb-2">Status</p>
                                                <span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium ${
                                                    transaction.status === 'completed' ? 'bg-green-100 text-green-800 border border-green-200' :
                                                    transaction.status === 'pending' ? 'bg-yellow-100 text-yellow-800 border border-yellow-200' :
                                                    transaction.status === 'failed' ? 'bg-red-100 text-red-800 border border-red-200' :
                                                    'bg-gray-100 text-gray-800 border border-gray-200'
                                                }">
                                                    ${transaction.status.charAt(0).toUpperCase() + transaction.status.slice(1)}
                                                </span>
                                            </div>
                                            <div class="bg-white rounded-xl p-4 border border-gray-200">
                                                <p class="text-sm font-medium text-gray-500 mb-2">Payment Method</p>
                                                <p class="text-gray-900 font-medium">${getPaymentMethodDisplay(transaction.payment_method) || 'Not specified'}</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    ${transaction.description ? `
                                        <div class="mt-6 bg-white rounded-xl p-4 border border-gray-200">
                                            <p class="text-sm font-medium text-gray-500 mb-2">Description</p>
                                            <p class="text-gray-900">${transaction.description}</p>
                                        </div>
                                    ` : ''}
                                </div>

                                <!-- Financial Breakdown -->
                                <div class="bg-white border-2 border-gray-200 rounded-2xl p-6 mb-8 shadow-sm">
                                    <div class="flex items-center gap-3 mb-6">
                                        <div class="w-10 h-10 bg-emerald-100 rounded-xl flex items-center justify-center">
                                            <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                            </svg>
                                        </div>
                                        <h4 class="text-xl font-bold text-gray-900">Financial Breakdown</h4>
                                    </div>
                                    
                                    <div class="space-y-4">
                                        ${isPayment ? `
                                            <div class="flex justify-between items-center py-4 px-4 bg-gray-50 rounded-xl border border-gray-200">
                                                <span class="text-gray-700 font-medium">Gross Amount</span>
                                                <span class="font-bold text-xl text-gray-900">‚Ç±${totalAmount.toFixed(2)}</span>
                                            </div>
                                            <div class="flex justify-between items-center py-4 px-4 bg-red-50 rounded-xl border border-red-200">
                                                <span class="text-gray-700 font-medium">Platform Commission (5%)</span>
                                                <span class="font-bold text-xl text-red-600">-‚Ç±${commission.toFixed(2)}</span>
                                            </div>
                                            <div class="flex justify-between items-center py-6 px-6 bg-gradient-to-r from-${typeColor}-50 to-${typeColor}-100 rounded-xl border-2 border-${typeColor}-200">
                                                <span class="font-bold text-lg text-gray-900">Net Amount Received</span>
                                                <span class="font-bold text-3xl text-${typeColor}-600">‚Ç±${netAmount.toFixed(2)}</span>
                                            </div>
                                        ` : `
                                            <div class="flex justify-between items-center py-6 px-6 bg-gradient-to-r from-${typeColor}-50 to-${typeColor}-100 rounded-xl border-2 border-${typeColor}-200">
                                                <span class="font-bold text-lg text-gray-900">Amount</span>
                                                <span class="font-bold text-3xl text-${typeColor}-600">‚Ç±${netAmount.toFixed(2)}</span>
                                            </div>
                                        `}
                                    </div>
                                </div>

                                ${orderDetails ? `
                                    <!-- Order Information -->
                                    <div class="bg-white border-2 border-gray-200 rounded-2xl p-6 mb-8 shadow-sm">
                                        <div class="flex items-center gap-3 mb-6">
                                            <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center">
                                                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                                                </svg>
                                            </div>
                                            <h4 class="text-xl font-bold text-gray-900">Related Order</h4>
                                        </div>
                                        
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div class="space-y-4">
                                                <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                                                    <p class="text-sm font-medium text-gray-500 mb-2">Order ID</p>
                                                    <p class="font-mono text-lg font-bold text-gray-900">#${orderDetails.id.slice(-8)}</p>
                                                </div>
                                                <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                                                    <p class="text-sm font-medium text-gray-500 mb-2">Customer</p>
                                                    <p class="text-gray-900 font-medium">${orderDetails.customer_name || 'Unknown'}</p>
                                                </div>
                                            </div>
                                            <div class="space-y-4">
                                                <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                                                    <p class="text-sm font-medium text-gray-500 mb-2">Order Total</p>
                                                    <p class="text-2xl font-bold text-gray-900">‚Ç±${parseFloat(orderDetails.total || 0).toFixed(2)}</p>
                                                </div>
                                                <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                                                    <p class="text-sm font-medium text-gray-500 mb-2">Order Status</p>
                                                    <span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium ${
                                                        orderDetails.stage === 'Delivered' ? 'bg-green-100 text-green-800 border border-green-200' :
                                                        orderDetails.stage === 'Confirmed' ? 'bg-blue-100 text-blue-800 border border-blue-200' :
                                                        orderDetails.stage === 'Pending' ? 'bg-yellow-100 text-yellow-800 border border-yellow-200' :
                                                        'bg-gray-100 text-gray-800 border border-gray-200'
                                                    }">
                                                        ${orderDetails.stage || 'Unknown'}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        ${orderDetails.delivery_address ? `
                                            <div class="mt-6 bg-gray-50 rounded-xl p-4 border border-gray-200">
                                                <p class="text-sm font-medium text-gray-500 mb-2">Delivery Address</p>
                                                <p class="text-gray-900">${orderDetails.delivery_address}</p>
                                            </div>
                                        ` : ''}
                                    </div>
                                ` : ''}

                                ${transaction.account_details ? `
                                    <!-- Account Details (for withdrawals) -->
                                    <div class="bg-white border-2 border-gray-200 rounded-2xl p-6 shadow-sm">
                                        <div class="flex items-center gap-3 mb-6">
                                            <div class="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center">
                                                <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                                                </svg>
                                            </div>
                                            <h4 class="text-xl font-bold text-gray-900">Account Details</h4>
                                        </div>
                                        
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            ${Object.entries(transaction.account_details).map(([key, value]) => `
                                                <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                                                    <p class="text-sm font-medium text-gray-500 mb-2 capitalize">${key.replace(/_/g, ' ')}</p>
                                                    <p class="text-gray-900 font-medium">${value}</p>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>

                            <!-- Footer -->
                            <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-8 py-6 flex justify-end rounded-b-2xl border-t border-gray-200">
                                <button onclick="closeTransactionModal()" class="px-8 py-3 bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white rounded-xl font-semibold transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                // Insert modal into DOM
                document.body.insertAdjacentHTML('beforeend', modal);

            } catch (error) {
                console.error('Error showing transaction details:', error);
                showError('Failed to load transaction details');
            }
        };

        // Close transaction modal function
        window.closeTransactionModal = function() {
            const modal = document.getElementById('transaction-details-modal');
            if (modal) {
                modal.remove();
            }
        };

        // Function to check if user account is disabled
        async function checkAccountStatus(user) {
            if (!user) return false;
            
            try {
                const { data: userDoc, error } = await supabase
                    .from(TABLES.users)
                    .select('*')
                    .eq('uid', user.id)
                    .single();
                
                if (userDoc && userDoc.disabled === true) {
                    console.log('üö´ Account is disabled, clearing all auth data and redirecting');
                    
                    // Clear all authentication data
                    await supabase.auth.signOut();
                    localStorage.clear();
                    sessionStorage.clear();
                    
                    // Clear any cached data
                    try {
                        const { clearImageCache } = await import('../js/imageCache.js');
                        clearImageCache();
                    } catch (error) {
                        console.warn('Could not clear image cache:', error);
                    }
                    
                    console.log('‚úÖ All auth data cleared, redirecting to disabled page');
                    window.location.href = '../disabled/';
                    return true; // Account is disabled
                }
            } catch (error) {
                console.error('‚ùå Error checking account status:', error);
            }
            return false; // Account is not disabled
        }

        // Flag to prevent duplicate execution
        let authHandlerExecuted = false;

        onAuthStateChanged(async (user) => {
            if (!user) { 
                showLoadingModal('Please log in to access pharmacy panel');
                setTimeout(() => {
                    window.location.href = '../login/';
                }, 1500);
                return; 
            }

            // Prevent duplicate execution
            if (authHandlerExecuted) {
                console.log('üîÑ Auth state changed but handler already executed, skipping...');
                return;
            }
            
            authHandlerExecuted = true;
            console.log('üîê First auth state change, executing handler...');
            
            // Check if account is disabled
            const isDisabled = await checkAccountStatus(user);
            if (isDisabled) {
                return; // Will redirect to disabled page
            }
            
            // Small delay to ensure localStorage is properly set
            await new Promise(resolve => setTimeout(resolve, 100));
            await ensurePharmacy(user);
            
            // Get the pharmacy record by ID (pharmacyId is now the pharmacy table ID)
            const { data: pharmDoc, error } = await supabase
                .from(TABLES.pharmacies)
                .select('*')
                .eq('id', pharmacyId) // Use the pharmacy table ID
                .single();
            
            console.log('üîç Pharmacy check - Error:', error);
            console.log('üîç Pharmacy check - pharmDoc:', pharmDoc);
            console.log('üîç Pharmacy check - pharmDoc.disabled:', pharmDoc?.disabled);
            
            if (error) {
                console.error('‚ùå Error fetching pharmacy record:', error);
                // Don't redirect on error, just show warning
                const banner = document.createElement('div');
                banner.className = 'mb-4 rounded-xl border bg-red-50 text-red-800 p-3';
                banner.textContent = 'Error loading pharmacy data. Please contact support.';
                document.querySelector('main').prepend(banner);
                return;
            }
            
            if (!pharmDoc) {
                console.log('‚ö†Ô∏è No pharmacy record found for user');
                // Don't redirect, show message about creating pharmacy record
                const banner = document.createElement('div');
                banner.className = 'mb-4 rounded-xl border bg-yellow-50 text-yellow-800 p-3';
                banner.textContent = 'No pharmacy record found. Please contact support to set up your pharmacy account.';
                document.querySelector('main').prepend(banner);
                return;
            }
            
            if (pharmDoc.disabled) {
                console.log('‚ùå Pharmacy is disabled, redirecting to disabled page');
                // Clear auth data before redirecting
                await supabase.auth.signOut();
                localStorage.clear();
                sessionStorage.clear();
                window.location.href = '../disabled/';
                return;
            }
            if (!pharmDoc.approved) {
                const banner = document.createElement('div');
                banner.className = 'mb-4 rounded-xl border bg-yellow-50 text-yellow-800 p-3';
                banner.textContent = 'Your pharmacy is pending approval. Please contact support.';
                document.querySelector('main').prepend(banner);
                document.querySelectorAll('#product-form input, #product-form button, #orders-list button').forEach(el => el.disabled = true);
                return;
            }
            await loadProducts();
            await loadAllOrders();
            // Ensure pending tab is active by default
            loadOrders('pending');
        });

        // Bulk operations functionality
        // Search and filter variables
        let allProducts = [];
        let filteredProducts = [];
        let currentProductSearch = '';
        let currentCategoryFilter = 'all';
        let currentStatusFilter = 'all';
        let searchTimeout = null;

        function setupProductSearchAndFilter() {
            console.log('üîß Setting up search and filter functionality...');
            
            const searchInput = document.getElementById('product-search-input');
            const categoryFilter = document.getElementById('category-filter');
            const statusFilter = document.getElementById('status-filter');
            const clearFilters = document.getElementById('clear-product-filters');
            
            console.log('üîß Search elements found:', {
                searchInput: !!searchInput,
                categoryFilter: !!categoryFilter,
                statusFilter: !!statusFilter,
                clearFilters: !!clearFilters
            });
            
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    console.log('üîç Search input changed:', e.target.value);
                    currentProductSearch = e.target.value;
                    
                    // Clear existing timeout
                    if (searchTimeout) {
                        clearTimeout(searchTimeout);
                    }
                    
                    // Set new timeout for debounced search
                    searchTimeout = setTimeout(() => {
                        filterProducts();
                    }, 300); // 300ms delay
                });
            }
            
            if (categoryFilter) {
                categoryFilter.addEventListener('change', (e) => {
                    console.log('üè∑Ô∏è Category filter changed:', e.target.value);
                    currentCategoryFilter = e.target.value;
                    filterProducts();
                });
            }
            
            if (statusFilter) {
                statusFilter.addEventListener('change', (e) => {
                    console.log('üìä Status filter changed:', e.target.value);
                    currentStatusFilter = e.target.value;
                    filterProducts();
                });
            }
            
            if (clearFilters) {
                clearFilters.addEventListener('click', () => {
                    console.log('üóëÔ∏è Clearing all filters...');
                    currentProductSearch = '';
                    currentCategoryFilter = 'all';
                    currentStatusFilter = 'all';
                    if (searchInput) searchInput.value = '';
                    if (categoryFilter) categoryFilter.value = 'all';
                    if (statusFilter) statusFilter.value = 'all';
                    filterProducts();
                });
            }
            
            console.log('‚úÖ Search and filter setup complete');
        }

        function filterProducts() {
            console.log('üîç Filtering products...', {
                totalProducts: allProducts.length,
                searchTerm: currentProductSearch,
                categoryFilter: currentCategoryFilter,
                statusFilter: currentStatusFilter
            });
            
            // Start with all products
            let filtered = [...allProducts];
            
            // Apply search filter
            if (currentProductSearch && currentProductSearch.trim()) {
                const searchTerm = currentProductSearch.toLowerCase().trim();
                const beforeSearch = filtered.length;
                filtered = filtered.filter(product => 
                    (product.name && product.name.toLowerCase().includes(searchTerm)) ||
                    (product.description && product.description.toLowerCase().includes(searchTerm)) ||
                    (product.category && product.category.toLowerCase().includes(searchTerm))
                );
                console.log(`üîç Search filter: ${beforeSearch} ‚Üí ${filtered.length} products`);
            }
            
            // Apply category filter
            if (currentCategoryFilter && currentCategoryFilter !== 'all') {
                const beforeCategory = filtered.length;
                filtered = filtered.filter(product => {
                    const categoryName = Object.keys(categoryMap).find(name => categoryMap[name] === product.category_id);
                    return categoryName === currentCategoryFilter;
                });
                console.log(`üè∑Ô∏è Category filter: ${beforeCategory} ‚Üí ${filtered.length} products`);
            }
            
            // Apply status filter
            if (currentStatusFilter && currentStatusFilter !== 'all') {
                const beforeStatus = filtered.length;
                filtered = filtered.filter(product => {
                    if (currentStatusFilter === 'active') return !product.disabled && product.stock > 0;
                    if (currentStatusFilter === 'disabled') return product.disabled;
                    if (currentStatusFilter === 'out-of-stock') return product.stock === 0;
                    if (currentStatusFilter === 'low-stock') return product.stock > 0 && product.stock <= 5;
                    return true;
                });
                console.log(`üìä Status filter: ${beforeStatus} ‚Üí ${filtered.length} products`);
            }
            
            // Update filtered products
            filteredProducts = filtered;
            console.log(`‚úÖ Final filtered results: ${filteredProducts.length} products`);
            
            // Render the filtered products
            renderFilteredProducts();
        }

        function renderFilteredProducts() {
            // Find the products container within the products-list
            const productsListEl = document.getElementById('products-list');
            if (!productsListEl) {
                console.log('‚ùå Products list element not found');
                return;
            }

            console.log('üîÑ Rendering filtered products:', filteredProducts.length);

            // Find the products container (the div with class "p-6 space-y-4 bg-gray-50")
            let productsContainer = productsListEl.querySelector('.p-6.space-y-4.bg-gray-50');
            
            if (!productsContainer) {
                console.log('‚ùå Products container not found, creating new one');
                // If no products container exists, create one
                productsContainer = document.createElement('div');
                productsContainer.className = 'p-6 space-y-4 bg-gray-50';
                productsListEl.appendChild(productsContainer);
            }

            if (!filteredProducts || filteredProducts.length === 0) {
                const emptyMessage = allProducts.length > 0 ? 
                    'No products match your search criteria.' : 
                    'Get started by adding your first product.';
                productsContainer.innerHTML = `
                    <div class="p-8 text-center">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">No products</h3>
                        <p class="mt-1 text-sm text-gray-500">${emptyMessage}</p>
                    </div>
                `;
                return;
            }

            // Update the product count in the header
            const headerElement = document.querySelector('.text-emerald-100');
            if (headerElement) {
                headerElement.textContent = `${filteredProducts.length} product${filteredProducts.length !== 1 ? 's' : ''} in your inventory`;
            }

            // Render the filtered products
            const productsHTML = `
                ${filteredProducts.map(product => {
                        const p = {
                            ...product,
                            imageURL: product.image_url,
                            categoryId: product.category_id,
                            pharmacyId: product.pharmacy_id
                        };
                        const isOutOfStock = p.stock === 0;
                        const isDisabled = p.disabled;
                        const discountPrice = p.discount > 0 ? (p.price * (1 - p.discount / 100)).toFixed(2) : null;
                        
                        return `
                            <div class="relative bg-white rounded-lg border border-gray-200 p-6 hover:shadow-lg transition-shadow duration-200 ${isDisabled ? 'opacity-60 bg-gray-50 border-gray-300' : ''} ${isOutOfStock ? 'opacity-75' : ''}">
                                <!-- Disabled Overlay Badge -->
                                ${isDisabled ? `
                                    <div class="absolute top-2 right-2 bg-red-500 text-white px-2 py-1 rounded-full text-xs font-medium z-10">
                                        DISABLED
                                    </div>
                                ` : ''}
                                <div class="flex items-start justify-between">
                                    
                                    <!-- Product Image & Info -->
                                    <div class="flex items-start gap-4 flex-1">
                                        <div class="relative">
                                            <img src="${p.imageURL || 'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?q=80&w=100&auto=format&fit=crop'}" 
                                                 class="w-20 h-20 rounded-lg border object-cover ${isDisabled ? 'grayscale' : ''}" />
                                            ${isOutOfStock ? `
                                                <div class="absolute inset-0 bg-red-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                                                    <span class="bg-red-500 text-white text-xs px-2 py-1 rounded-full font-medium">Sold Out</span>
                                                </div>
                                            ` : ''}
                                            ${isDisabled && !isOutOfStock ? `
                                                <div class="absolute inset-0 bg-gray-500 bg-opacity-30 rounded-lg flex items-center justify-center">
                                                    <span class="bg-gray-600 text-white text-xs px-2 py-1 rounded-full font-medium">Disabled</span>
                                                </div>
                                            ` : ''}
                                        </div>
                                        
                                        <div class="flex-1">
                                            <div class="flex items-start justify-between mb-2">
                                                <div>
                                                    <h4 class="text-lg font-semibold text-gray-900 mb-1">${p.name}</h4>
                                                    <p class="text-sm text-gray-600">${Object.keys(categoryMap).find(name => categoryMap[name] === p.category_id) || 'Uncategorized'}</p>
                                                </div>
                                                
                                                <!-- Status Badges -->
                                                <div class="flex flex-wrap gap-1">
                                                    ${p.featured ? '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Featured</span>' : ''}
                                                    ${p.prescription ? '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Prescription</span>' : ''}
                                                </div>
                                            </div>
                                            
                                            ${p.description ? `<p class="text-sm text-gray-600 mb-3 line-clamp-2">${p.description}</p>` : ''}
                                            
                                            <!-- Pricing & Stock -->
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center gap-3">
                                                    ${discountPrice ? `
                                                        <div class="flex items-center gap-2">
                                                            <span class="text-xl font-bold text-emerald-600">‚Ç±${discountPrice}</span>
                                                            <span class="text-sm text-gray-500 line-through">‚Ç±${p.price.toFixed(2)}</span>
                                                            <span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full font-medium">${p.discount}% OFF</span>
                                                        </div>
                                                    ` : `
                                                        <span class="text-xl font-bold text-emerald-600">‚Ç±${p.price.toFixed(2)}</span>
                                                    `}
                                                </div>
                                                
                                                <div class="flex items-center gap-4">
                                                    <div class="text-right">
                                                        <div class="text-sm text-gray-500">Stock</div>
                                                        <div class="text-lg font-semibold ${isOutOfStock ? 'text-red-600' : 'text-gray-900'}">${p.stock}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Action Buttons -->
                                    <div class="flex flex-col gap-2 ml-4">
                                        <button onclick="editProduct('${p.id}')" class="flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg text-sm font-medium hover:bg-blue-600 transition-colors">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                            </svg>
                                            Edit
                                        </button>
                                        <button onclick="toggleProductStatus('${p.id}', ${p.disabled})" class="flex items-center gap-2 px-4 py-2 ${p.disabled ? 'bg-green-500 hover:bg-green-600' : 'bg-orange-500 hover:bg-orange-600'} text-white rounded-lg text-sm font-medium transition-colors">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                ${p.disabled ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>' : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>'}
                                            </svg>
                                            ${p.disabled ? 'Enable' : 'Disable'}
                                        </button>
                                        <button onclick="deleteProduct('${p.id}')" class="flex items-center gap-2 px-4 py-2 bg-red-500 text-white rounded-lg text-sm font-medium hover:bg-red-600 transition-colors">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
            `;
            
            productsContainer.innerHTML = productsHTML;
        }
        
        // Setup search and filter event listeners
        function setupSearchAndFilterAfterProductsLoad() {
            // Try to setup immediately, if elements don't exist, retry
            const searchInput = document.getElementById('product-search-input');
            if (!searchInput) {
                console.log('üîÑ Search elements not ready, retrying in 500ms...');
                setTimeout(setupSearchAndFilterAfterProductsLoad, 500);
                return;
            }
            
            console.log('‚úÖ Search elements found, setting up...');
            setupProductSearchAndFilter();
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Setup search and filter after products are loaded
            setTimeout(setupSearchAndFilterAfterProductsLoad, 1000);
        });

        // Utility function to get payment method display name
        function getPaymentMethodDisplay(paymentMethod) {
            if (!paymentMethod) return null;
            
            switch (paymentMethod.toLowerCase()) {
                case 'gcash':
                    return 'GCash';
                case 'paymaya':
                    return 'PayMaya';
                case 'bank_transfer':
                    return 'Bank Transfer';
                case 'card':
                    return 'Bank Transfer';
                default:
                    return paymentMethod.toUpperCase();
            }
        }

        // Periodic check for disabled accounts (every 30 seconds) - only run once
        setInterval(async () => {
            const { data: { user: currentUser } } = await supabase.auth.getUser();
            if (currentUser) {
                console.log('üîÑ Periodic check: Checking account status for', currentUser.email);
                await checkAccountStatus(currentUser);
            }
        }, 30000); // Check every 30 seconds
    </script>
</body>

</html>
